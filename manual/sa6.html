<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>DM4 &#167;A6: Answers to all the exercises</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" type="text/css" href="dm4.css">
</head>
<body>
<p class="navbar">
 <a href="index.html">home</a> /
 <a href="contents.html">contents</a> /
 <a href="app.html">appendices</a> /
 <a href="sa5.html" title="&#167;A5: Entry point routines">prev</a> /
 <a href="tables.html" title="Tables">next</a> /
 <a href="dm4index.html">index</a>
</p>
<div class="page">

<h2>&#167;A6 &nbsp; Answers to all the exercises</h2>

<blockquote>World is crazier and more of it than we think,<br>
Incorrigibly plural. I peel and portion<br>
A tangerine and spit the pips and feel<br>
The drunkenness of things being various.<br>
&#8212; Louis MacNeice (1907&#8211;1963), <i>Snow</i></blockquote>

<h3>Exercises in Chapter II</h3>

<div class="ans"><a id="ans1" name="ans1"></a>
<ul><li>1 (p. <a href="s4.html#ex1">80</a>) &nbsp;
Here's one way: attach a property to the mushroom which records whether
or not it has been picked.</li></ul>

<p class="lynxonly"></p>
<pre class="code">
mushroom_picked,
after [;
    Take: if (self.mushroom_picked)
              &quot;You pick up the slowly-disintegrating mushroom.&quot;;
          self.mushroom_picked = true;
          &quot;You pick the mushroom, neatly cleaving its thin stalk.&quot;;
    Drop: &quot;The mushroom drops to the ground, battered slightly.&quot;;
],
</pre>

<p class="normal">Note that the mushroom is allowed to call itself 
<code>self</code> instead of <code>mushroom</code>, though it doesn't 
have to.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans2" name="ans2"></a>
<ul><li>2 (p. <a href="s4.html#ex2">81</a>) &nbsp;
Here is one possibility. Don't forget the <code>light</code>, or the 
player will find only darkness at the foot of the steps and won't ever 
be able to read the description.</li></ul>

<p class="lynxonly"></p>
<pre>
Object Square_Chamber &quot;Square Chamber&quot;
  with description
           &quot;A sunken, gloomy stone chamber, ten yards across. A shaft
           of sunlight cuts in from the steps above, giving the chamber
           a diffuse light, but in the shadows low lintelled doorways
           lead east and south into the deeper darkness of the
           Temple.&quot;,
  has  light;
</pre>

<p class="normal">The map connections east, south and back up will be 
added in <a href="s9.html">&#167;9</a>.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans3" name="ans3"></a>
<ul><li>3 (p. <a href="s6.html#ex3">90</a>) &nbsp;
The neatest way is to make the door react to movement through it:</li></ul>

<p class="lynxonly"></p>
<pre>
Class ObligingDoor
 with name 'door',
      react_before [;
          Go: if (noun.door_dir == self.door_dir)
                  return self.open_by_myself();
          Enter: if (noun == self) return self.open_by_myself();
      ],
      open_by_myself [ ks;
          if (self has open) rfalse;
          print &quot;(first opening &quot;, (the) self, &quot;)^&quot;;
          ks = keep_silent; keep_silent = true;
          &lt;Open self&gt;; keep_silent = ks;
          if (self hasnt open) rtrue;
      ],
  has door openable lockable static;
</pre>

<p class="normal">Here <code>react_before</code> picks up any action 
in the same location as the door, whether or not it directly involves 
the door. So if the door is the east connection out of this location, it 
reacts to the action <code>Go e_obj</code> action (because <code>e_obj.door_dir</code> 
is <code>e_to</code>, which is the door's <code>door_dir</code> as well). 
Another point to notice is that it reacts to <code>Enter</code> as well. 
Normally, if the player types &#8220;go through oaken door&#8221;, then 
the action <code>Enter oaken_door</code> is generated, and the library 
checks that the door is open before generating <code>Go e_obj</code>. 
Here, of course, the whole point is that the door is closed, so we have 
to intercept the <code>Enter</code> action as early as possible. (A 
caveat: if <code>door_dir</code> values are to be routines, the above 
needs to be complicated slightly to call these routines and compare the 
return values.)</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans4" name="ans4"></a>
<ul><li>4 (p. <a href="s6.html#ex4">90</a>) &nbsp;
The following assumes that all the keys in the game belong to a class 
called <code>Key</code>, and that there are no more than 16 of them. 
This allows the set of keys tried so far to be stored (as a bit vector) 
in a 16-bit Inform integer, and as games with many keys and many doors 
are exceptionally irritating, the limit is a blessing in disguise. Add 
the following to the <code>ObligingDoor</code> class:</li></ul>

<p class="lynxonly"></p>
<pre>
has_been_unlocked,
which_keys_tried,
before [ key_to_try j bit ks;
    Open:
        if (self has locked) {
            if (self.has_been_unlocked) {
                key_to_try = self.with_key;
                if (key_to_try notin player)
                    &quot;You have mislaid &quot;, (the) key_to_try,
                    &quot; and so cannot unlock &quot;, (the) self, &quot;.&quot;;
                print &quot;(first unlocking &quot;;
            }
            else {
                bit=1;
                objectloop (j ofclass Key)
                {   if (self.which_keys_tried &amp; bit == 0
                        &amp;&amp; j in player) key_to_try = j;
                    bit = bit*2;
                }
                if (key_to_try == nothing) rfalse;
                print &quot;(first trying to unlock &quot;;
            }
            print (the) self, &quot; with &quot;, (the) key_to_try, &quot;)^&quot;;
            ks = keep_silent; keep_silent = true;
            &lt;Unlock self key_to_try&gt;; keep_silent = ks;
            if (self has locked) rtrue;
        }
    Lock: if (self has open) {
            print &quot;(first closing &quot;, (the) self, &quot;)^&quot;;
            ks = keep_silent; keep_silent = true;
            &lt;Close self&gt;; keep_silent = ks;
            if (self has open) rtrue;
        }
    Unlock:
        bit=1;
        objectloop (j ofclass Key) {
            if (second == j)
                self.which_keys_tried = self.which_keys_tried + bit;
            bit = bit*2;
        }
],
after [;
    Unlock: self.has_been_unlocked = true;
],
</pre>
</div>

<div class="ans"><a id="ans5" name="ans5"></a>
<ul><li>5 (p. <a href="s6.html#ex5">91</a>) &nbsp;
Briefly: provide a <code>GamePreRoutine</code> which tests to see if 
<code>second</code> is an object, rather than <code>nothing</code> or 
a number. If it is, check whether the object has a <code>second_before</code> 
rule (i.e. test the condition <code>(object provides second_before)</code>). 
If it has, send the <code>second_before</code> message to it, and return 
the reply as the return value from <code>GamePreRoutine</code>. 
If <code>second</code> isn't an object, be sure to explicitly return 
<code>false</code> from <code>GamePreRoutine</code>, or you might 
inadvertently run into the <code>]</code> at the end, have <code>true</code>
returned and find lots of actions mysteriously stopped.</li></ul>
</div>

<h3>Exercises in Chapter III</h3>

<div class="ans"><a id="ans6" name="ans6"></a>
<ul><li>6 (p. <a href="s8.html#ex6">109</a>) &nbsp;
At the key moment, <code>move orange_cloud to location</code>, where 
the orange cloud is defined as follows:</li></ul>

<p class="lynxonly"></p>
<pre>
Object orange_cloud &quot;orange cloud&quot;
  with name 'orange' 'cloud',
       react_before [;
           Look: &quot;You can't see for the orange cloud surrounding you.&quot;;
           Go, Exit: &quot;You wander round in circles, choking.&quot;;
           Smell: if (noun == nothing or self) &quot;Cinnamon? No, nutmeg.&quot;;
       ],
  has  scenery;
</pre>
</div>

<div class="ans"><a id="ans7" name="ans7"></a>
<ul><li>7 (p. <a href="s8.html#ex7">110</a>) &nbsp;
It's essential here to return <code>true</code>, to prevent the library 
from saying &#8220;Dropped.&#8221; as it otherwise would. Fortunately 
<code>print_ret</code> causes a return value of <code>true</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
after [;
    Drop: move noun to Square_Chamber;
        print_ret (The) noun, &quot; slips through one of the burrows
            and is quickly lost from sight.&quot;;
],
</pre>

<p class="normal">(The rest of the Wormcast's definition is left 
until <a href="s9.html">&#167;9</a> below.) This is fine for &#8216;Ruins&#8217;,
but in a more complicated game it's possible that other events besides 
a <code>Drop</code> might move items to the floor. If so, the Wormcast 
could be given an <code>each_turn</code> (see <a href="s20.html">&#167;20</a>) 
to watch for items on the floor and slip them into the burrows.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans8" name="ans8"></a>
<ul><li>8 (p. <a href="s9.html#ex8">113</a>) &nbsp;
The Wormcast has one orthodox exit (west) and three confused ones:</li></ul>

<p class="lynxonly"></p>
<pre>
Object Wormcast &quot;Wormcast&quot;
  with description
           &quot;A disturbed place of hollows carved like a spider's web,
           strands of empty space hanging in stone. The only burrows
           wide enough to crawl through begin by running northeast,
           south and upwards.&quot;,
       w_to Square_Chamber,
       ne_to [; return self.s_to(); ],
       u_to [; return self.s_to(); ],
       s_to [;
           print &quot;The wormcast becomes slippery around you, as though
               your body-heat is melting long hardened resins, and
               you shut your eyes tightly as you burrow through
               darkness.^&quot;;
           if (eggsac in player) return Square_Chamber;
           return random(Square_Chamber, Corridor, Forest);
       ],
       cant_go &quot;Though you feel certain that something lies behind
           the wormcast, this way is impossible.&quot;,
  has  light;
</pre>

<p class="normal">This is a tease, as it stands, and is in need of 
a solution to the puzzle and a reward for solving it.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans9" name="ans9"></a>
<ul><li>9 (p. <a href="s9.html#ex9">113</a>) &nbsp;
Define four objects along the lines of:</li></ul>

<p class="lynxonly"></p>
<pre>
CompassDirection white_obj &quot;white wall&quot; compass
  with name 'white' 'sac' 'wall', door_dir n_to;
</pre>

<p class="normal">This means there are now sixteen direction objects, 
some of which refer to the same actual direction: the player can type 
&#8220;white&#8221; or &#8220;north&#8221; with the same effect. 
If you would like to take away the player's ability to use the ordinary 
English nouns, add the following line to <code>Initialise</code>:</p>

<p class="lynxonly"></p>
<pre>remove n_obj; remove e_obj; remove w_obj; remove s_obj;</pre>

<p class="normal">(&#8216;Curses&#8217; does a similar trick when the 
player boards a ship, taking away the normal directions in favour of 
&#8220;port&#8221;, &#8220;starboard&#8221;, &#8220;fore&#8221; and 
&#8220;aft&#8221;.) As a fine point of style, turquoise (<i>yax</i>) 
is the world colour for &#8216;here&#8217;, so add a grammar line 
to make this cause a &#8220;look&#8221;:</p>

<p class="lynxonly"></p>
<pre>Verb 'turquoise' 'yax' * -&gt; Look;</pre>
</div>

<div class="ans"><a id="ans10" name="ans10"></a>
<ul><li>10 (p. <a href="s9.html#ex10">114</a>) &nbsp;
This time it's not enough to define a new way of saying an old direction:
&#8220;xyzzy&#8221; is an entirely new direction. It needs a direction 
property, say <code>xyzzy_to</code>, and this property needs to be 
declared as a &#8220;common property&#8221;, partly for efficiency reasons, 
partly because that's just how the library works. (Common properties 
are those declared in advance of use with <code>Property</code>. 
See <a href="s3">&#167;3</a> for further details.) So:</li></ul>

<p class="lynxonly"></p>
<pre>
Property xyzzy_to;
CompassDirection xyzzy_obj &quot;magic word&quot; compass
  with name 'xyzzy', door_dir xyzzy_to;
</pre>
</div>

<div class="ans"><a id="ans11" name="ans11"></a>
<ul><li>11 (p. <a href="s9.html#ex11">114</a>) &nbsp;
We exchange the east and west direction references:</li></ul>

<p class="lynxonly"></p>
<pre>
[ SwapDirs o1 o2 x;
  x = o1.door_dir; o1.door_dir = o2.door_dir; o2.door_dir = x;
];
[ ReflectWorld;
  SwapDirs(e_obj, w_obj);
  SwapDirs(ne_obj, nw_obj);
  SwapDirs(se_obj, sw_obj);
];
</pre>
</div>

<div class="ans"><a id="ans12" name="ans12"></a>
<ul><li>12 (p. <a href="s9.html#ex12">114</a>) &nbsp;
This is a prime candidate for using variable strings (see &#167;1.11):</li></ul>

<p class="lynxonly"></p>
<pre>
[ NormalWorld; string 0 &quot;east&quot;; string 1 &quot;west&quot;; ];
[ ReversedWorld; string 0 &quot;west&quot;; string 1 &quot;east&quot;; ];
</pre>

<p class="normal">where <code>NormalWorld</code> is called in 
<code>Initialise</code> and <code>ReversedWorld</code> when the reflection
happens. Write <code>@00</code> in place of &#8220;east&#8221; in any 
double-quoted printable string, and similarly <code>@01</code> for 
&#8220;west&#8221;. It will be printed as whichever is currently set.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans13" name="ans13"></a>
<ul><li>13 (p. <a href="s9.html#ex13">114</a>) &nbsp;
Make all the location objects members of a class called:</li></ul>

<p class="lynxonly"></p>
<pre>
Class Room
  with n_to, e_to, w_to, s_to, ne_to, nw_to, se_to, sw_to,
       in_to, out_to, u_to, d_to;
</pre>

<p class="normal">These properties are needed to make sure we can always 
write any map connection value to any room. Now define a routine which 
works on two opposite direction properties at a time:</p>

<p class="lynxonly"></p>
<pre>
[ TwoWay x dp1 dp2 y;
  y = x.dp1; if (metaclass(y) == Object &amp;&amp; y ofclass Room) y.dp2 = x;
  y = x.dp2; if (metaclass(y) == Object &amp;&amp; y ofclass Room) y.dp1 = x;
];
</pre>

<p class="normal">Note that some map connections run to doors (see 
<a href="s13.html">&#167;13</a>) and not locations, and any such 
map connections need special handling which this solution can't provide: 
so we check that <code>y ofclass Room</code> before setting any direction 
properties for it. The actual code to go into <code>Initialise</code> 
is now simple:</p>

<p class="lynxonly"></p>
<pre>
objectloop (x ofclass Room) {
    TwoWay(x, n_to, s_to);   TwoWay(x, e_to, w_to);
    TwoWay(x, ne_to, sw_to); TwoWay(x, nw_to, se_to);
    TwoWay(x, u_to, d_to);   TwoWay(x, in_to, out_to);
}
</pre>
</div>

<div class="ans"><a id="ans14" name="ans14"></a>
<ul><li>14 (p. <a href="s11.html#ex14">117</a>) &nbsp;
The following code only works because <code>react_before</code> happens 
in advance of <code>before</code>. It uses <code>react_before</code> 
(rather than <code>each_turn</code>, say, or a daemon) to see if the 
gloves can be joined, in order to get in ahead of any <code>Look</code>, 
<code>Search</code> or <code>Inv</code> action which might want to 
talk about the gloves; whereas the <code>before</code> routine applies only 
if the player specifically refers to one of the gloves by name:</li></ul>

<p class="lynxonly"></p>
<pre>
Class Glove
  with name 'white' 'glove' 'silk',
       article &quot;the&quot;,
       react_before [;
           if (self in gloves) rfalse;
           if (parent(right_glove) ~= parent(left_glove)) rfalse;
           if (left_glove has worn &amp;&amp; right_glove hasnt worn) rfalse;
           if (left_glove hasnt worn &amp;&amp; right_glove has worn) rfalse;
           if (left_glove has worn) give gloves worn;
           else give gloves ~worn;
           move gloves to parent(right_glove);
           move right_glove to gloves; move left_glove to gloves;
           give right_glove ~worn; give left_glove ~worn;
       ],
       before [;
           if (self notin gloves) rfalse;
           move left_glove to parent(gloves);
           move right_glove to parent(gloves);
           if (gloves has worn) {
               give left_glove worn; give right_glove worn;
           }
           remove gloves;
       ],
  has  clothing;
Object -&gt; gloves &quot;white gloves&quot;
  with name 'white' 'gloves' 'pair' 'of',
       article &quot;a pair of&quot;,
  has  clothing transparent;
Glove -&gt; -&gt; left_glove &quot;left glove&quot;
  with description &quot;White silk, monogrammed with a scarlet R.&quot;,
       name 'left';
Glove -&gt; -&gt; right_glove &quot;right glove&quot;
  with description &quot;White silk, monogrammed with a scarlet T.&quot;,
       name 'right';
</pre>
</div>

<div class="ans"><a id="ans15" name="ans15"></a>
<ul><li>15 (p. <a href="s12.html#ex15">119</a>) &nbsp;
&#8220;That was an unaccompanied bass pedal solo by Michael Rutherford&#8230;
this is <i>The Musical Box</i>.&#8221; (Announcement following tuning-up 
in a Genesis concert, Peter Gabriel, February 1973.) The easy thing to 
forget here is to make the container <code>openable</code>, because all 
the keys in the world won't help the player if the box hasn't got that.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; &quot;musical box&quot;,
  with name 'musical' 'box',
       with_key silver_key,
       capacity 1,
  has  lockable locked openable container;
Object -&gt; -&gt; &quot;score of a song&quot; 
  with name 'score' 'music' 'song',
       article &quot;the&quot;,
       description &quot;~The Return of Giant Hogweed~.&quot;;
Object -&gt; silver_key &quot;silver key&quot;
  with name 'silver' 'key';
</pre>
</div>

<div class="ans"><a id="ans16" name="ans16"></a>
<ul><li>16 (p. <a href="s12.html#ex16">120</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; bag &quot;toothed bag&quot;
  with name 'toothed' 'bag',
       description &quot;A capacious bag with a toothed mouth.&quot;,
       before [;
           LetGo: &quot;The bag defiantly bites itself
                  shut on your hand until you desist.&quot;;
           Close: &quot;The bag resists all attempts to close it.&quot;;
       ],
       after [;
           Receive:
               &quot;The bag wriggles hideously as it swallows &quot;,
               (the) noun, &quot;.&quot;;
       ],
  has  container open openable;
</pre>
</div>

<div class="ans"><a id="ans17" name="ans17"></a>
<ul><li>17 (p. <a href="s12.html#ex17">121</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; glass_box &quot;glass box with a lid&quot;
  with name 'glass' 'box' 'with' 'lid'
  has  container transparent openable open;
Object -&gt; steel_box &quot;steel box with a lid&quot;
  with name 'steel' 'box' 'with' 'lid'
  has  container openable open;
</pre>
</div>

<div class="ans"><a id="ans18" name="ans18"></a>
<ul><li>18 (p. <a href="s12.html#ex18">121</a>) &nbsp;
See <a href="s14.html">&#167;14</a> for <code>switchable</code>, 
used below to make the power button actually do something.</li></ul>

<p class="lynxonly"></p>
<pre>
Object television &quot;portable television set&quot;
  with name 'tv' 'television' 'set' 'portable',
       before [;
           SwitchOn: &lt;&lt;SwitchOn power_button&gt;&gt;;
           SwitchOff: &lt;&lt;SwitchOff power_button&gt;&gt;;
           Examine: &lt;&lt;Examine screen&gt;&gt;;
       ],
  has  transparent;
Object -&gt; power_button &quot;power button&quot;
  with name 'power' 'button' 'switch',
       after [;
           SwitchOn, SwitchOff: &lt;&lt;Examine screen&gt;&gt;;
       ],
  has  switchable;
Object -&gt; screen &quot;television screen&quot;
  with name 'screen',
       before [;
           Examine: if (power_button hasnt on) &quot;The screen is black.&quot;;
               &quot;The screen writhes with a strange Japanese cartoon.&quot;;
       ];
</pre>
</div>

<div class="ans"><a id="ans19" name="ans19"></a>
<ul><li>19 (p. <a href="s12.html#ex19">121</a>) &nbsp;
The <code>describe</code> part of this answer is only decoration. 
Note the careful use of <code>inp1</code> and <code>inp2</code> rather 
than <code>noun</code> or <code>second</code>, just in case an action 
involves a number or some text instead of an object. (See the note 
at the end of <a href="s6.html">&#167;6</a>.)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; macrame_bag &quot;macrame bag&quot;
  with name 'macrame' 'bag' 'string' 'net' 'sack',
       react_before [;
           Examine, Search, Listen, Smell: ;
           default:
               if (inp1 &gt; 1 &amp;&amp; noun in self)
                   print_ret (The) noun, &quot; is inside the bag.&quot;;
               if (inp2 &gt; 1 &amp;&amp; second in self)
                   print_ret (The) second, &quot; is inside the bag.&quot;;
       ],
       before [;
           Open: &quot;The woollen twine is knotted hopelessly tight.&quot;;
       ],
       describe [;
           print &quot;^A macrame bag hangs from the ceiling, shut tight&quot;;
           if (child(self)) {
               print &quot;. Inside you can make out &quot;;
               WriteListFrom(child(self), ENGLISH_BIT);
           }
           &quot;.&quot;;
       ],
  has  container transparent openable;
Object -&gt; -&gt; &quot;gold watch&quot;
  with name 'gold' 'watch',
       description &quot;The watch has no hands, oddly.&quot;,
       react_before [;
           Listen:
               if (noun == nothing or self) &quot;The watch ticks loudly.&quot;;
       ];
</pre>

<p class="normal">For <code>WriteListFrom</code>, see 
<a href="s27.html">&#167;27</a>.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans20" name="ans20"></a>
<ul><li>20 (p. <a href="s13.html#ex20">124</a>) &nbsp;
The &#8220;plank breaking&#8221; rule is implemented here in its <code>door_to</code> 
routine. Note that this returns <code>true</code> after killing the 
player.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; PlankBridge &quot;plank bridge&quot;
  with description &quot;Extremely fragile and precarious.&quot;,
       name 'precarious' 'fragile' 'wooden' 'plank' 'bridge',
       when_open &quot;A precarious plank bridge spans the chasm.&quot;,
       door_to [;
           if (children(player) &gt; 0) {
               deadflag = true;
               &quot;You step gingerly across the plank, which bows under
               your weight. But your meagre possessions are the straw
               which breaks the camel's back!&quot;;
           }
           print &quot;You step gingerly across the plank, grateful that
               you're not burdened.^&quot;;
           if (self in NearSide) return FarSide; return NearSide;
       ],
       door_dir [;
           if (self in NearSide) return s_to; return n_to;
       ],
       found_in NearSide FarSide,
  has  static door open;
</pre>

<p class="normal">There might be a problem with this solution if your 
game also contained a character who wandered about, and whose code 
was clever enough to run <code>door_to</code> routines for any doors 
it ran into. If so, <code>door_to</code> could perhaps be modified 
to check that the <code>actor</code> is the <code>player</code>.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans21" name="ans21"></a>
<ul><li>21 (p. <a href="s13.html#ex21">124</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; illusory_door &quot;ironbound door&quot;,
  with name 'iron' 'ironbound' 'door',
       door_dir e_to, door_to Armoury,
       before [;
           Enter: return self.vanish();
       ],
       react_before [;
           Go: if (noun == e_obj) return self.vanish();
       ],
       vanish [;
           location.(self.door_dir) = self.door_to; remove self;
           print &quot;The door vanishes, shown for the illusion it is!^&quot;;
           &lt;&lt;Go e_obj&gt;&gt;;
       ],
  has  locked lockable door openable;
</pre>

<p class="normal">We need to trap both the <code>Go e_obj</code> <em>and</em> 
<code>Enter illusory_door</code> actions and can't just wait for the 
latter to be converted into the former, because the door's <code>locked</code>, 
so it never gets as far as that.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans22" name="ans22"></a>
<ul><li>22 (p. <a href="s15.html#ex22">128</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; cage &quot;iron cage&quot;
  with name 'iron' 'cage' 'bars' 'barred' 'iron-barred',
       when_open
           &quot;An iron-barred cage, large enough to stoop over inside,
           looms ominously here.&quot;,
       when_closed &quot;The iron cage is closed.&quot;,
       inside_description &quot;You stare out through the bars.&quot;,
  has  enterable container openable open transparent static;
</pre>
</div>

<div class="ans"><a id="ans23" name="ans23"></a>
<ul><li>23 (p. <a href="s15.html#ex23">129</a>) &nbsp;
First define a class <code>Road</code>:</li></ul>

<p class="lynxonly"></p>
<pre>Class Road has light;</pre>

<p class="normal">Every road-like location should belong to this class, 
so for instance:</p>

<p class="lynxonly"></p>
<pre>
Road Trafalgar_Square &quot;Trafalgar Square&quot;
  with n_to National_Gallery, e_to Strand,
       w_to Pall_Mall, s_to Whitehall,
       description &quot;The Square is overlooked by a pillared statue
           of Admiral Lord Horatio Nelson (no relation), naval hero
           and convenience to pigeons since 1812.&quot;;
</pre>

<p class="normal">Now change the car's <code>before</code> as follows:</p>

<p class="lynxonly"></p>
<pre>
       before [ way;
           Go: way = location.(noun.door_dir)();
               if (~~(way ofclass Road)) {
                   print &quot;You can't drive the car off-road.^&quot;;
                   return 2;
               }
               if (car has on) &quot;Brmm! Brmm!&quot;;
               print &quot;(The ignition is off at the moment.)^&quot;;
       ],
</pre>

<p class="normal">The first line of the <code>Go</code> clause works 
out what the game's map places in the given direction. For instance, 
<code>noun</code> is <code>e_obj</code>, so that its direction property 
is held in <code>noun.door_dir</code>, whose value is <code>e_to</code>. 
Sending <code>Trafalgar_Square.e_to()</code>, we finally set <code>way</code> 
to <code>Strand</code>. This turns out to be of class <code>Road</code>, 
so the movement is permitted. As complicated as this seems, getting 
a car across the real Trafalgar Square is substantially more convoluted.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans24" name="ans24"></a>
<ul><li>24 (p. <a href="s15.html#ex24">130</a>) &nbsp;
We can't push up or down, but the ball lives on a north to south slope,
so we'll just convert pushing up into pushing north, and down into 
south. Inserting these lines into the <code>before</code> rule for 
<code>PushDir</code> does the trick:</li></ul>

<p class="lynxonly"></p>
<pre>
if (second == u_obj) &lt;&lt;PushDir self n_obj&gt;&gt;;
if (second == d_obj) &lt;&lt;PushDir self s_obj&gt;&gt;;
</pre>
</div>

<div class="ans"><a id="ans25" name="ans25"></a>
<ul><li>25 (p. <a href="s16.html#ex25">132</a>) &nbsp;
The following involves more parsing expertise than is strictly needed,
partly because it's a good opportunity to show off a routine called 
<code>ParseToken</code>. First we define:</li></ul>

<p class="lynxonly"></p>
<pre>
Class Biblical with name 'book' 'of';
Class Gospel class Biblical with name 'gospel' 'saint' 'st';
Gospel &quot;Gospel of St Matthew&quot; with name 'matthew', chapters 28;
Gospel &quot;Gospel of St Mark&quot; with name 'mark', chapters 16;
Gospel &quot;Gospel of St Luke&quot; with name 'luke', chapters 24;
Gospel &quot;Gospel of St John&quot; with name 'john', chapters 21;
...
Biblical &quot;Book of Revelation&quot; with name 'revelation', chapters 22;
</pre>

<p class="normal">And here is the Bible itself:</p>

<p class="lynxonly"></p>
<pre>
Object -&gt; &quot;black Tyndale Bible&quot;
  with name 'bible' 'black' 'book',
       initial &quot;A black Bible rests on a spread-eagle lectern.&quot;,
       description &quot;A splendid foot-high Bible, which must have
           survived the burnings of 1520.&quot;,
       before [ bk ch_num;
           Consult:
               do {
                   wn = consult_from;
                   bk = ParseToken(SCOPE_TT, BiblicalScope);
               } until (bk ~= GPR_REPARSE);
               if (bk == GPR_FAIL) &quot;That's not a book in this Bible.&quot;;
               if (NextWord() ~= 'chapter') wn--;
               ch_num = TryNumber(wn);
               if (ch_num == -1000)
                   &quot;You read &quot;, (the) bk, &quot; right through.&quot;;
               if (ch_num &gt; bk.chapters) &quot;There are only &quot;, &#8224;
                   (number) bk.chapters,&quot; chapters in &quot;,(the) bk,&quot;.&quot;;
               &quot;Chapter &quot;, (number) ch_num, &quot; of &quot;, (the) bk,
                   &quot; is too sacred for you to understand now.&quot;;
       ];
</pre>

<p class="normal">The first six lines under <code>Consult</code> look 
at what the player typed from word <code>consult_from</code> onwards, 
and set <code>bk</code> to be the Book which best matches. The call to 
<code>ParseToken</code> makes the parser behave as if matching 
<span class="grammartoken"><code>scope=BiblicalScope</code></span>, 
which means that we need to define a scope routine:</p>

<p class="lynxonly"></p>
<pre>
[ BiblicalScope bk;
  switch (scope_stage) {
      1: rfalse;
      2: objectloop (bk ofclass Biblical) PlaceInScope(bk); rtrue;
  }
];
</pre>

<p class="normal">See <a href="s32.html">&#167;32</a> for more, but this 
tells the parser to accept only the name of a single, specific object 
of class <code>Biblical</code>. The effect of all of this fuss is to 
allow the following dialogue:</p>

<p class="output">&gt;<tt>look up gospel in bible</tt><br>
Which do you mean, the Gospel of St Matthew, the Gospel of St Mark, 
the Gospel of St Luke or the Gospel of St John?<br>
&gt;<tt>mark</tt><br>
You read the Gospel of St Mark right through.<br>
&gt;<tt>look up St John chapter 17 in bible</tt><br>
Chapter seventeen of the Gospel of St John is too sacred for you to 
understand now.</p>

<p class="normal">For a simpler solution, <code>Consult</code> could 
instead begin like this:</p>

<p class="lynxonly"></p>
<pre>
wn = consult_from;
switch (NextWord()) {
    'matthew': bk = St_Matthew;
    'mark': bk = St_Mark;
    ...
    default: &quot;That's not a book in this Bible.&quot;;
}
</pre>

<hr class="footnotebar">
<p class="aside" style="margin-top:0">&#8224;&nbsp; Actually, Philemon, II. John, III. John 
and Jude have only one chapter apiece, so we ought to take more care 
over grammar here.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans26" name="ans26"></a>
<ul><li>26 (p. <a href="s17.html#ex26">137</a>) &nbsp;
Note that whether reacting before or after, the psychiatrist does not 
cut any actions short, because his <code>react_before</code> and 
<code>react_after</code> both return <code>false</code>.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; psychiatrist &quot;bearded psychiatrist&quot;
  with name 'bearded' 'doctor' 'psychiatrist' 'psychologist' 'shrink',
       initial &quot;A bearded psychiatrist has you under observation.&quot;,
       life [;
           &quot;He is fascinated by your behaviour, but makes no attempt
           to interfere with it.&quot;;
       ],
       react_after [;
           Insert: print &quot;~Subject associates &quot;, (name) noun, &quot; with &quot;,
               (name) second, &quot;. Interesting.~^^&quot;;
           PutOn: print &quot;~Subject puts &quot;, (name) noun, &quot; on &quot;,
               (name) second, &quot;. Interesting.~^^&quot;;
           Look: print &quot;^~Pretend I'm not here.~^^&quot;;
       ],
       react_before [;
           Take, Remove: print &quot;~Subject feels lack of &quot;, (the) noun,
               &quot;. Suppressed Oedipal complex? Hmm.~^^&quot;;
       ],
  has  animate;
</pre>
</div>

<div class="ans"><a id="ans27" name="ans27"></a>
<ul><li>27 (p. <a href="s18.html#ex27">139</a>) &nbsp;
There are several ways to do this. The easiest is to add more grammar
to the parser and let it do the hard work:</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; computer &quot;computer&quot;
  with name 'computer',
       theta_setting,
       orders [;
           Theta: if (noun &lt; 0 || noun &gt;= 360)
                   &quot;~That value of theta is out of range.~&quot;;
               self.theta_setting = noun;
               &quot;~Theta set. Waiting for additional values.~&quot;;
           default: &quot;~Please rephrase.~&quot;;
       ],
  has  talkable;
...
[ ThetaSub; &quot;You must tell your computer so.&quot;; ];
Verb 'theta' * 'is' number -&gt; Theta;
</pre>
</div>

<div class="ans"><a id="ans28" name="ans28"></a>
<ul><li>28 (p. <a href="s18.html#ex28">139</a>) &nbsp;
Add the following lines, after the inclusion of <code>Grammar</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
[ SayInsteadSub; &quot;[To talk to someone, please type ~someone, something~
   or else ~ask someone about something~.]&quot;; ];
Extend 'answer' replace * topic -&gt; SayInstead;
Extend 'tell'   replace * topic -&gt; SayInstead;
</pre>

<p class="normal">A slight snag is that this will throw out &#8220;nigel, 
tell me about the grunfeld defence&#8221; (which the library will normally 
convert to an <code>Ask</code> action, but can't if the grammar for 
&#8220;tell&#8221; is missing). To avoid this, you could instead of 
making the above directives <code>Replace</code> the <code>TellSub</code> 
routine (see <a href="s25.html">&#167;25</a>) by the 
<code>SayInsteadSub</code> one.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans29" name="ans29"></a>
<ul><li>29 (p. <a href="s18.html#ex29">140</a>) &nbsp;
Obviously, a slightly wider repertoire of actions might be a good 
idea, but:</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; Charlotte &quot;Charlotte&quot;
  with name 'charlotte' 'charlie' 'chas',
       simon_said,
       grammar [;
           self.simon_said = false;
           wn = verb_wordnum;
           if (NextWord() == 'simon' &amp;&amp; NextWord() == 'says') {
               if (wn &gt; num_words) print &quot;Simon says nothing, so &quot;;
               else {
                   self.simon_said = true;
                   verb_wordnum = wn;
               }
           }
       ],
       orders [ i;
           if (self.simon_said == false)
               &quot;Charlotte sticks her tongue out.&quot;;
           WaveHands: &quot;Charlotte waves energetically.&quot;;
           default: &quot;~Don't know how,~ says Charlotte.&quot;;
       ],
       initial &quot;Charlotte wants to play Simon Says.&quot;,
  has  animate female proper;
</pre>

<p class="normal">(The variable <code>i</code> isn't needed yet, but 
will be used by the code added in the answer to the next exercise.) 
The test to see if <code>wn</code> has become larger than <code>num_words</code> 
prevents Charlotte from setting <code>verb_wordnum</code> to a non-existent 
word, which could only happen if the player typed just &#8220;charlotte, 
simon says&#8221;. If so, the game will reply &#8220;Simon says nothing, 
so Charlotte sticks her tongue out.&#8221;</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans30" name="ans30"></a>
<ul><li>30 (p. <a href="s18.html#ex30">140</a>) &nbsp;
First add a <code>Clap</code> verb (this is easy). Then give Charlotte a 
<code>number</code> property (initially 0, say) and add these three lines 
to the end of Charlotte's <code>grammar</code> routine:</li></ul>

<p class="lynxonly"></p>
<pre>
    self.number = TryNumber(verb_wordnum);
    if (self.number ~= -1000) {
        action = ##Clap; noun = 0; second = 0; rtrue;
    }
</pre>

<p class="normal">Her <code>orders</code> routine now needs the new clause:</p>

<p class="lynxonly"></p>
<pre>
    Clap: if (self.number == 0) &quot;Charlotte folds her arms.&quot;;
          for (i=0: i&lt;self.number: i++) {
              print &quot;Clap! &quot;;
              if (i == 100)
                  print &quot;(You must be regretting this by now.) &quot;;
              if (i == 200)
                  print &quot;(What a determined person she is.) &quot;;
          }
          if (self.number &gt; 100)
              &quot;^^Charlotte is a bit out of breath now.&quot;;
          &quot;^^~Easy!~ says Charlotte.&quot;;
</pre>
</div>

<div class="ans"><a id="ans31" name="ans31"></a>
<ul><li>31 (p. <a href="s18.html#ex31">140</a>) &nbsp;
The interesting point here is that when the <code>grammar</code> property 
finds the word &#8220;take&#8221;, it accepts it and has to move 
<code>verb_wordnum</code> on by one to signal that a word has been parsed 
succesfully.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; Dan &quot;Dyslexic Dan&quot;
  with name 'dan' 'dyslexic',
       grammar [;
           if (verb_word == 'take') { verb_wordnum++; return 'drop'; }
           if (verb_word == 'drop') { verb_wordnum++; return 'take'; }
       ],
       orders [;
           Take: &quot;~What,~ says Dan, ~you want me to take &quot;,
                     (the) noun, &quot;?~&quot;;
           Drop: &quot;~What,~ says Dan, ~you want me to drop &quot;,
                     (the) noun, &quot;?~&quot;;
           Inv: &quot;~That I can do,~ says Dan. ~I'm empty-handed.~&quot;;
           No: &quot;~Right you be then.~&quot;;
           Yes: &quot;~I'll be having to think about that.~&quot;;
           default: &quot;~Don't know how,~ says Dan.&quot;;
       ],
       initial &quot;Dyslexic Dan is here.&quot;,
  has  animate proper;
</pre>

<p class="normal">Since the words have been exchanged before any parsing 
takes place, Dan even responds to &#8220;drop inventory&#8221; and 
&#8220;take coin into slot&#8221;.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans32" name="ans32"></a>
<ul><li>32 (p. <a href="s18.html#ex32">141</a>) &nbsp;
Suppose Dan's grammar (but nobody else's) for the &#8220;examine&#8221; 
verb is to be extended. His grammar routine should also contain:</li></ul>

<p class="lynxonly"></p>
<pre>
    if (verb_word == 'examine' or 'x//') {
        verb_wordnum++; return -'danx,';
    }
</pre>

<p class="normal">(Note the crudity of this: it looks at the actual 
verb word, so you have to check any synonyms yourself.) The verb 
&#8220;danx,&#8221; must be declared later:</p>

<p class="lynxonly"></p>
<pre>Verb 'danx,' * 'conscience' -&gt; Inv;</pre>

<p class="normal">and now &#8220;Dan, examine conscience&#8221; will 
send him an <code>Inv</code> order: but &#8220;Dan, examine cow pie&#8221; 
will still send <code>Examine cow_pie</code> as usual.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans33" name="ans33"></a>
<ul><li>33 (p. <a href="s18.html#ex33">141</a>) &nbsp;
See <a href="s20.html">&#167;20</a> for <code>the_time</code> and 
other chronological matters. In particular, note that the game will 
need to call the library's <code>SetTime</code> routine to decide 
on a time of day.</li></ul>

<p class="lynxonly"></p>
<pre>
[ AlTime x; print (x/60), &quot;:&quot;, (x%60)/10, x%10; ];
Object -&gt; alarm_clock &quot;alarm clock&quot;
  with name 'alarm' 'clock',
       alarm_time 480, ! 08:00
       description [;
           print &quot;The alarm is &quot;;
           if (self has on) print &quot;on, &quot;; else print &quot;off, but &quot;;
           &quot;the clock reads &quot;, (AlTime) the_time,
           &quot; and the alarm is set for &quot;, (AlTime) self.alarm_time, &quot;.&quot;;
       ],
       react_after [;
           Inv: if (self in player) { new_line; &lt;&lt;Examine self&gt;&gt;; }
           Look: if (self in location) { new_line; &lt;&lt;Examine self&gt;&gt;; }
       ],
       daemon [ td;
           td = (1440 + the_time - self.alarm_time) % 1440;
           if (td &gt;= 0 &amp;&amp; td &lt;= 3 &amp;&amp; self has on)
               &quot;^Beep! Beep! The alarm goes off.&quot;;
       ],
       grammar [; return 'alarm,'; ],
       orders [;
           SwitchOn: give self on; StartDaemon(self);
               &quot;~Alarm set.~&quot;;
           SwitchOff: give self ~on; StopDaemon(self);
               &quot;~Alarm off.~&quot;;
           SetTo: self.alarm_time=noun; &lt;&lt;Examine self&gt;&gt;;
           default: &quot;~On, off or a time of day, pliz.~&quot;;
       ],
       life [;
           &quot;[Try ~clock, something~ to address the clock.]&quot;;
       ],
  has  talkable;
</pre>

<p class="normal">(So the alarm sounds for three minutes after its 
setting, then gives in.) Next, add a new verb to the grammar:</p>

<p class="lynxonly"></p>
<pre>
Verb 'alarm,'
    * 'on' -&gt; SwitchOn
    * 'off' -&gt; SwitchOff
    * TimeOfDay -&gt; SetTo;
</pre>

<p class="normal">using a token for parsing times of day called 
<span class="grammartoken"><code>TimeOfDay</code></span>: as this is 
one of the exercises in <a href="s31.html">&#167;31</a>, it won't be 
given here. Note that since the word &#8220;alarm,&#8221; can't be 
matched by anything the player types, this verb is concealed from ordinary 
grammar. The orders we produce here are not used in the ordinary way 
(for instance, the action <code>SwitchOn</code> with no <code>noun</code> 
or <code>second</code> would never ordinarily be produced by the parser) 
but this doesn't matter: it only matters that the grammar and the 
<code>orders</code> property agree with each other.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans34" name="ans34"></a>
<ul><li>34 (p. <a href="s18.html#ex34">141</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; tricorder &quot;tricorder&quot;
  with name 'tricorder',
       grammar [; return 'tc,'; ],
       orders [;
           Examine: if (noun == player) &quot;~You radiate life signs.~&quot;;
               print &quot;~&quot;, (The) noun, &quot; radiates &quot;;
               if (noun hasnt animate) print &quot;no &quot;;
               &quot;life signs.~&quot;;
           default: &quot;The tricorder bleeps.&quot;;
       ],
       life [;
           &quot;The tricorder is too simple.&quot;;
       ],
  has  talkable;
...
Verb 'tc,' * noun -&gt; Examine;
</pre>
</div>

<div class="ans"><a id="ans35" name="ans35"></a>
<ul><li>35 (p. <a href="s18.html#ex35">141</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object replicator &quot;replicator&quot;
  with name 'replicator',
       grammar [;
           return 'rc,'; 
       ],
       orders [;
           Give:
               if (noun in self)
                   &quot;The replicator serves up a cup of &quot;,
                   (name) noun, &quot; which you drink eagerly.&quot;;
               &quot;~That is not something I can replicate.~&quot;;
           default: &quot;The replicator is unable to oblige.&quot;;
       ],
       life [;
           &quot;The replicator has no conversational skill.&quot;;
       ],
  has  talkable;
Object -&gt; &quot;Earl Grey tea&quot; with name 'earl' 'grey' 'tea';
Object -&gt; &quot;Aldebaran brandy&quot; with name 'aldebaran' 'brandy';
Object -&gt; &quot;distilled water&quot; with name 'distilled' 'water';
...
Verb 'rc,' * held -&gt; Give;
</pre>

<p class="normal">The point to note here is that the 
<span class="grammartoken"><code>held</code></span> token means &#8216;held 
by the replicator&#8217; here, as the <code>actor</code> is the replicator, 
so this is a neat way of getting a &#8216;one of the following phrases&#8217; 
token into the grammar.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans36" name="ans36"></a>
<ul><li>36 (p. <a href="s18.html#ex36">141</a>) &nbsp;
This is similar to the previous exercises. Suppose that the crew are 
all members of the class <code>StarFleetOfficer</code>. The <code>orders</code> 
property for the badge is then:</li></ul>

<p class="lynxonly"></p>
<pre>
orders [;
    Examine:
        if (parent(noun))
            &quot;~&quot;, (name) noun, &quot; is in &quot;, (name) parent(noun), &quot;.~&quot;;
        &quot;~&quot;, (name) noun, &quot; is no longer aboard this demonstration
        game.~&quot;;
    default: &quot;The computer's only really good for locating the crew.&quot;;
],
</pre>

<p class="normal">and the <code>grammar</code> simply returns <code>'stc,'</code> 
which is defined as:</p>

<p class="lynxonly"></p>
<pre>
[ Crew i;
  switch(scope_stage)
  {  1: rfalse;
     2: objectloop (i ofclass StarFleetOfficer) PlaceInScope(i); rtrue;
  }
];
Verb 'stc,' * 'where' 'is' scope=Crew -&gt; Examine;
</pre>

<p class="normal">An interesting point is that the scope routine 
<span class="grammartoken"><code>scope=Crew</code></span> doesn't 
need to do anything at scope stage 3 (usually used for printing out 
errors) because the normal error-message printing system is never 
reached. Something like &#8220;computer, where is Comminder Doto&#8221; 
causes a <code>##NotUnderstood</code> order.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans37" name="ans37"></a>
<ul><li>37 (p. <a href="s18.html#ex37">142</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; Zen &quot;Zen&quot;
  with name 'zen' 'flight' 'computer',
       initial &quot;Square lights flicker unpredictably across a hexagonal
           fascia on one wall, indicating that Zen is on-line.&quot;,
       grammar [; return 'zen,'; ],
       orders [;
           ZenScan: &quot;The main screen shows a starfield,
               turning through &quot;, noun, &quot; degrees.&quot;;
           Go:  &quot;~Confirmed.~ The ship turns to a new bearing.&quot;;
           SetTo: if (noun &gt; 12) &quot;~Standard by &quot;, (number) noun,
                   &quot; exceeds design tolerances.~&quot;;
               if (noun == 0) &quot;~Confirmed.~ The ship's engines stop.&quot;;
               &quot;~Confirmed.~ The ship's engines step to
               standard by &quot;, (number) noun, &quot;.&quot;;
           Take: if (noun ~= force_wall) &quot;~Please clarify.~&quot;;
               &quot;~Force wall raised.~&quot;;
           Drop: if (noun ~= blasters)   &quot;~Please clarify.~&quot;;
               &quot;~Battle-computers on line.
               Neutron blasters cleared for firing.~&quot;;
           NotUnderstood: &quot;~Language banks unable to decode.~&quot;;
           default: &quot;~Information. That function is unavailable.~&quot;;
       ],
  has  talkable proper static;
Object -&gt; -&gt; force_wall &quot;force wall&quot;
  with name 'force' 'wall' 'shields';
Object -&gt; -&gt; blasters &quot;neutron blasters&quot;
  with name 'neutron' 'blasters';
...
[ ZenScanSub; &quot;This is never called but makes the action exist.&quot;; ];
Verb 'zen,'
    * 'scan' number 'orbital' -&gt; ZenScan
    * 'set' 'course' 'for' scope=Planet -&gt; Go
    * 'speed' 'standard' 'by' number -&gt; SetTo
    * 'raise' held -&gt; Take
    * 'clear' held 'for' 'firing' -&gt; Drop;
</pre>

<p class="normal">Dealing with <code>Ask</code>, <code>Answer</code> 
and <code>Tell</code> are left to the reader. As for planetary parsing:</p>

<p class="lynxonly"></p>
<pre>
[ Planet;
  switch (scope_stage) {
      1: rfalse; ! Disallow multiple planets
      2: ScopeWithin(galaxy); rtrue; ! Scope set to contents of galaxy
  }
];
Object galaxy;
Object -&gt; &quot;Earth&quot; with name 'earth' 'terra';
Object -&gt; &quot;Centauro&quot; with name 'centauro';
Object -&gt; &quot;Destiny&quot; with name 'destiny';
</pre>

<p class="normal">and so on for numerous other worlds of the oppressive 
if somewhat cheaply decorated Federation.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans38" name="ans38"></a>
<ul><li>38 (p. <a href="s18.html#ex38">142</a>) &nbsp;
This is a typical bit of &#8220;scope hacking&#8221;, in this case done 
with the <code>InScope</code> entry point, though providing the viewscreen 
with a similar <code>add_to_scope</code> routine would have done equally 
well. See <a href="s32.html">&#167;32</a>.</li></ul>

<p class="lynxonly"></p>
<pre>
    [ InScope;
      if (action_to_be == ##Examine or ##Show &amp;&amp; location == Bridge)
          PlaceInScope(noslen_maharg);
      if (scope_reason == TALKING_REASON)
          PlaceInScope(noslen_maharg);
      rfalse;
    ];
</pre>

<p class="normal">The variable <code>scope_reason</code> is always set 
to the constant value <code>TALKING_REASON</code> when the game is 
trying to work out who you wish to talk to: so it's quite easy to make 
the scope different for conversational purposes.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans39" name="ans39"></a>
<ul><li>39 (p. <a href="s18.html#ex39">142</a>) &nbsp;
Martha and the sealed room are defined as follows:</li></ul>

<p class="lynxonly"></p>
<pre>
Object sealed_room &quot;Sealed Room&quot;
  with description
           &quot;I'm in a sealed room, like a squash court without a door,
           maybe six or seven yards across&quot;,
  has  light;
Object -&gt; ball &quot;red ball&quot; with name 'red' 'ball';
Object -&gt; martha &quot;Martha&quot;
  with name 'martha',
       orders [ r;
           r = parent(self);
           Give:
               if (noun notin r) &quot;~That's beyond my telekinesis.~&quot;;
               if (noun == self) &quot;~Teleportation's too hard for me.~&quot;;
               move noun to player;
               &quot;~Here goes...~ and Martha's telekinetic talents
                   magically bring &quot;, (the) noun, &quot; to your hands.&quot;;
           Look:
               print &quot;~&quot;, (string) r.description;
               if (children(r) == 1) &quot;. There's nothing here but me.~&quot;;
               print &quot;. I can see &quot;;
               WriteListFrom(child(r), CONCEAL_BIT + ENGLISH_BIT);
               &quot;.~&quot;;
           default: &quot;~Afraid I can't help you there.~&quot;;
       ],
       life [;
           Ask: &quot;~You're on your own this time.~&quot;;
           Tell: &quot;Martha clucks sympathetically.&quot;;
           Answer: &quot;~I'll be darned,~ Martha replies.&quot;;
       ],
  has  animate female concealed proper;
</pre>

<p class="normal">but the really interesting part is the <code>InScope</code> 
routine to fix things up:</p>

<p class="lynxonly"></p>
<pre>
[ InScope actor;
  if (actor == martha) PlaceInScope(player);
  if (actor == player &amp;&amp; scope_reason == TALKING_REASON)
      PlaceInScope(martha);
  rfalse;
];
</pre>

<p class="normal">Note that since we want two-way communication, the 
player has to be in scope to Martha too: otherwise Martha won't be able 
to follow the command &#8220;martha, give me the fish&#8221;, because 
&#8220;me&#8221; will refer to something beyond her scope.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans40" name="ans40"></a>
<ul><li>40 (p. <a href="s19.html#ex40">145</a>) &nbsp;
In an outdoor game on a summer's day, one way would be to make a scenery 
object for the Sun which is <code>found_in</code> every location 
and has <code>light</code>. A sneakier method is to put the line</li></ul>

<p class="lynxonly"></p>
<pre>    give player light;</pre>

<p class="normal">in <code>Initialise</code>. Now there's never darkness 
near the player. Unless there are wrangles involving giving instructions 
to people in different locations (where it's still dark), or the player 
having an out-of-body experience (see <a href="s21.html">&#167;21</a>), 
this will work perfectly well. The player is never told &#8220;You 
are giving off light&#8221;, so nothing seems incongruous in play.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans41" name="ans41"></a>
<ul><li>41 (p. <a href="s19.html#ex41">146</a>) &nbsp;
Just test if <code>HasLightSource(gift) == true</code>.</li></ul>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans42" name="ans42"></a>
<ul><li>42 (p. <a href="s20.html#ex42">148</a>) &nbsp;
This is a crude implementation, for brevity (the real &#8216;Zork&#8217; 
thief has an enormous stock of attached messages). It does no more 
than choose a random exit and move through it on roughly one turn in 
three. A <code>life</code> routine is omitted, and of course this 
particular thief steals nothing. See &#8216;The Thief&#8217; for a 
much fuller, annotated implementation.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; thief &quot;thief&quot;
  with name 'thief' 'gentleman' 'mahu' 'modo',
       each_turn &quot;^The thief growls menacingly.&quot;,
       daemon [ direction thief_at way exit_count exit_chosen;
           if (random(3) ~= 1) rfalse;
           thief_at = parent(thief);
           objectloop (direction in compass) {
               way = thief_at.(direction.door_dir);
               if (way ofclass Object &amp;&amp; way hasnt door) exit_count++;
           }
           if (exit_count == 0) rfalse;
           exit_chosen = random(exit_count); exit_count = 0;
           objectloop (direction in compass) {
               way = thief_at.(direction.door_dir);
               if (way ofclass Object &amp;&amp; way hasnt door) exit_count++;
               if (exit_count == exit_chosen) {
                   move self to way;
                   if (thief_at == location) &quot;^The thief stalks away!&quot;;
                   if (way == location) &quot;^The thief stalks in!&quot;;
                   rfalse;
               }
           }
       ],
  has  animate;
</pre>

<p class="normal">(Not forgetting to <code>StartDaemon(thief)</code> at 
some point, for instance in the game's <code>Initialise</code> 
routine.) So the thief walks at random but never via doors, bridges 
and the like, because these may be locked or have rules attached. 
This is only a first try, and in a good game one would occasionally see 
the thief do something surprising, such as open a secret door. As for 
the name, &#8220;The Prince of Darkness is a gentleman. Modo he's called, 
and Mahu&#8221; (William Shakespeare, <i>King Lear</i> III iv).</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans43" name="ans43"></a>
<ul><li>43 (p. <a href="s20.html#ex43">148</a>) &nbsp;
We shall use a new property called <code>weight</code> and decide that 
any object which doesn't provide any particular weight will weigh 10 
units. Clearly, an object which contains other objects will carry 
their weight too, so:</li></ul>

<p class="lynxonly"></p>
<pre>
[ WeightOf obj t i;
  if (obj provides weight) t = obj.weight; else t = 10;
  objectloop (i in obj) t = t + WeightOf(i);
  return t;
];
</pre>

<p class="normal">Once every turn we shall check how much the player 
is carrying and adjust a measure of the player's fatigue accordingly. 
There are many ways we could choose to calculate this: for the sake 
of example we'll define two constants:</p>

<p class="lynxonly"></p>
<pre>
Constant FULL_STRENGTH = 500;
Constant HEAVINESS_THRESHOLD = 100;
</pre>

<p class="normal">Initially the player's strength will be the maximum 
possible, which we'll set to 500. Each turn the amount of weight being 
carried is subtracted from this, but 100 is also added on (without 
exceeding the maximum value). So if the player carries more than 100 
units then strength declines, but if the weight carried falls below 
100 then strength recovers. If the player drops absolutely everything, 
the entire original strength will recuperate in at most 5 turns. 
Exhaustion sets in if strength reaches 0, and at this point the player 
is forced to drop something, giving strength a slight boost. Anyway,
here's an implementation of all this:</p>

<p class="lynxonly"></p>
<pre>
Object WeightMonitor
  with players_strength,
       warning_level 5,
       activate [;
           self.players_strength = FULL_STRENGTH;
           StartDaemon(self);
       ],
       daemon [ warn strength item heaviest_weight heaviest_item;
           strength = self.players_strength
               - WeightOf(player) + HEAVINESS_THRESHOLD;
           if (strength &lt; 0) strength = 0;
           if (strength &gt; FULL_STRENGTH) strength = FULL_STRENGTH;
           self.players_strength = strength;
           if (strength == 0) {
               heaviest_weight = -1;
               objectloop(item in player)
                   if (WeightOf(item) &gt; heaviest_weight) {
                       heaviest_weight = WeightOf(item);
                       heaviest_item = item;
                   }
               if (heaviest_item == nothing) return;
               print &quot;^Exhausted with carrying so much, you decide
                   to discard quot;, (the) heaviest_item, &quot;: &quot;;
               &lt;Drop heaviest_item&gt;;
               if (heaviest_item in player) {
                   deadflag = true;
                   &quot;^Unprepared for this, you collapse.&quot;;
               }
               self.players_strength =
                   self.players_strength + heaviest_weight;
           }
           warn = strength/100; if (warn == self.warning_level) return;
           self.warning_level = warn;
           switch (warn) {
               3: &quot;^You are feeling a little tired.&quot;;
               2: &quot;^Your possessions are weighing you down.&quot;;
               1: &quot;^Carrying so much weight is wearing you out.&quot;;
               0: &quot;^You're nearly exhausted enough to drop everything
                  at an inconvenient moment.&quot;;
           }
       ];
</pre>

<p class="normal">When exhaustion sets in, this daemon tries to drop 
the heaviest item. (The actual dropping is done with <code>Drop</code> 
actions: in case the item is, say, a wild boar, which would bolt away 
into the forest when released. Also, after the attempt to <code>Drop</code>,
we check to see if the drop has succeeded, because the heaviest item 
might be a cannonball superglued to one's hands, or a boomerang, or 
some such.) Finally, of course, at some point &#8211; probably in 
<code>Initialise</code> &#8211; the game needs to send the message
<code>WeightMonitor.activate()</code> to get things going.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans44" name="ans44"></a>
<ul><li>44 (p. <a href="s20.html#ex44">148</a>) &nbsp;
Note that we use <code>StopTimer</code> before <code>StartTimer</code> 
in case the egg timer is already running. (<code>StopTimer</code> does 
nothing if the timer isn't running, while <code>StartTimer</code> does 
nothing if it is.)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; &quot;egg timer in the shape of a chicken&quot;
  with name 'egg' 'timer' 'egg-timer' 'eggtimer' 'chicken' 'dial',
       description
           &quot;Turn the dial on the side of the chicken to set this
           egg timer.&quot;,
       before [;
           Turn: StopTimer(self); StartTimer(self, 3);
               &quot;You turn the dial to its three-minute mark, and the
               chicken begins a sort of clockwork clucking.&quot;;
       ],
       time_left,
       time_out [;
           &quot;^~Cock-a-doodle-doo!~ says the egg-timer, in defiance of
           its supposedly chicken nature.&quot;;
       ];
</pre>
</div>

<div class="ans"><a id="ans45" name="ans45"></a>
<ul><li>45 (p. <a href="s20.html#ex45">149</a>) &nbsp;
See the next answer.</li></ul>
</div>

<div class="ans"><a id="ans46" name="ans46"></a>
<ul><li>46 (p. <a href="s20.html#ex46">149</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object tiny_claws &quot;sound of tiny claws&quot; thedark
  with article &quot;the&quot;,
       name 'tiny' 'claws' 'sound' 'of' 'scuttling' 'scuttle'
            'things' 'creatures' 'monsters' 'insects',
       initial &quot;Somewhere, tiny claws are scuttling.&quot;,
       before [;
           Listen: &quot;How intelligent they sound, for mere insects.&quot;;
           Touch, Taste: &quot;You wouldn't want to. Really.&quot;;
           Smell: &quot;You can only smell your own fear.&quot;;
           Attack: &quot;They easily evade your flailing about.&quot;;
           default: &quot;The creatures evade you, chittering.&quot;;
       ],
       each_turn [; 
           StartDaemon(self); 
       ],
       turns_active,
       daemon [;
           if (location ~= thedark) {
               self.turns_active = 0; StopDaemon(self); rtrue;
           }
           switch (++(self.turns_active)) {
               1: &quot;^The scuttling draws a little nearer, and your
                  breathing grows loud and hoarse.&quot;;
               2: &quot;^The perspiration of terror runs off your brow.
                  The creatures are almost here!&quot;;
               3: &quot;^You feel a tickling at your extremities and kick
                  outward, shaking something chitinous off. Their
                  sound alone is a menacing rasp.&quot;;
               4: deadflag = true;
                  &quot;^Suddenly there is a tiny pain, of a
                  hypodermic-sharp fang at your calf. Almost at once
                  your limbs go into spasm, your shoulders and
                  knee-joints lock, your tongue swells...&quot;;
           }
       ];
</pre>
</div>

<div class="ans"><a id="ans47" name="ans47"></a>
<ul><li>47 (p. <a href="s20.html#ex47">150</a>) &nbsp;
Either set a daemon to watch for <code>the_time</code> suddenly dropping, 
or put such a watch in the game's <code>TimePasses</code> routine.</li></ul>
</div>

<div class="ans"><a id="ans48" name="ans48"></a>
<ul><li>48 (p. <a href="s20.html#ex48">150</a>) &nbsp;
A minimal solution is as follows. Firstly, we'll define a class of 
outdoor locations, and make two constant definitions:</li></ul>

<p class="lynxonly"></p>
<pre>
Constant SUNRISE = 360;  ! i.e., 6 am
Constant SUNSET = 1140;  ! i.e., 7 pm
Class OutdoorLocation;
</pre>

<p class="normal">We handle night and day by having a light-giving scenery 
object present in outdoor locations during the day: we shall call this 
object &#8220;the sun&#8221;:</p>

<p class="lynxonly"></p>
<pre>
Object Sun &quot;sun&quot;
  with name 'sun',
       found_in [;
           if (real_location ofclass OutdoorLocation) rtrue;
       ],
       before [;
           Examine: ;
           default: &quot;The sun is too far away.&quot;;
       ],
       daemon [;
           if (the_time &gt;= SUNRISE &amp;&amp; the_time &lt; SUNSET) {
               if (self has absent) {
                   give self ~absent;
                   if (real_location ofclass OutdoorLocation) {
                       move self to place;
                       &quot;^The sun rises, illuminating the landscape!&quot;;
                   }
               }
           } else {
               if (self hasnt absent) {
                   give self absent; remove self;
                   if (real_location ofclass OutdoorLocation)
                       &quot;^As the sun sets, the landscape is plunged
                       into darkness.&quot;;
               }
           }
       ],
  has  light scenery;
</pre>

<p class="normal">In the <code>Initialise</code> routine, you need to 
call <code>StartDaemon(Sun);</code>. If the game starts in the hours 
of darkness, you should also give the Sun <code>absent</code>. 
Daybreak and nightfall will be automatic from there on.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans49" name="ans49"></a>
<ul><li>49 (p. <a href="s20.html#ex49">150</a>) &nbsp;
Because you don't know what order daemons will run in. A &#8216;fatigue&#8217;
daemon which makes the player drop something might come after the 
&#8216;mid-air&#8217; daemon has run for this turn. Whereas <code>each_turn</code> 
happens after daemons and timers have run their course, and can fairly 
assume no further movements will take place this turn.</li></ul>
</div>

<div class="ans"><a id="ans50" name="ans50"></a>
<ul><li>50 (p. <a href="s20.html#ex50">150</a>) &nbsp;
It would have to provide its own code to keep track of time, and it can
do this by providing a <code>TimePasses()</code> routine. Providing &#8220;time&#8221; 
or even &#8220;date&#8221; verbs to tell the player would also be a 
good idea.</li></ul>
</div>

<div class="ans"><a id="ans51" name="ans51"></a>
<ul><li>51 (p. <a href="s21.html#ex51">156</a>) &nbsp;
Two reasons. Firstly, sometimes you need to trap orders to other people, 
which <code>react_before</code> doesn't. Secondly, the player's 
<code>react_before</code> rule is not necessarily the first to react. 
Suppose in the deafness example that a cuckoo also has a
<code>react_before</code> rule covering <code>Listen</code>, printing a 
message about birdsong. If this happens before the player object is 
reached, the deafness rule never applies.</li></ul>
</div>

<div class="ans"><a id="ans52" name="ans52"></a>
<ul><li>52 (p. <a href="s21.html#ex52">156</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
orders [;
    if (gasmask hasnt worn) rfalse;
    if (actor == self &amp;&amp; action ~= ##Answer or ##Tell or ##Ask) rfalse;
    &quot;Your speech is muffled into silence by the gas mask.&quot;;
],
</pre>
</div>

<div class="ans"><a id="ans53" name="ans53"></a>
<ul><li>53 (p. <a href="s21.html#ex53">157</a>) &nbsp;
The common man's <i>wayhel</i> was a lowly mouse. Since we think much
more highly of the player:</li></ul>

<p class="lynxonly"></p>
<pre>
Object warthog &quot;Warthog&quot;
  with name 'wart' 'hog' 'warthog', description &quot;Muddy and grunting.&quot;,
       initial &quot;A warthog snuffles and grunts about in the ashes.&quot;,
       orders [;
           Go, Look, Examine, Smell, Taste, Touch, Search,
               Jump, Enter: rfalse;
           Eat: &quot;You haven't the knack of snuffling up to food yet.&quot;;
           default: &quot;Warthogs can't do anything so involved. If it
               weren't for the nocturnal eyesight and the lost weight,
               they'd be worse off all round than people.&quot;;
       ],
  has  animate proper;
</pre>

<p class="normal">Using <code>ChangePlayer(warthog);</code> will then 
bring about the transformation, though we must also move the 
<code>warthog</code> to some suitable location. The promised nocturnal 
eyesight will be brought about by giving the warthog <code>light</code> 
for the period when the player is changed to it.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans54" name="ans54"></a>
<ul><li>54 (p. <a href="s21.html#ex54">157</a>) &nbsp;
Change the <code>cant_go</code> message of the wormcast, dropping an 
even larger hint on the way:</li></ul>

<p class="lynxonly"></p>
<pre>
    cant_go [;
        if (player ~= warthog)
            &quot;Though you begin to feel certain that something lies
            behind and through the wormcast, this way must be an
            animal-run at best: it's far too narrow for your
            armchair-archaeologist's paunch.&quot;;
        print &quot;The wormcast becomes slippery around your warthog
            body, and you squeal involuntarily as you burrow
            through the darkness, falling finally southwards to...^&quot;;
        PlayerTo(Burial_Shaft); rtrue;
    ],
</pre>
</div>

<div class="ans"><a id="ans55" name="ans55"></a>
<ul><li>55 (p. <a href="s21.html#ex55">157</a>) &nbsp;
This is more straightforward than it sounds. The most interesting point
is that the map connection isn't between two rooms: it's between an 
<code>enterable</code> object, the cage, and a room, the burial chamber.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; cage &quot;iron cage&quot;
  with name 'iron' 'cage' 'bars' 'barred' 'frame' 'glyphs',
       description &quot;The glyphs read: Bird Arrow Warthog.&quot;,
       when_open
           &quot;An iron-barred cage, large enough to stoop over inside,
           looms ominously here, its door open. There are some glyphs
           on the frame.&quot;,
       when_closed &quot;The iron cage is closed.&quot;,
       after [;
           Enter:
               print &quot;The skeletons inhabiting the cage come alive,
                   locking bony hands about you, crushing and
                   pummelling. You lose consciousness, and when you
                   recover something grotesque and impossible has
                   occurred...^&quot;;
               move warthog to Antechamber; remove skeletons;
               give self ~open; give warthog light;
               self.after = 0;
               ChangePlayer(warthog, 1); &lt;&lt;Look&gt;&gt;;
       ],
       floor_open false,
       inside_description [;
           if (self.floor_open)
               &quot;From the floor of the cage, an open earthen pit cuts
               down into the burial chamber.&quot;;
           &quot;The bars of the cage surround you.&quot;;
       ],
       react_before [;
           Go: if (noun == d_obj &amp;&amp; self.floor_open) {
                   PlayerTo(Burial_Shaft); rtrue;
               }
       ],
  has  enterable transparent container openable open static;
Object -&gt; -&gt; skeletons &quot;skeletons&quot;
  with name 'skeletons' 'skeleton' 'bone' 'skull' 'bones' 'skulls',
       article &quot;deranged&quot;,
  has  pluralname static;
Object Burial_Shaft &quot;Burial Shaft&quot;
  with description
           &quot;In your eventual field notes, this will read:
           ~A corbel-vaulted crypt with an impacted earthen plug
           as seal above, and painted figures conjecturally
           representing the Nine Lords of the Night. Dispersed
           bones appear to be those of one elderly man and
           several child sacrifices, while other funerary remains
           include jaguar paws.~ (In field notes, it is essential
           not to give any sense of when you are scared witless.)&quot;,
       cant_go
           &quot;The architects of this chamber were less than generous in
           providing exits. Some warthog seems to have burrowed in
           from the north, though.&quot;,
       n_to Wormcast,
       u_to [;
           cage.floor_open = true;
           self.u_to = self.opened_u_to;
           move selfobj to self;
           print &quot;Making a mighty warthog-leap, you butt at the
               earthen-plug seal above the chamber, collapsing your
               world in ashes and earth. Something lifeless and
               terribly heavy falls on top of you: you lose
               consciousness, and when you recover, something
               impossible and grotesque has happened...^&quot;;
           ChangePlayer(selfobj); give warthog ~light; &lt;&lt;Look&gt;&gt;;
       ],
       before [;
           Jump: &lt;&lt;Go u_obj&gt;&gt;;
       ],
       opened_u_to [;
           PlayerTo(cage); rtrue;
       ],
  has  light;
</pre>
</div>

<div class="ans"><a id="ans56" name="ans56"></a>
<ul><li>56 (p. <a href="s21.html#ex56">158</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
    orders [;
        if (player == self) {
            if (actor ~= self)
                &quot;You only become tongue-tied and gabble.&quot;;
            rfalse;
        }
        Attack: &quot;The Giant looks at you with doleful eyes.
            ~Me not be so bad!~&quot;;
        default: &quot;The Giant cannot comprehend your instructions.&quot;;
    ],
</pre>
</div>

<div class="ans"><a id="ans57" name="ans57"></a>
<ul><li>57 (p. <a href="s22.html#ex57">164</a>) &nbsp;
Give the &#8220;chessboard&#8221; room a <code>short_name</code> routine 
(it probably already has one, to print names like &#8220;Chessboard 
d6&#8221;) and make it change the short name to &#8220;the gigantic 
Chessboard&#8221; if and only if <code>action</code> is currently set 
to <code>##Places</code>.</li></ul>
</div>

<div class="ans"><a id="ans58" name="ans58"></a>
<ul><li>58 (p. <a href="s22.html#ex58">165</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Class Quotation;
Object PendingQuote; Object SeenQuote;
[ QuoteFrom q;
  if (~~(q ofclass Quotation)) &quot;*** Oops! Not a quotation. ***&quot;;
  if (q notin PendingQuote or SeenQuote) move q to PendingQuote;
];
[ AfterPrompt q;
  q = child(PendingQuote);
  if (q) {
      move q to SeenQuote;
      q.show_quote();
  }
];
Quotation AhPeru
  with show_quote [;
           box &quot;Brother of Ingots -- Ah, Peru --&quot;
               &quot;Empty the Hearts that purchased you --&quot;
               &quot;&quot;
               &quot;-- Emily Dickinson&quot;;
       ];
</pre>

<p class="normal"><code>QuoteFrom(AhPeru)</code> will now do as it 
is supposed to. The children of the object <code>PendingQuote</code> 
act as a last in, first out queue, so if several quotations are pending 
in the same turn, this system will show them in successive turns, most 
recently requested first.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans59" name="ans59"></a>
<ul><li>59 (p. <a href="s25.html#ex59">191</a>) &nbsp;
Place the following definition in between the inclusion of <code>&quot;Parser.h&quot;</code>
and of <code>&quot;Verblib.h&quot;</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
Object LibraryMessages
  with before [;
           Prompt: switch (turns) {
               1: print &quot;^What should you, the detective, do now?^&gt;&quot;;
               2 to 9: print &quot;^What next?^&gt;&quot;;
               10: print &quot;^(Aren't you getting tired of seeing ~What
                   next?~ From here on, the prompt will be much
                   shorter.)^^&gt;&quot;;
               default: print &quot;^&gt;&quot;;
           }
           rtrue;
       ];
</pre>
</div>

<div class="ans"><a id="ans60" name="ans60"></a>
<ul><li>60 (p. <a href="s25.html#ex60">191</a>) &nbsp;
Looking in <a href="sa4.html">&#167;A4</a>, we find that the offending 
message is <code>Go</code>, number 1, but that this message appears in 
two cases: when the player is on a <code>supporter</code>, which
we want to deal with, and when the player is in a <code>container</code>, 
which we want to leave alone.</li></ul>

<p class="lynxonly"></p>
<pre>
Object LibraryMessages
  with before [ previous_parent;
           Go: if (lm_n == 1 &amp;&amp; lm_o has supporter) {
                   print &quot;(first getting off &quot;, (the) lm_o, &quot;)^&quot;;
                   previous_parent = parent(player);
                   keep_silent = true; &lt;Exit&gt;; keep_silent = false;
                   if (player in parent(previous_parent)) &lt;&lt;Go noun&gt;&gt;;
                   rtrue;
               }
       ];
</pre>

<p class="normal">Note that after we've tried to perform an <code>Exit</code> 
action, either we've made some progress (in that the player is no longer 
in the same parent) and can try the <code>Go</code> action again, or
else we've failed, in which case something has been printed to that 
effect. Either way, we return <code>true</code>.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans61" name="ans61"></a>
<ul><li>61 (p. <a href="s25.html#ex61">191</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object LibraryMessages
  with before [;
           Push: if (lm_n == 3 &amp;&amp; noun has switchable) {
                     if (noun has on) &lt;&lt;SwitchOff noun&gt;&gt;;
                     &lt;&lt;SwitchOn noun&gt;&gt;;
                 }
       ];
</pre>
</div>

<h3>Exercises in Chapter IV</h3>

<div class="ans"><a id="ans62" name="ans62"></a>
<ul><li>62 (p. <a href="s26.html#ex62">194</a>) &nbsp;
Simply define the following, for accusative, nominative and capitalised
nominative pronouns, respectively.</li></ul>

<p class="lynxonly"></p>
<pre>
[ PronounAcc i;
    if (i hasnt animate || i has neuter) print &quot;it&quot;;
    else { if (i has female) print &quot;her&quot;; else print &quot;him&quot;; } ];
[ PronounNom i;
    if (i hasnt animate || i has neuter) print &quot;it&quot;;
    else { if (i has female) print &quot;she&quot;; else print &quot;he&quot;; } ];
[ CPronounNom i;
    if (i hasnt animate || i has neuter) print &quot;It&quot;;
    else { if (i has female) print &quot;She&quot;; else print &quot;He&quot;; } ];
</pre>
</div>

<div class="ans"><a id="ans63" name="ans63"></a>
<ul><li>63 (p. <a href="s26.html#ex63">196</a>) &nbsp;
We first set up the pieces. Bobby Fischer (Black, lower case, vs D. Byrne,
Rosenwald Tournament, New York, 1956), aged thirteen and with queen 
<i>en prise</i>, is about to play Be6! and will win.</li></ul>

<p class="lynxonly"></p>
<pre>
Array Position -&gt;
    &quot;r...r.k.\
     pp...pbp\
     .qp...p.\
     ..B.....\
     ..BP..b.\
     Q.n..N..\
     P....PPP\
     ...R.K.R&quot;;
</pre>

<p class="normal">(The backslashes <code>\</code> remove spacing, so that this array 
contains just 64 entries.) Now for the objects. It will only be an 
illusion that there are sixty-four different locations, so we make 
sure the player drops nothing onto the board's surface.</p>

<p class="lynxonly"></p>
<pre>
Object Chessboard
  with description [;
           print &quot;A square expanse of finest &quot;;
           if ((self.rank + self.file - 'a') % 2 == 1)
               print &quot;mahogany&quot;; else print &quot;cedarwood&quot;; &quot;.&quot;;
       ],
       short_name [;
           if (action==##Places) { print &quot;the Chessboard&quot;; rtrue; }
           print &quot;Square &quot;, (char) self.file, self.rank; rtrue;
       ],
       rank 1, file 'a',
       n_to  [; return self.try_move_to(self.rank+1,self.file);   ],
       ne_to [; return self.try_move_to(self.rank+1,self.file+1); ],
       e_to  [; return self.try_move_to(self.rank,  self.file+1); ],
       se_to [; return self.try_move_to(self.rank-1,self.file+1); ],
       s_to  [; return self.try_move_to(self.rank-1,self.file);   ],
       sw_to [; return self.try_move_to(self.rank-1,self.file-1); ],
       w_to  [; return self.try_move_to(self.rank,  self.file-1); ],
       nw_to [; return self.try_move_to(self.rank+1,self.file-1); ],
       try_move_to [ r f na p;
           if (~~(r &gt;= 1 &amp;&amp; r &lt;= 8 &amp;&amp; f &gt;= 'a' &amp;&amp; f &lt;= 'h'))
               &quot;That would be to step off the chessboard.&quot;;
           move Piece to self; na = Piece.&amp;name; na--&gt;1 = 'white';
           give Piece ~proper ~female;
           p = Position-&gt;((8-r)*8 + f - 'a');
           switch (p) {
               '.': remove Piece;
               'p', 'r', 'n', 'b', 'q', 'k': na--&gt;1 = 'black';
           }
           switch (p) {
               'p', 'P': na--&gt;0 = 'pawn';
               'r', 'R': na--&gt;0 = 'rook';
               'n', 'N': na--&gt;0 = 'knight';
               'b', 'B': na--&gt;0 = 'bishop';
               'q', 'Q': na--&gt;0 = 'queen'; give Piece female;
               'k', 'K': na--&gt;0 = 'king'; give Piece proper;
           }
           switch (p) {
               'p': Piece.short_name = &quot;Black Pawn&quot;;
               ...
               'K': Piece.short_name = &quot;The White King&quot;;
           }
           self.rank = r; self.file = f; give self ~visited;
           return self;
       ],
       after [;
           Drop: move noun to player;
               &quot;From high above, a ghostly voice whispers ~J'adoube~,
               and &quot;, (the) noun, &quot; springs back into your hands.&quot;;
       ],
  has  light;
Object Piece
  with name '(kind)' '(colour)' 'piece' 'chess',
       short_name &quot;(A short name filled in by Chessboard)&quot;,
       initial [; &quot;This square is occupied by &quot;, (a) self, &quot;.&quot;; ],
  has  static;
</pre>

<p class="normal">And to get the player onto the board in the first place,</p>

<p class="lynxonly"></p>
<pre>
            PlayerTo(Chessboard.try_move_to(1,'a'));
</pre>
</div>

<div class="ans"><a id="ans64" name="ans64"></a>
<ul><li>64 (p. <a href="s26.html#ex64">197</a>) &nbsp;
Use the <code>invent</code> routine to signal to <code>short_name</code> 
and <code>article</code> routines to change their usual habits:</li></ul>

<p class="lynxonly"></p>
<pre>
Object &quot;ornate box&quot;
  with name 'ornate' 'box' 'troublesome',
       altering_short_name,
       invent [;
           self.altering_short_name = (inventory_stage == 1);
       ],
       short_name [;
           if (self.altering_short_name) { print &quot;box&quot;; rtrue; }
       ],
       article [;
           if (self.altering_short_name) print &quot;that troublesome&quot;;
           else print &quot;an&quot;;
       ],
  has  container open openable;
</pre>

<p class="normal">Thus the usual short name and article &#8220;an ornate 
box&#8221; becomes &#8220;that troublesome box&#8221; in inventory listings, 
but nowhere else.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans65" name="ans65"></a>
<ul><li>65 (p. <a href="s26.html#ex65">200</a>) &nbsp;
This answer is cheating, as it needs to know about the library's 
<code>lookmode</code> variable (set to 1 for normal, 2 for verbose 
or 3 for superbrief, according to the player's most recent choice). 
Simply include:</li></ul>

<p class="lynxonly"></p>
<pre>
[ TimePasses;
  if (action ~= ##Look &amp;&amp; lookmode == 2) &lt;Look&gt;;
];
</pre>
</div>

<div class="ans"><a id="ans66" name="ans66"></a>
<ul><li>66 (p. <a href="s27.html#ex66">203</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ DoubleInvSub item number_carried number_worn;
  print &quot;You are carrying &quot;;
  objectloop (item in player) {
      if (item hasnt worn) { give item workflag; number_carried++; }
      else { give item ~workflag; number_worn++; }
  }
  if (number_carried == 0) print &quot;nothing&quot;;
  else WriteListFrom(child(player),
          FULLINV_BIT + ENGLISH_BIT + RECURSE_BIT + WORKFLAG_BIT);
  if (number_worn == 0) &quot;.&quot;;
  if (number_carried == 0) print &quot;, but&quot;; else print &quot;. In addition,&quot;;
  print &quot; you are wearing &quot;;
  objectloop (item in player)
      if (item hasnt worn) give item ~workflag;
      else give item workflag;
  WriteListFrom(child(player),
      ENGLISH_BIT + RECURSE_BIT + WORKFLAG_BIT);
  &quot;.&quot;;
];
</pre>
</div>

<div class="ans"><a id="ans67" name="ans67"></a>
<ul><li>67 (p. <a href="s27.html#ex67">204</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Class Letter
  with name 'letter' 'scrabble' 'piece' 'letters//p' 'pieces//p',
       list_together [;
           if (inventory_stage == 1) {
               print &quot;the letters &quot;;
               c_style = c_style | (ENGLISH_BIT + NOARTICLE_BIT);
               c_style = c_style &amp;~ (NEWLINE_BIT + INDENT_BIT);
           }
           else print &quot; from a Scrabble set&quot;;
       ],
       short_name [;
           if (listing_together ofclass Letter) rfalse;
           print &quot;letter &quot;, (object) self, &quot; from a Scrabble set&quot;;
           rtrue;
       ],
       article &quot;the&quot;;
</pre>

<p class="normal">The bitwise operation <code>c = c | ENGLISH_BIT</code> 
sets the given bit (i.e., adds it on to <code>c</code>) if it wasn't 
already set (i.e., if it hadn't already been added to <code>c</code>). 
The operation <code>&amp;~</code>, which is actually two operators 
<code>&amp;</code> (and) and ~ (not) put together, takes away something 
if it's present and otherwise does nothing. As many letters as desired 
can now be created, along the lines of</p>

<p class="lynxonly"></p>
<pre>Letter -&gt; &quot;X&quot; with name 'x//';</pre>
</div>

<div class="ans"><a id="ans68" name="ans68"></a>
<ul><li>68 (p. <a href="s27.html#ex68">204</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Class Coin
 with name 'coin' 'coins//p',
      description &quot;A round unstamped disc, presumably local currency.&quot;,
      list_together &quot;coins&quot;,
      plural [;
          print (address) self.&amp;name--&gt;0;
          if (~~(listing_together ofclass Coin)) print &quot; coins&quot;;
      ],
      short_name [;
          print (address) self.&amp;name--&gt;0;
          if (~~(listing_together ofclass Coin)) print &quot; coin&quot;;
          rtrue;
      ],
      article [;
          if (listing_together ofclass Coin) print &quot;one&quot;;
          else print &quot;a&quot;;
      ];
Class GoldCoin   class Coin with name 'gold';
Class SilverCoin class Coin with name 'silver';
Class BronzeCoin class Coin with name 'bronze';
SilverCoin -&gt;;
</pre>

<p class="normal">The trickiest lines here are the <code>print 
(address)</code> ones. This is the least commonly used printing-rule 
built into Inform, and is only really used to print out the text of a
dictionary word: whereas</p>

<p class="lynxonly"></p>
<pre>    print (string) 'gold';</pre>

<p class="normal">is likely to print garbled and nonsensical text, because 
<code>'gold'</code> is a dictionary word not a string. Anyway, these 
lines print out the first entry in the <code>name</code> list for the 
coin, so they rely on the fact that <code>name</code> words accumulate 
in the front of the list. The class <code>Coin</code> starts the list 
as (&#8220;coin&#8221;, &#8220;coins&#8221;), whereupon <code>SilverCoin</code> 
augments it to (&#8220;silver&#8221;, &#8220;coin&#8221;, &#8220;coins&#8221;). 
Finally, because a dictionary word only stores up to nine letters, a
different solution would be needed to cope with molybdenum coins.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans69" name="ans69"></a>
<ul><li>69 (p. <a href="s27.html#ex69">205</a>) &nbsp;
Firstly, a printing rule to print the state of coins. Coin-objects will 
have a property called <code>heads_up</code> which is always either 
<code>true</code> or <code>false</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
[ Face x; if (x.heads_up) print &quot;Heads&quot;; else print &quot;Tails&quot;; ];
</pre>

<p class="normal">There are two kinds of coin but we'll implement them 
with three classes: <code>Coin</code> and two sub-categories, 
<code>GoldCoin</code> and <code>SilverCoin</code>. Since the coins 
only join up into trigrams when present in groups of three, we need 
a routine to detect this:</p>

<p class="lynxonly"></p>
<pre>
[ CoinsTogether cla member p common_parent;
  objectloop (member ofclass cla) {
      p = parent(member);
      if (common_parent == nothing) common_parent = p;
      else if (common_parent ~= p) return nothing;
  }
  return common_parent;
];
</pre>

<p class="normal">Thus <code>CoinsTogether(GoldCoin)</code> decides 
whether all objects of class <code>GoldCoin</code> have the same parent, 
returning either that parent or else <code>nothing</code>, and likewise 
for <code>SilverCoin</code>. Now the class definitions:</p>

<p class="lynxonly"></p>
<pre>
Class Coin
 with name 'coin' 'coins//p',
      heads_up true, article &quot;the&quot;, metal &quot;steel&quot;,
      after [;
          Drop, PutOn:
              self.heads_up = (random(2) == 1); print (Face) self;
              if (CoinsTogether(self.which_class)) {
                  print &quot;. The &quot;, (string) self.metal,
                      &quot; trigram is now &quot;, (Trigram) self;
              }
              &quot;.&quot;;
      ];
[ CoinLT common_parent member count;
  if (inventory_stage == 1) {
      print &quot;the &quot;, (string) self.metal, &quot; coins &quot;;
      common_parent = CoinsTogether(self.which_class);
      if (common_parent &amp;&amp;
          (common_parent == location || common_parent has supporter)) {
          objectloop (member ofclass self.which_class) {
              print (name) member;
              switch (++count) {
                  1: print &quot;, &quot;; 2: print &quot; and &quot;;
                  3: print &quot; (showing the trigram &quot;,
                     (Trigram) self, &quot;)&quot;;
              }
          }
          rtrue;
      }
      c_style = c_style | (ENGLISH_BIT + NOARTICLE_BIT);
      c_style = c_style &amp;~ (NEWLINE_BIT + INDENT_BIT);
  }
  rfalse;
];
Class GoldCoin class Coin
 with name 'gold', metal &quot;gold&quot;, interpretation gold_trigrams,
      which_class GoldCoin,
      list_together [; return CoinLT(); ];
Class SilverCoin class Coin
 with name 'silver', metal &quot;silver&quot;, interpretation silver_trigrams,
      which_class SilverCoin,
      list_together [; return CoinLT(); ];
Array gold_trigrams --&gt;   &quot;fortune&quot; &quot;change&quot; &quot;river flowing&quot; &quot;chance&quot;
                             &quot;immutability&quot; &quot;six stones in a circle&quot;
                             &quot;grace&quot; &quot;divine assistance&quot;;
Array silver_trigrams --&gt; &quot;happiness&quot; &quot;sadness&quot; &quot;ambition&quot; &quot;grief&quot;
                             &quot;glory&quot; &quot;charm&quot; &quot;sweetness of nature&quot;
                             &quot;the countenance of the Hooded Man&quot;;
</pre>

<p class="normal">(There are two unusual points here. Firstly, the 
<code>CoinsLT</code> routine is not simply given as the common 
<code>list_together</code> value in the <code>coin</code> class since, 
if it were, all six coins would be grouped together: we want two groups 
of three, so the gold and silver coins have to have different 
<code>list_together</code> values. Secondly, if a trigram is together 
and on the floor, it is not good enough to simply append text like 
&#8220;showing Tails, Heads, Heads (change)&#8221; at <code>inventory_stage</code> 
2 since the coins may be listed in a funny order. In that event, the 
order the coins are listed in doesn't correspond to the order their
values are listed in, which is misleading. So instead <code>CoinsLT</code> 
takes over entirely at <code>inventory_stage</code> 1 and prints out 
the list of three itself, returning <code>true</code> to stop the 
list from being printed out by the library as well.) To resume: whenever 
coins are listed together, they are grouped into gold and silver. Whenever 
trigrams are visible they are to be described by either <code>Trigram(GoldClass)</code> 
or <code>Trigram(SilverClass)</code>:</p>

<p class="lynxonly"></p>
<pre>
[ Trigram acoin cla member count state;
  cla = acoin.which_class;
  objectloop (member ofclass cla) {
      print (Face) member;
      if (count++ &lt; 2) print &quot;,&quot;; print &quot; &quot;;
      state = state*2 + member.heads_up;
  }
  print &quot;(&quot;, (string) (acoin.interpretation)--&gt;state, &quot;)&quot;;
];
</pre>

<p class="normal">Note that the class definitions refer to their arrays, 
but do not actually include the arrays themselves &#8211; this saves 
each coin carrying a copy of the whole array around with it, which would 
be wasteful. It's a marginal point, though, as there are only six 
actual coins:</p>

<p class="lynxonly"></p>
<pre>
GoldCoin -&gt; &quot;goat&quot; with name 'goat';
GoldCoin -&gt; &quot;deer&quot; with name 'deer';
GoldCoin -&gt; &quot;chicken&quot; with name 'chicken';
SilverCoin -&gt; &quot;robin&quot; with name 'robin';
SilverCoin -&gt; &quot;snake&quot; with name 'snake';
SilverCoin -&gt; &quot;bison&quot; with name 'bison';
</pre>

<p class="normal">If these were found in (say) a barn, we might have 
to take more care not to let them be called &#8220;goat&#8221; and so 
on, but let us assume not.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans70" name="ans70"></a>
<ul><li>70 (p. <a href="s27.html#ex70">205</a>) &nbsp;
There are innumerable methods for sorting, and an extensive research
literature can advise on which method is likely to perform fastest 
in which circumstances. Here matters are complicated by the fact that 
it is not easy to exchange two objects in the tree without shuffling 
many other objects backwards and forwards to do so. The solution 
below is concise rather than efficient. Briefly, if there are <i>N</i> 
members of the <code>AlphaSorted</code> class then the game pauses 
before play begins to make 
<span style="letter-spacing:3px"><i>N</i><sup>2</sup></span> 
comparisons of strings 
(this could easily be made faster but only happens once anyway): it then 
numbers off the members 1, 2, 3,&#8230; in their correct alphabetical 
order, and subsequently uses this list to check only those objects 
which have moved since they were last checked.</li></ul>

<p class="lynxonly"></p>
<pre>
Object heap1; Object heap2; Object heap3; Object heap4;
Class AlphaSorted
  with last_parent, last_sibling, sort_ordering,
       react_before [ t u v;
           Look, Search, Open, Inv:
               if (parent(self) == self.last_parent
                   &amp;&amp; sibling(self) == self.last_sibling) rfalse;
               if (self.sort_ordering == 0)
                   objectloop (t ofclass AlphaSorted)
                       t.order_yourself();
                   t = parent(self);
                   while ((u = child(t)) ~= 0) {
                       if (u ofclass AlphaSorted) {
                           v = self.sort_ordering - u.sort_ordering;
                           if (v &lt; 0) move u to heap1;
                           if (v == 0) move u to heap2;
                           if (v &gt; 0) move u to heap3;
                       }
                       else move u to heap4;
                   }
                   while ((u = child(heap1)) ~= 0) move u to t;
                   while ((u = child(heap2)) ~= 0) move u to t;
                   while ((u = child(heap3)) ~= 0) move u to t;
                   while ((u = child(heap4)) ~= 0) move u to t;
                   self.last_parent = parent(self);
                   self.last_sibling = sibling(self);
           ],
           order_yourself [ y val;
               objectloop (y ofclass AlphaSorted
                           &amp;&amp; CompareObjects(self, y) &gt; 0) val++;
               self.sort_ordering = val + 1;
           ];
</pre>

<p class="normal">The above code assumes that a routine called 
<code>CompareObjects(a,b)</code> exists, and returns a positive number, 
zero or a negative number according to whether <code>a</code> should come
after, with or before <code>b</code> in lists. You could substitute any 
sorting rule here, but here as promised is the rule &#8220;in alphabetical 
order of the object's short name&#8221;:</p>

<p class="lynxonly"></p>
<pre>
Array sortname1 -&gt; 128;
Array sortname2 -&gt; 128;
[ CompareObjects obj1 obj2 i d l1 l2;
  sortname1 --&gt; 0 = 125; sortname2 --&gt; 0 = 125;
  for (i = 2: i &lt; 128: i++) { sortname1-&gt;i = 0; sortname2-&gt;i = 0; }
  @output_stream 3 sortname1; print (name) obj1; @output_stream -3;
  @output_stream 3 sortname2; print (name) obj2; @output_stream -3;
  for (i = 2: : i++) {
      l1 = sortname1-&gt;i; l2 = sortname2-&gt;i;
      d = l1 - l2; if (d) return d;
      if (l1 == 0) return 0;
  }
];
</pre>
</div>

<div class="ans"><a id="ans71" name="ans71"></a>
<ul><li>71 (p. <a href="s28.html#ex71">210</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
parse_name [ n w colour;
    if (self.ripe) colour = 'red'; else colour = 'green';
    do { w = NextWord(); n++; } until (w ~= colour or 'fried');
    if (w == 'tomato') return n;
    return 0;
],
</pre>
</div>

<div class="ans"><a id="ans72" name="ans72"></a>
<ul><li>72 (p. <a href="s28.html#ex72">210</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; &quot;/?%?/ (the artiste formally known as Princess)&quot;
  with name 'princess' 'artiste' 'formally' 'known' 'as',
       kissed false,
       short_name [;
           if (~~(self.kissed)) { print &quot;Princess&quot;; rtrue; }
       ],
       react_before [;
           Listen: print_ret (name) self, &quot; sings a soft siren song.&quot;;
       ],
       initial [;
           print_ret (name) self, &quot; is singing softly.&quot;;
       ],
       parse_name [ x n;
           if (~~(self.kissed)) {
               if (NextWord() == 'princess') return 1;
               return 0;
           }
           x = WordAddress(wn);
           if (x-&gt;0 == '/' &amp;&amp; x-&gt;1 == '?' &amp;&amp; x-&gt;2 == '%'
               &amp;&amp; x-&gt;3 == '?' &amp;&amp; x-&gt;4 == '/') {
               ! See notes below for what this next line is for:
               while (wn &lt;= parse-&gt;1 &amp;&amp; WordAddress(wn++) &lt; x+5) n++;
               return n;
           }
           return -1;
       ],
       life [;
           Kiss: self.kissed = true; self.life = NULL;
               &quot;In a fairy-tale transformation, the Princess
               steps back and astonishes the world by announcing
               that she will henceforth be known as ~/?%?/~.&quot;;
       ],
  has  animate proper female;
</pre>

<p class="normal">The line commented on above needs some explanation. What 
it does is to count up the number of &#8220;words&#8221; making up 
the five characters in <code>x-&gt;0</code> to <code>x-&gt;4</code>. This 
isn't really needed in the example above, but it would be if (say) the 
text to be matched was <code>a.,.a</code> because the full stops and 
comma would make the parser consider this text as five separate words, 
so that <code>n</code> should be set to 5.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans73" name="ans73"></a>
<ul><li>73 (p. <a href="s28.html#ex73">210</a>) &nbsp;
Something to note here is that the button can't be called just &#8220;coffee&#8221;
when the player's holding a cup of coffee: this means the game responds 
sensibly to the sequence &#8220;press coffee&#8221; and &#8220;drink 
coffee&#8221;. Also note the call to <code>PronounNotice(drink)</code>, 
which tells the Inform parser that the pronouns (in English, &#8220;it&#8221;, 
&#8220;him&#8221;, &#8220;her&#8221;, &#8220;them&#8221;) to reset 
themselves to the drink where appropriate.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; drinksmat &quot;drinks machine&quot;,
  with name 'drinks' 'machine',
       initial
           &quot;A drinks machine has buttons for Cola, Coffee and Tea.&quot;,
  has  static transparent;
Object -&gt; -&gt; thebutton &quot;drinks machine button&quot;
  with button_pushed,
       parse_name [ w n flag drinkword;
           for (: flag == false: n++) {
               switch (w = NextWord()) {
                   'button', 'for':
                   'coffee', 'tea', 'cola':
                       if (drinkword == 0) drinkword = w;
                   default: flag = true; n--;
               }
           }
           if (drinkword == drink.&amp;name--&gt;0 &amp;&amp; n==1 &amp;&amp; drink in player)
               return 0;
           self.button_pushed = drinkword; return n;
       ],
       before [;
           Push, SwitchOn:
               if (self.button_pushed == 0)
                   &quot;You'll have to say which button to press.&quot;;
               if (parent(drink) ~= 0) &quot;The machine's broken down.&quot;;
               drink.&amp;name--&gt;0 = self.button_pushed;
               move drink to player;
               PronounNotice(drink);
               &quot;Whirr! The machine puts &quot;, (a) drink,
                   &quot; into your glad hands.&quot;;
           Attack: &quot;The machine shudders and squirts cola at you.&quot;;
           Drink: &quot;You can't drink until you've worked the machine.&quot;;
       ];
Object drink
  with name 'liquid' 'cup' 'of' 'drink',
       short_name [;
           print &quot;cup of &quot;, (address) self.&amp;name--&gt;0;
           rtrue;
       ],
       before [;
           Drink: remove self;
               &quot;Ugh, that was awful. You crumple the cup and
               responsibly dispose of it.&quot;;
       ];
</pre>
</div>

<div class="ans"><a id="ans74" name="ans74"></a>
<ul><li>74 (p. <a href="s28.html#ex74">210</a>) &nbsp;
Most of the work is handed over to <code>WordInProperty(w,obj,prop)</code>, 
a routine in the library which checks to see if <code>w</code> is one 
of the entries in the word array <code>obj.&amp;prop</code>, returning 
<code>true</code> or <code>false</code> as appropriate:</li></ul>

<p class="lynxonly"></p>
<pre>
parse_name [ n;
    while (WordInProperty(NextWord(), self, name)) n++;
    return n;
],
</pre>
</div>

<div class="ans"><a id="ans75" name="ans75"></a>
<ul><li>75 (p. <a href="s28.html#ex75">210</a>) &nbsp;
Create a new property <code>adjective</code>, and move names which 
are adjectives to it: for instance,</li></ul>

<p class="lynxonly"></p>
<pre>name 'tomato' 'vegetable', adjective 'fried' 'green' 'cooked',</pre>

<p class="normal">Then, again using <code>WordInProperty</code> 
routine as in the previous answer,</p>

<p class="lynxonly"></p>
<pre>
[ ParseNoun obj n m;
  while (WordInProperty(NextWord(),obj,adjective) == 1) n++; wn--;
  while (WordInProperty(NextWord(),obj,name) == 1) m++;
  if (m == 0) return 0; return n+m;
];
</pre>
</div>

<div class="ans"><a id="ans76" name="ans76"></a>
<ul><li>76 (p. <a href="s28.html#ex76">210</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ ParseNoun obj;
  if (NextWord() == 'object' &amp;&amp; TryNumber(wn) == obj) return 2;
  wn--; return -1;
];
</pre>
</div>

<div class="ans"><a id="ans77" name="ans77"></a>
<ul><li>77 (p. <a href="s28.html#ex77">210</a>) &nbsp;
Since this affects the parsing of all nouns, not just a single object, 
we need to set the entry point routine:</li></ul>

<p class="lynxonly"></p>
<pre>
[ ParseNoun;
  if (NextWord() == '#//') return 1;
  wn--; return -1;
];
</pre>
</div>

<div class="ans"><a id="ans78" name="ans78"></a>
<ul><li>78 (p. <a href="s28.html#ex78">210</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ ParseNoun;
  switch (NextWord()) {
      '#//': return 1;
      '*//': parser_action = ##PluralFound; return 1;
  }
  wn--; return -1;
];
</pre>
</div>

<div class="ans"><a id="ans79" name="ans79"></a>
<ul><li>79 (p. <a href="s29.html#ex79">213</a>) &nbsp;
This solution is a little simplified, as it only allows the player to 
write single words on cubes. Notice that if two cubes have the same 
text written on them, then they become indistinguishable from each 
other again.</li></ul>

<p class="lynxonly"></p>
<pre>
Class FeaturelessCube
 with description &quot;A perfect white cube, four inches on a side.&quot;,
      text_written_on 0 0 0 0 0 0 0 0, ! Room for 16 characters of text
      text_length,
      article &quot;a&quot;,
      parse_name [ i j flag;
          if (parser_action == ##TheSame) {
              if (parser_one.text_length ~= parser_two.text_length)
                  return -2;
              for (i = 0: i &lt; parser_one.text_length: i++)
                  if (parser_one.&amp;text_written_on-&gt;i
                      ~= parser_two.&amp;text_written_on-&gt;i) return -2;
              return -1;
          }
          for (:: i++, flag = false) {
              switch (NextWordStopped()) {
                  'cube', 'white': flag = true;
                  'featureless', 'blank':
                      flag = (self.text_length == 0);
                  'cubes': flag = true; parser_action = ##PluralFound;
                  -1: return i;
                  default:
                      if (self.text_length == WordLength(wn-1))
                          for (j=0, flag=true: j&lt;self.text_length: j++)
                              flag = flag &amp;&amp; (self.&amp;text_written_on-&gt;j
                                  == WordAddress(wn-1)-&gt;j);
              }
              if (flag == false) return i;
          }
      ],
      short_name [ i;
          if (self.text_length == 0) print &quot;featureless white cube&quot;;
          else {
              print &quot;~&quot;;
              for (i = 0: i&lt;self.text_length: i++)
                  print (char) self.&amp;text_written_on-&gt;i;
              print &quot;~ cube&quot;;
          }
          rtrue;
      ],
      plural [;
          self.short_name(); print &quot;s&quot;;
      ];
Object -&gt; burin &quot;magic burin&quot;
  with name 'magic' 'magical' 'burin' 'pen',
       description
           &quot;This is a magical burin, used for inscribing objects with
           words or runes of magical import.&quot;,
       the_naming_word,
       before [ i;
           WriteOn:
               if (~~(second ofclass FeaturelessCube)) rfalse;
               if (second notin player)
                   &quot;Writing on a cube is such a fiddly process that
                   you need to be holding it in your hand first.&quot;;
               if (burin notin player)
                   &quot;You would need some powerful implement for that.&quot;;
               second.text_length = WordLength(self.the_naming_word);
               if (second.text_length &gt; 16) second.text_length = 16;
               for (i=0: i&lt;second.text_length: i++)
                   second.&amp;text_written_on-&gt;i
                       = WordAddress(self.the_naming_word)-&gt;i;
               second.article=&quot;the&quot;;
               &quot;It is now called &quot;, (the) second, &quot;.&quot;;
       ];
</pre>

<p class="normal">And this needs just a little grammar, to define 
the &#8220;write &#8230; on &#8230;&#8221; command:</p>

<p class="lynxonly"></p>
<pre>
[ AnyWord; burin.the_naming_word=wn++; return burin; ];
[ WriteOnSub; &quot;Casual graffiti is beneath an enchanter's dignity.&quot;; ];
Verb 'write' 'scribe'
    * AnyWord 'on' held -&gt; WriteOn
    * AnyWord 'on' noun -&gt; WriteOn;
</pre>

<p class="normal"><code>AnyWord</code> is a simple example of a general 
parsing routine (see <a href="s31.html">&#167;31</a>) which accepts any
single word, recording its position in what the player typed and telling 
the parser that it refers to the burin object. Thus, text like &#8220;write 
pdl on cube&#8221; is parsed into the action <code>&lt;WriteOn burin 
cube&gt;</code> while <code>burin.the_naming_word</code> is set to 2.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans80" name="ans80"></a>
<ul><li>80 (p. <a href="s29.html#ex80">214</a>) &nbsp;
This is a little more subtle than first appears, because while the 
warning must be printed only once, the rule allowing &#8220;cherubs&#8221; 
to be recognised might need to be applied many times during the same 
turn &#8211; for instance, if the player types &#8220;get cherubs&#8221; 
where there are twelve plaster cherubs, the rule must allow &#8220;cherubs&#8221; 
twelve times over.</li></ul>

<p class="lynxonly"></p>
<pre>
Global cherubim_warning_turn = -1;
Class Cherub
 with parse_name [ n w this_word_ok;
          for (::) {
              w = NextWord();
              this_word_ok = false;
              if (WordInProperty(w, self, name)) this_word_ok = true;
              switch (w) {
                  'cherub': this_word_ok = true;
                  'cherubim': parser_action = ##PluralFound;
                      this_word_ok = true;
                  'cherubs':
                      if (cherubim_warning_turn == -1) {
                          cherubim_warning_turn = turns;
                          print &quot;(I'll let this go once, but the
                              plural of cherub is cherubim.)^&quot;;
                      }
                      if (cherubim_warning_turn == turns) {
                          this_word_ok = true;
                          parser_action = ##PluralFound;
                      }
              }
              if (this_word_ok == false) return n;
              n++;
          }
      ];
</pre>

<p class="normal">Then again, Shakespeare wrote &#8220;cherubins&#8221; 
(in &#8216;Twelfth Night&#8217;), so who are we to censure?</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans81" name="ans81"></a>
<ul><li>81 (p. <a href="s30.html#ex81">215</a>) &nbsp;
This makes use of the entry point routine, to meddle directly with the
parsing table produced by the text. (See <a href="s2.html#s2_4">&#167;2.4</a> 
for details of the format of this table.) Note that <code>BeforeParsing</code> 
is called <em>after</em> this table has been constructed.</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; genies_lamp &quot;brass lamp&quot;
  with name 'brass' 'lamp',
       colours_inverted false,
       before [;
           Rub: self.colours_inverted = ~~self.colours_inverted;
               &quot;A genie appears from the lamp, declaring:^^
               ~Mischief is my sole delight:^
               If white means black, black means white!~^^
               She vanishes away with a vulgar wink.&quot;;
       ];
Object -&gt; white_stone &quot;white stone&quot; with name 'white' 'stone';
Object -&gt; black_stone &quot;black stone&quot; with name 'black' 'stone';
...
[ BeforeParsing;
  if (genies_lamp.colours_inverted)
      for (wn = 1 ::)
          switch (NextWordStopped()) {
              'white': parse--&gt;(wn*2-3) = 'black';
              'black': parse--&gt;(wn*2-3) = 'white';
              -1: return;
          }
];
</pre>
</div>

<div class="ans"><a id="ans82" name="ans92"></a>
<ul><li>82 (p. <a href="s30.html#ex82">221</a>) &nbsp;
You can fix this using the <code>PrintVerb</code> entry point routine:</li></ul>

<p class="lynxonly"></p>
<pre>
[ PrintVerb word;
  if (word == 'go.verb') {
      if (go_verb_direction ofclass String) print &quot;go somewhere&quot;;
      else {
          print &quot;go to &quot;,
              (name) real_location.(go_verb_direction.door_dir);
      }
      rtrue;
  }
  rfalse;
];
</pre>
</div>

<div class="ans"><a id="ans83" name="ans83"></a>
<ul><li>83 (p. <a href="s31.html#ex83">225</a>) &nbsp;
The puckish comedy of the footnote was introduced into adventure games 
by &#8216;The Hitchhiker's Guide To The Galaxy&#8217;.&#8224;</li></ul>

<p class="lynxonly"></p>
<pre>
Class Footnote with number 0, text &quot;Text of the note.&quot;;
Footnote coinage
  with text quot;D.G.REG.F.D is inscribed around English coins.&quot;;
...
[ Note f fn;
  if (f.number == 0)
      objectloop (fn ofclass Footnote &amp;&amp; fn ~= f)
          if (fn.number &gt;= f.number)
              f.number = fn.number + 1;
  print &quot;[&quot;, f.number, &quot;]&quot;;
];
[ FootnoteSub fn;
  if (noun &lt;= 0) &quot;Footnotes count upward from 1.&quot;;
  objectloop (fn ofclass Footnote)
      if (fn.number == noun) {
          print &quot;[&quot;, noun, &quot;]. &quot;; fn.text(); return;
      }
  &quot;You haven't seen a footnote with that number.&quot;;
];
Verb meta 'footnote' 'note' * number -&gt; Footnote;
</pre>

<p class="normal">And then you can code, for instance,</p>

<p class="lynxonly"></p>
<pre>
    print &quot;Her claim to the throne is in every pocket &quot;,
        (Note) coinage, &quot;, her portrait in every wallet.&quot;;
</pre>

<hr class="footnotebar">
<p class="aside" style="margin-top:0">&#8224;&nbsp; Not even the present author can bear 
to compare Douglas Adams to Edward Gibbon, so the reader is referred 
to Anthony Grafton's historiography <i>The Footnote: A Curious 
History</i> (1997).</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans84" name="ans84"></a>
<ul><li>84 (p. <a href="s31.html#ex84">228</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ FrenchNumber n;
    switch (NextWord()) {
        'un', 'une': n=1;
        'deux': n=2;
        'trois': n=3;
        'quatre': n=4;
        'cinq': n=5;
        default: return GPR_FAIL;
    }
    parsed_number = n; return GPR_NUMBER;
];
</pre>
</div>

<div class="ans"><a id="ans85" name="ans85"></a>
<ul><li>85 (p. <a href="s31.html#ex85">228</a>) &nbsp;
The token is demonstrated here with a command &#8220;status team&#8221;, 
which lists off the team members and their current locations.</li></ul>

<p class="lynxonly"></p>
<pre>
[ StatusSub; print &quot;is in &quot;, (name) parent(noun), &quot;^&quot;; ];
[ Team x y;
  if (NextWord() ~= 'team') return GPR_FAIL;
  objectloop (y ofclass Adventurer) multiple_object--&gt;(++x) = y;
  multiple_object--&gt;0 = x;
  return GPR_MULTIPLE;
];
Verb 'status' * Team -&gt; Status;
</pre>
</div>

<div class="ans"><a id="ans86" name="ans86"></a>
<ul><li>86 (p. <a href="s31.html#ex86">228</a>) &nbsp;
First we must decide how to store floating-point numbers internally: 
in this case we'll simply store 100<i>x</i> to represent <i>x</i>, 
so that &#8220;5.46&#8221; will be parsed as 546. This means that we 
can't parse numbers larger than 327.6749999 &#8230; but it would be
easy to store numbers differently to make room for larger ones, 
if we needed to.</li></ul>

<p class="lynxonly"></p>
<pre>
[ FloatingPoint i start digits integer fraction stop n;
  integer = TryNumber(wn++);
  if (integer == -1000) return GPR_FAIL;
  switch (NextWordStopped()) {
      THEN1__WD: if (NextWordStopped() == -1) return GPR_FAIL;
          start = WordAddress(wn-1); digits = WordLength(wn-1);
          for (i = 0: i &lt; digits: i++) {
              if (start-&gt;i &lt; '0' || start-&gt;i &gt; '9') return GPR_FAIL;
              if (i&lt;3) fraction = fraction*10 + start-&gt;i - '0';
          }
      'point':
           do {
               digits++;
               switch (NextWordStopped()) {
                   -1: stop = true;
                   'nought', 'oh', 'zero': n = 0;
                   default: n = TryNumber(wn-1);
                       if (n &lt; 0 || n &gt; 9) { wn--; stop = true; }
               }
               if ((~~stop) &amp;&amp; digits &lt;= 3) fraction = fraction*10 + n;
           } until (stop);
           digits--;
           if (digits == 0) return GPR_FAIL;
      -1: ;
      default: wn--;
  }
  for (: digits &lt; 3: digits++) fraction = fraction*10;
  parsed_number = integer*100 + (fraction+5)/10;
  return GPR_NUMBER;
];
</pre>

<p class="normal">Here the local variables <code>integer</code> and 
<code>fraction</code> hold the integer and fractional part of the 
number being parsed, and the last calculation performs the rounding-off 
to the nearest 0.01. Note that <code>NextWord</code> and 
<code>NextWordStopped</code> return a full stop as the constant <code>THEN1__WD</code>, 
since it usually plays the same grammatical role as the word &#8220;then&#8221;: 
&#8220;east then south&#8221; and &#8220;east. south&#8221; are 
understood as meaning the same thing. Further exercise: with a little 
more code, make &#8220;oh point oh one&#8221; also work.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans87" name="ans87"></a>
<ul><li>87 (p. <a href="s31.html#ex87">228</a>) &nbsp;
Again, the first question is how to store the number dialled: in this 
case, into a <code>string</code> array, and we store only the digits, 
stripping out spaces and hyphens. The token is:</li></ul>

<p class="lynxonly"></p>
<pre>
Constant MAX_PHONE_LENGTH = 30;
Array dialled_number -&gt; MAX_PHONE_LENGTH + 1;
[ PhoneNumber at length dialled dialled_already i;
  do {
      if (wn &gt; num_words) jump number_ended;
      at = WordAddress(wn); length = WordLength(wn);
      for (i=0: i&lt;length: i++) {
          switch (at-&gt;i) {
              '0', '1', '2', '3', '4', '5', '6', '7', '8', '9':
                  if (dialled &lt; MAX_PHONE_LENGTH)
                      dialled_number -&gt; (++dialled) = at-&gt;i - '0';
              '-': ;
              default: jump number_ended;
          }
      }
      wn++;
      dialled_already = dialled;
  } until (false);
  .number_ended;
  if (dialled_already == 0) return GPR_FAIL;
  dialled_number-&gt;0 = dialled_already;
  return GPR_PREPOSITION;
];
</pre>

<p class="normal">To demonstrate this in use,</p>

<p class="lynxonly"></p>
<pre>
[ DialPhoneSub i;
  print &quot;You dialled &lt;&quot;;
  for (i=1: i&lt;=dialled_number-&gt;0: i++) print dialled_number-&gt;i;
  &quot;&gt;&quot;;
];
Verb 'dial' * PhoneNumber -&gt; DialPhone;
</pre>
</div>

<div class="ans"><a id="ans88" name="ans88"></a>
<ul><li>88 (p. <a href="s31.html#ex88">228</a>) &nbsp;
The time of day will be returned as a number in the usual Inform time
format, as hours times 60 plus minutes, where the &#8216;hours&#8217; part 
is between 0 and 23. Which gives a value between 0 and 1439: and here 
is a routine to convert an hours value, a minutes value and a dictionary 
word which can be either <code>'am'</code> or <code>'pm'</code> into 
an Inform time.</li></ul>

<p class="lynxonly"></p>
<pre>
Constant TWELVE_HOURS = 720;
[ HoursMinsWordToTime hour minute word x;
  if (hour &gt;= 24) return -1;
  if (minute &gt;= 60) return -1;
  x = hour*60 + minute; if (hour &gt;= 13) return x;
  x = x%TWELVE_HOURS; if (word == 'pm') x = x + TWELVE_HOURS;
  if (word ~= 'am' or 'pm' &amp;&amp; hour == 12) x = x + TWELVE_HOURS;
  return x;
];
</pre>

<p class="normal">For instance, <code>HoursMinsWordToTime(4,20,'pm')</code> 
returns 980, the Inform time value for twenty past four in the afternoon. 
The return value is &#8722;1 if the hours and minutes make no sense. 
Next, because the regular <code>TryNumber</code> library routine only 
recognises textual numbers up to <code>'twenty'</code>, we need a 
modest extension:</p>

<p class="lynxonly"></p>
<pre>
[ ExtendedTryNumber wordnum i j;
  i = wn; wn = wordnum; j = NextWordStopped(); wn = i;
  switch (j) {
      'twenty-one': return 21;
      ...
      'thirty': return 30;
      default: return TryNumber(wordnum);
  }
];
</pre>

<p class="normal">Finally the time of day token itself, which is really 
three separate parsing tokens in a row, trying three possible time 
formats:</p>

<p class="lynxonly"></p>
<pre>
[ TimeOfDay first_word second_word at length flag illegal_char
      offhour hr mn i;
  first_word = NextWordStopped();
  if (first_word == -1) return GPR_FAIL;
  switch (first_word) {
      'midnight': parsed_number = 0; return GPR_NUMBER;
      'midday', 'noon': parsed_number = TWELVE_HOURS;
      return GPR_NUMBER;
  }
  !   Next try the format 12:02
  at = WordAddress(wn-1); length = WordLength(wn-1);
  for (i=0: i&lt;length: i++) {
      switch (at-&gt;i) {
          ':': if (flag == false &amp;&amp; i&gt;0 &amp;&amp; i&lt;length-1) flag = true;
               else illegal_char = true;
          '0', '1', '2', '3', '4', '5', '6', '7', '8', '9': ;
          default: illegal_char = true;
      }
  }
  if (length &lt; 3 || length &gt; 5 || illegal_char) flag = false;
  if (flag) {
      for (i=0: at-&gt;i~=':': i++, hr=hr*10) hr = hr + at-&gt;i - '0';
      hr = hr/10;
      for (i++: i&lt;length: i++, mn=mn*10) mn = mn + at-&gt;i - '0';
      mn = mn/10;
      second_word = NextWordStopped();
      parsed_number = HoursMinsWordToTime(hr, mn, second_word);
      if (parsed_number == -1) return GPR_FAIL;
      if (second_word ~= 'pm' or 'am') wn--;
      return GPR_NUMBER;
  }
  !   Lastly the wordy format
  offhour = -1;
  if (first_word == 'half') offhour = 30;
  if (first_word == 'quarter') offhour = 15;
  if (offhour &lt; 0) offhour = ExtendedTryNumber(wn-1);
  if (offhour &lt; 0 || offhour &gt;= 60) return GPR_FAIL;
  second_word = NextWordStopped();
  switch (second_word) {
      ! &quot;six o'clock&quot;, &quot;six&quot;
      'o^clock', 'am', 'pm', -1:
          hr = offhour; if (hr &gt; 12) return GPR_FAIL;
      ! &quot;quarter to six&quot;, &quot;twenty past midnight&quot;
      'to', 'past':
          mn = offhour; hr = ExtendedTryNumber(wn);
          if (hr &lt;= 0) {
              switch (NextWordStopped()) {
                  'noon', 'midday': hr = 12;
                  'midnight': hr = 0;
                  default: return GPR_FAIL;
              }
          } else wn++;
          if (hr &gt;= 13) return GPR_FAIL;
          if (second_word == 'to') {
              mn = 60-mn; hr--; if (hr&lt;0) hr=23;
          }
          second_word = NextWordStopped();
      ! &quot;six thirty&quot;
      default:
          hr = offhour; mn = ExtendedTryNumber(--wn);
          if (mn &lt; 0 || mn &gt;= 60) return GPR_FAIL;
          wn++; second_word = NextWordStopped();
  }
  parsed_number = HoursMinsWordToTime(hr, mn, second_word);
  if (parsed_number &lt; 0) return GPR_FAIL;
  if (second_word ~= 'pm' or 'am' or 'o^clock') wn--;
  return GPR_NUMBER;
];
</pre>

<p class="normal">True to the spirit of the Inform parser, this will 
also parse oddities like &#8220;quarter thirty o'clock&#8221;, and we 
don't care.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans89" name="ans89"></a>
<ul><li>89 (p. <a href="s31.html#ex89">229</a>) &nbsp;
Here goes: we could implement the buttons with five separate objects,
essentially duplicates of each other. (And by using a class definition, 
this wouldn't look too bad.) But if there were 500 slides this would 
be less reasonable.</li></ul>

<p class="lynxonly"></p>
<pre>
[ ASlide w n;
  if (location ~= Machine_Room) return GPR_FAIL;
  w = NextWord(); if (w == 'the' or 'slide') w = NextWord();
  switch (w) {
      'first', 'one':   n = 1;
      'second', 'two':  n = 2;
      'third', 'three': n = 3;
      'fourth', 'four': n = 4;
      'fifth', 'five':  n = 5;
      default: return GPR_FAIL;
  }
  if (NextWord() ~= 'slide') wn--;
  parsed_number = n;
  return GPR_NUMBER;
];
Array slide_settings --&gt; 5;
[ SetSlideSub;
  slide_settings--&gt;(noun-1) = second;
  &quot;You set slide &quot;, (number) noun, &quot; to the value &quot;, second, &quot;.&quot;;
];
[ XSlideSub;
  &quot;Slide &quot;, (number) noun, &quot; currently stands at &quot;,
  slide_settings--&gt;(noun-1), &quot;.&quot;;
];
Extend 'set' first * ASlide 'to' number -&gt; SetSlide;
Extend 'push' first * ASlide 'to' number -&gt; SetSlide;
Extend 'examine' first * ASlide -&gt; XSlide;
Extend 'look' first * 'at' ASlide -&gt; XSlide;
</pre>
</div>

<div class="ans"><a id="ans90" name="ans90"></a>
<ul><li>90 (p. <a href="s31.html#ex90">229</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Global from_char; Global to_char;
[ QuotedText start_wn;
  start_wn = wn;
  from_char = WordAddress(start_wn);
  if (from_char-&gt;0 ~= '&quot;') return GPR_FAIL;
  from_char++;
  do {
      if (NextWordStopped() == -1) return GPR_FAIL;
      to_char = WordAddress(wn-1) + WordLength(wn-1) - 1;
  } until (to_char &gt;= from_char &amp;&amp; to_char-&gt;0 == '&quot;');
  to_char--;
  return GPR_PREPOSITION;
];
</pre>

<p class="normal">(The code above won't work if the user types <tt>&quot;foo&quot;bar&quot;</tt>, 
though, because <code>&quot;</code> is a word separator to Inform. It 
would be easy enough to compensate for this if we had to.) The text 
is treated as though it were a preposition, and the positions where 
the quoted text starts and finishes are recorded, so that an action 
routine can easily extract the text and use it later.</p>

<p class="lynxonly"></p>
<pre>
[ WriteOnSub i;
  print &quot;You write ~&quot;;
  for (i = from_char: i &lt;= to_char: i++) print (char) i-&gt;0;
  &quot;~ on &quot;, (the) noun, &quot;.&quot;;
];
Verb 'write' * QuotedText 'on' noun -&gt; WriteOn;
</pre>
</div>

<div class="ans"><a id="ans91" name="ans91"></a>
<ul><li>91 (p. <a href="s31.html#ex91">229</a>) &nbsp;
(See the <code>NounDomain</code> specification in 
<a href="sa3.html">&#167;A3</a>.) This routine passes on any
<code>GPR_REPARSE</code> request, as it must, but keeps a matched object 
in its own <code>third</code> variable, returning the &#8216;skip this 
text&#8217; code to the parser. Thus the parser never sees any third
parameter.</li></ul>

<p class="lynxonly"></p>
<pre>
Global third;
[ ThirdNoun x;
  x = ParseToken(ELEMENTARY_TT, NOUN_TOKEN);
  if (x == GPR_FAIL or GPR_REPARSE) return x;
  third = x; return GPR_PREPOSITION;
];
</pre>

<p class="normal">The values <code>GPR_MULTIPLE</code> and 
<code>GPR_NUMBER</code> can't be returned, since a 
<span class="grammartoken"><code>noun</code></span> token &#8211; which 
is what the call to <code>ParseToken</code> asked for &#8211; 
cannot result in them.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans92" name="ans92"></a>
<ul><li>92 (p. <a href="s31.html#ex92">229</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ InformNumberToken n wa wl sign base digit digit_count;
  wa = WordAddress(wn);
  wl = WordLength(wn); sign = 1; base = 10; digit_count = 0;
  if (wa-&gt;0 ~= '-' or '$' or '0' or '1' or '2' or '3' or '4'
                          or '5' or '6' or '7' or '8' or '9')
      return GPR_FAIL;
  if (wa-&gt;0 == '-') { sign = -1; wl--; wa++; }
  else {
      if (wa-&gt;0 == '$') { base = 16; wl--; wa++; }
      if (wa-&gt;0 == '$') { base = 2; wl--; wa++; }
  }
  if (wl == 0) return GPR_FAIL;
  n = 0;
  while (wl &gt; 0) {
      if (wa-&gt;0 &gt;= 'a') digit = wa-&gt;0 - 'a' + 10;
      else digit = wa-&gt;0 - '0';
      digit_count++;
      switch (base) {
          2: if (digit_count == 17) return GPR_FAIL;
         10: if (digit_count == 6) return GPR_FAIL;
             if (digit_count == 5) {
                 if (n &gt; 3276) return GPR_FAIL;
                 if (n == 3276) {
                     if (sign == 1 &amp;&amp; digit &gt; 7) return GPR_FAIL;
                     if (sign == -1 &amp;&amp; digit &gt; 8) return GPR_FAIL;
                 }
             }
         16: if (digit_count == 5) return GPR_FAIL;
      }
      if (digit &gt;= 0 &amp;&amp; digit &lt; base) n = base*n + digit;
      else return GPR_FAIL;
      wl--; wa++;
  }
  parsed_number = n*sign; wn++; return GPR_NUMBER;
];
</pre>
</div>

<div class="ans"><a id="ans93" name="ans93"></a>
<ul><li>93 (p. <a href="s31.html#ex93">229</a>) &nbsp;
Add the following, as the opening lines of the <code>InformNumberToken</code>
routine, which also needs a new local variable <code>w</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
  w = NextWordStopped(); if (w == -1) return GPR_FAIL;
  switch (w) {
      'true':    parsed_number = true; return GPR_NUMBER;
      'false':   parsed_number = false; return GPR_NUMBER;
      'nothing': parsed_number = nothing; return GPR_NUMBER;
      'null':    parsed_number = NULL; return GPR_NUMBER;
  }
  wn--;
</pre>
</div>

<div class="ans"><a id="ans94" name="ans94"></a>
<ul><li>94 (p. <a href="s31.html#ex94">229</a>) &nbsp;
Insert the following just after <code>wa</code> and <code>wl</code> 
have been set:</li></ul>

<p class="lynxonly"></p>
<pre>
  if (wl == 3 &amp;&amp; wa-&gt;0 == ''' &amp;&amp; wa-&gt;2 == ''') {
      parsed_number = wa-&gt;1; wn++; return GPR_NUMBER;
  }
</pre>
</div>

<div class="ans"><a id="ans95" name="ans95"></a>
<ul><li>95 (p. <a href="s31.html#ex95">229</a>) &nbsp;
First a tricky little routine which takes as its arguments a printing
rule <code>Rule</code> and a value <code>v</code>, and compares 
the current word against the text that would result from the statement 
<code>print (Rule) v;</code> (assuming that this does not exceed 
126 characters). Not only that, but lower and upper case letters are 
allowed to match each other. The routine either sets <code>parsed_number</code> 
to <code>v</code> and returns <code>true</code>, if there's a match,
or returns <code>false</code> if there isn't.</li></ul>

<p class="lynxonly"></p>
<pre>
Array tolowercase -&gt; 256;
Array attr_text -&gt; 128;
[ TestPrintedText Rule value j k at length f addto;
  if (tolowercase-&gt;255 == 0) {
      for (j=0: j&lt;256: j++) tolowercase-&gt;j = j;
      for (j='A',k='a': j&lt;='Z': j++,k++) tolowercase-&gt;j = k;
  }
  attr_text--&gt;0 = 62; 
  @output_stream 3 attr_text;
  Rule(value);
  @output_stream -3;
  k = attr_text--&gt;0; addto = 0;
  at = WordAddress(wn);
  length = WordLength(wn);
  if (Rule == DebugAttribute &amp;&amp; at-&gt;0 == '~') {
      length--; at++; addto = 100;
  }
  if (k == length) {
      f = true;
      for (j=0: j&lt;k: j++)
          if (tolowercase-&gt;(attr_text-&gt;(j+2)) ~= at-&gt;j)
              f = false;
      if (f) { parsed_number = value + addto; rtrue; }
  }
  rfalse;
];
</pre>

<p class="normal">Note that the special rule about <code>~</code> (which 
adds 100 to the value in <code>parsed_number</code>) is set up only 
to apply if attributes are being looked at. Now simply add the lines:</p>

<p class="lynxonly"></p>
<pre>
for (n=0: n&lt;48: n++)
    if (TestPrintedText(DebugAttribute, n)) {
        wn++; return GPR_NUMBER;
    }
</pre>

<p class="normal">as the first lines of <code>InformNumberToken</code>. 
The routine <code>DebugAttribute</code> is only present if the game 
has been compiled with Debug mode on, but it seems very unlikely 
that the above code would be needed except for debugging anyway.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans96" name="ans96"></a>
<ul><li>96 (p. <a href="s31.html#ex96">229</a>) &nbsp;
Properties are numbered from 1 (which is always <code>name</code>) up 
to some highest one, <code>P</code>, and the trickiest thing in answering 
this exercise is to find out what <code>P</code> is. One devious way 
would be to define the following object right at the very end of your
source code:</li></ul>

<p class="lynxonly"></p>
<pre>Object with zwissler;</pre>

<p class="normal">Being the final new property to be created, the value 
of <code>zwissler</code> (named after A. M. F. Zwissler, the last person 
in the Oxford and District telephone directory for 1998) will be <code>P</code>. 
A tidier approach is to have read, or if possible written, the <i>Inform 
Technical Manual</i>, which reveals that the value 
<code>#identifiers_table--&gt;0</code> is exactly <code>P+1</code>. 
Anyway, the actual parsing is quite like the corresponding case for 
attributes. Define a suitable printing rule:</p>

<p class="lynxonly"></p>
<pre>[ PrintProperty n; print (property) n; ];</pre>

<p class="normal">and then add the next round of comparisons to 
<code>InformNumberToken</code>:</p>

<p class="lynxonly"></p>
<pre>
for (n=1: n&lt;#identifiers_table--&gt;0: n++)
    if (TestPrintedText(PrintProperty, n)) { wn++; return GPR_NUMBER; }
</pre>

<p class="normal">This and the preceding five exercises, put together, 
are most of the way to a token which would parse any Inform expression.
For a full definition of this, see the 
<span class="grammartoken"><code>InfixRvalueTerm</code></span> token 
in the Infix debugger's library file <tt>&quot;Infix.h&quot;</tt>. 
(&#8220;Rvalue&#8221; is compiler slang for a value which can appear 
on the right-hand side of an <code>=</code> assignment.)</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans97" name="ans97"></a>
<ul><li>97 (p. <a href="s32.html#ex97">232</a>) &nbsp;
(Note that when a game is compiled with Debug mode, it already has
this verb provided.) The following is slightly more useful than what the 
exercise asked for: it omits to mention the compass directions, making 
the output much less verbose. (The reason it does so is that compass 
directions are, for efficiency reasons, only in scope when the current 
reason for scope checking is <code>PARSING_REASON</code>, whereas because
<code>ScopeSub</code> carries out a <code>LoopOverScope</code> the 
reason here will be <code>LOOPOVERSCOPE_REASON</code>.)</li></ul>

<p class="lynxonly"></p>
<pre>
Global scope_count;
[ PrintIt obj;
  print_ret ++scope_count, &quot;: &quot;, (a) obj, &quot; (&quot;, obj, &quot;)&quot;;
];
[ ScopeSub; 
  scope_count = 0; LoopOverScope(PrintIt);
  if (scope_count == 0) &quot;Nothing is in scope.&quot;;
];
Verb meta 'scope' * -&gt; Scope;
</pre>

<p class="normal">Under normal circumstances, &#8220;Nothing is in scope&#8221; 
will never be printed, as &#8211; at the very least &#8211; an actor is 
always in scope to himself, but since it's possible for designers to
alter the definition of scope, this routine has been written to be cautious.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans98" name="ans98"></a>
<ul><li>98 (p. <a href="s32.html#ex98">232</a>) &nbsp;
As in the previous answer, the compass directions do not appear in the
loop over scope, which neatly excludes walls, floor and ceiling:</li></ul>

<p class="lynxonly"></p>
<pre>
[ MegaExam obj; print &quot;^&quot;, (a) obj, &quot;: &quot;; &lt;Examine obj&gt;; ];
[ MegaLookSub; &lt;Look&gt;; LoopOverScope(MegaExam); ];
Verb meta 'megalook' * -&gt; MegaLook;
</pre>
</div>

<div class="ans"><a id="ans99" name="ans99"></a>
<ul><li>99 (p. <a href="s32.html#ex99">234</a>) &nbsp;
A slight refinement of such a &#8220;purloin&#8221; verb is already 
defined in the library (if the constant <code>DEBUG</code> is defined), 
so there's no need. But here's how it could be done:</li></ul>

<p class="lynxonly"></p>
<pre>
[ Anything i;
  if (scope_stage == 1) rfalse;
  if (scope_stage == 2) {
      objectloop (i ofclass Object) PlaceInScope(i); rtrue;
  }
  &quot;No such in game.&quot;;
];
</pre>

<p class="normal">(This disallows multiple matches for efficiency reasons 
&#8211; the parser has enough work to do with such a huge scope definition 
as it is.) Now the token <span class="grammartoken"><code>scope=Anything</code></span> 
will match anything at all, even things like the abstract concept of 
&#8216;east&#8217;. The restriction to <code>i ofclass Object</code> 
excludes picking up classes.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans100" name="ans100"></a>
<ul><li>100 (p. <a href="s32.html#ex100">235</a>) &nbsp;
For brevity, the following solution assumes that both sides of the window 
are lit, and that any objects with descriptions as separate paragraphs 
(for instance the <code>initial</code> descriptions for objects not 
yet moved) already describe clearly which side of the window they 
are on. We are only worrying about the piles of items in the &#8220;You 
can also see...&#8221; part of the room description. Note the sneaky 
way looking through the window is implemented, and that the &#8216;on 
the other side&#8217; part of the room description isn't printed in 
that case.</li></ul>

<p class="lynxonly"></p>
<pre>
Global just_looking_through;
Class Window_Room
  with description
           &quot;This is one end of a long east/west room.&quot;,
       before [;
           Examine, Search: ;
           default:
             if (inp1 ~= 1 &amp;&amp; noun ~= 0 &amp;&amp; noun in self.far_side)
                 print_ret (The) noun, &quot; is on the far side of
                     the glass.&quot;;
             if (inp2 ~= 1 &amp;&amp; second ~= 0 &amp;&amp; second in self.far_side)
                 print_ret (The) second, &quot; is on the far side of
                     the glass.&quot;;
       ],
       after [;
           Look:
             if (just_looking_through) rfalse;
             print &quot;^The room is divided by a great glass window,
                 stretching from floor to ceiling.^&quot;;
             if (Locale(location.far_side,
                        &quot;Beyond the glass you can see&quot;,
                        &quot;Beyond the glass you can also see&quot;)) &quot;.&quot;;
       ],
  has  light;
Window_Room window_w &quot;West of Window&quot;
  with far_side window_e;
Window_Room window_e &quot;East of Window&quot;
  with far_side window_w;
Object &quot;great glass window&quot;
  with name 'great' 'glass' 'window',
       before [ place;
           Examine, Search: place = location;
               just_looking_through = true;
               PlayerTo(place.far_side,1); &lt;Look&gt;; PlayerTo(place,1);
               just_looking_through = false;
               give place.far_side ~visited; rtrue;
       ],
       found_in window_w window_e,
  has  scenery;
</pre>

<p class="normal">A few words about <code>inp1</code> and <code>inp2</code> 
are in order. <code>noun</code> and <code>second</code> can hold either 
objects or numbers, and it's sometimes useful to know which. <code>inp1</code> 
is equal to <code>noun</code> if that's an object, or 1 if that's a 
number; likewise for <code>inp2</code> and <code>second</code>. (In this 
case we're just being careful that the action <code>SetTo eggtimer 35</code> 
wouldn't be stopped if object 35 happened to be on the other side of 
the glass.) We also need:</p>

<p class="lynxonly"></p>
<pre>
[ InScope actor;
  if (parent(actor) ofclass Window_Room)
      ScopeWithin(parent(actor).far_side);
  rfalse;
];
</pre>
</div>

<div class="ans"><a id="ans101" name="ans101"></a>
<ul><li>101 (p. <a href="s32.html#ex101">235</a>) &nbsp;
For good measure, we'll combine this with the previous rule about 
<code>moved</code> objects being in scope in the dark:</li></ul>

<p class="lynxonly"></p>
<pre>
Object Dark_Room &quot;Dark Room&quot;
  with description &quot;A disused broom cupboard.&quot;;
Object -&gt; light_switch &quot;light switch&quot;
  with name 'light' 'switch',
       player_knows,
       initial &quot;On one wall is the light switch.&quot;,
       after [;
           SwitchOn: give Dark_Room light;
           SwitchOff: give Dark_Room ~light;
       ],
  has  switchable static;
Object -&gt; diamond &quot;shiny diamond&quot;
  with name 'shiny' 'diamond'
  has  scored;
Object -&gt; dwarf &quot;dwarf&quot;
  with name 'voice' 'dwarf' 'breathing',
       life [;
           Order:
               if (action == ##SwitchOn &amp;&amp; noun == light_switch) {
                   give Dark_Room light;
                   light_switch.player_knows = true;
                   StopDaemon(self);
                   if (light_switch has on) &quot;~Typical human.~&quot;;
                   give light_switch on; &quot;~Right you are, squire.~&quot;;
               }
       ],
       daemon [;
           if (location == thedark &amp;&amp; real_location == Dark_Room)
               &quot;^You hear the breathing of a dwarf.&quot;;
       ],
  has  animate;
[ InScope person i;
  if (person in Dark_Room)
      if (person == dwarf || light_switch.player_knows)
          PlaceInScope(light_switch);
  if (person == player &amp;&amp; location == thedark)
      objectloop (i in parent(player))
          if (i has moved || i==dwarf)
              PlaceInScope(i);
  rfalse;
];
</pre>

<p class="normal">And in the game's <code>Initialise</code> routine, 
call <code>StartDaemon(dwarf)</code> to get respiration under way. Note 
that the routine puts the light switch in scope for the dwarf &#8211; 
if it didn't, the dwarf would not be able to understand &#8220;dwarf, 
turn light on&#8221;, and that was the whole point. Note also that the 
dwarf can't hear the player in darkness, no doubt because of all the 
heavy breathing.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans102" name="ans102"></a>
<ul><li>102 (p. <a href="s32.html#ex102">236</a>) &nbsp;
In the <code>Initialise</code> routine, move <code>newplayer</code> 
somewhere and <code>ChangePlayer</code> to it, where:</li></ul>

<p class="lynxonly"></p>
<pre>
Object newplayer &quot;yourself&quot;
  with description &quot;As good-looking as ever.&quot;,
       add_to_scope nose,
       capacity 5,
       orders [;
           Inv: if (nose.being_held)
                   print &quot;You're holding your nose. &quot;;
           Smell: if (nose.being_held)
                   &quot;You can't smell a thing with your nose held.&quot;;
       ],
  has  concealed animate proper transparent;
Object nose &quot;nose&quot;
  with name 'nose', article &quot;your&quot;,
       being_held,
       before [ possessed nonclothing;
           Take: if (self.being_held)
                   &quot;You're already holding your nose.&quot;;
               objectloop (possessed in player)
                   if (possessed hasnt worn) nonclothing++;
               if (nonclothing &gt; 1) &quot;You haven't a free hand.&quot;;
               self.being_held = true; player.capacity = 1;
               &quot;You hold your nose with your spare hand.&quot;;
           Drop: if (~~(self.being_held))
                   &quot;But you weren't holding it!&quot;;
               self.being_held = false; player.capacity = 5;
               print &quot;You release your nose and inhale again. &quot;;
               &lt;&lt;Smell&gt;&gt;;
       ],
  has  scenery;
</pre>
</div>

<div class="ans"><a id="ans103" name="ans103"></a>
<ul><li>103 (p. <a href="s32.html#ex103">236</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Object steriliser &quot;sterilising machine&quot;
  with name 'washing' 'sterilising' 'machine',
       add_to_scope top_of_wm go_button,
       before [;
           PushDir: AllowPushDir(); rtrue;
           Receive:
               if (receive_action == ##PutOn)
                   &lt;&lt;PutOn noun top_of_wm&gt;&gt;;
           SwitchOn: &lt;&lt;Push go_button&gt;&gt;;
       ],
       after [;
           PushDir: &quot;It's hard work, but the steriliser does roll.&quot;;
       ],
       initial [;
           print &quot;There is a sterilising machine on casters here
               (a kind of chemist's washing machine) with a ~go~
               button. &quot;;
           if (children(top_of_wm) &gt; 0) {
               print &quot;On top&quot;;
               WriteListFrom(child(top_of_wm),
                   ISARE_BIT + ENGLISH_BIT);
               print &quot;. &quot;;
           }
           if (children(self) &gt; 0) {
               print &quot;Inside&quot;;
               WriteListFrom(child(self), ISARE_BIT + ENGLISH_BIT);
               print &quot;. &quot;;
           }
           print &quot;^&quot;;
       ],
  has  static container open openable;
Object top_of_wm &quot;top of the sterilising machine&quot;,
  with article &quot;the&quot;,
  has  static supporter;
Object go_button &quot;~go~ button&quot;
  with name 'go' 'button',
       before [; Push, SwitchOn: &quot;The power is off.&quot;; ],
  has  static;
</pre>
</div>

<div class="ans"><a id="ans104" name="ans104"></a>
<ul><li>104 (p. <a href="s32.html#ex104">236</a>) &nbsp;
The label object itself is not too bad:</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; label &quot;red sticky label&quot;
  with name 'red' 'sticky' 'label',
       stuck_onto nothing,
       unstick [;
           print &quot;(first removing the label from &quot;,
               (the) self.stuck_onto, &quot;)^&quot;;
           self.stuck_onto = nothing;
           move self to player;
       ],
       saystuck [;
           print &quot;^The red sticky label is stuck to &quot;,
               (the) self.stuck_onto, &quot;.^&quot;;
       ],
       before [;
           Take, Remove:
               if (self.stuck_onto) {
                   self.unstick(); &quot;Taken.&quot;;
               }
           PutOn, Insert:
               if (second == self.stuck_onto)
                   &quot;It's already stuck there.&quot;;
               if (self.stuck_onto) self.unstick();
               if (second == self) &quot;That would only make a red mess.&quot;;
               self.stuck_onto = second; remove self;
               &quot;You affix the label to &quot;, (the) second, &quot;.&quot;;
       ],
       react_before [;
           Examine: if (self.stuck_onto == noun) self.saystuck();
       ],
       react_after [ x;
           x = self.stuck_onto; if (x == nothing) rfalse;
           Look: if (IndirectlyContains(location, x) &amp;&amp;
                     ~~IndirectlyContains(player, x)) self.saystuck();
           Inv:  if (IndirectlyContains(player, x)) self.saystuck();
       ],
       each_turn [;
           if (parent(self)) self.stuck_onto = nothing;
       ];
</pre>

<p class="normal">Note that <code>label.stuck_onto</code> holds the 
object the label is stuck to, or <code>nothing</code> if it's unstuck: 
and that when it is stuck, it is removed from the object tree. 
It therefore has to be moved into scope, so we need the rule: if the 
labelled object is in scope, then so is the label.</p>

<p class="lynxonly"></p>
<pre>
Global disable_self = false;
[ InScope actor i1 i2;
  if (disable_self || label.stuck_onto == nothing) rfalse;
  disable_self = true;
  i1 = TestScope(label, actor);
  i2 = TestScope(label.stuck_onto, actor);
  disable_self = false;
  if (i1 ~= 0) rfalse;
  if (i2 ~= 0) PlaceInScope(label);
  rfalse;
];
</pre>

<p class="normal">This routine has two interesting points: firstly, it 
disables itself while testing scope (since otherwise the game would 
go into an endless recursion), and secondly it only puts the label 
in scope if it isn't already there. This is just a safety precaution 
to prevent the label reacting twice to actions, and isn't really necessary 
since the label can't already be in scope, but is included for the 
sake of example.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans105" name="ans105"></a>
<ul><li>105 (p. <a href="s33.html#ex105">239</a>) &nbsp;
Firstly, create a class <code>Key</code> of which all the keys in the 
game are members. Then:</li></ul>

<p class="lynxonly"></p>
<pre>
Global assumed_key;
[ DefaultLockSub;
  print &quot;(with &quot;, (the) assumed_key, &quot;)^&quot;; &lt;&lt;Lock noun assumed_key&gt;&gt;;
];
[ DefaultLockTest i count;
  if (noun hasnt lockable) rfalse;
  objectloop (i in player &amp;&amp; i ofclass Key) {
      count++; assumed_key = i;
  }
  if (count == 1) rtrue; rfalse;
];
Extend 'lock' first * noun=DefaultLockTest -&gt; DefaultLock;
</pre>

<p class="normal">(and similar code for &#8220;unlock&#8221;). Note 
that &#8220;lock strongbox&#8221; is matched by this new grammar 
line only if the player only has one key: the <code>&lt;DefaultLock strongbox&gt;</code> 
action is generated: which is converted to, say, <code>&lt;Lock 
strongbox brass_key&gt;</code>.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans106" name="ans106"></a>
<ul><li>106 (p. <a href="s33.html#ex106">240</a>) &nbsp;
A neat combination of the two entry points described in this section:</li></ul>

<p class="lynxonly"></p>
<pre>
[ ChooseObjects obj code;
  obj = obj; ! To stop Inform pointing out that obj was unused
  if (code == 1) {
      ! If the parser wants to include this object in an &quot;all&quot;
      ! in a faintly lit room, force it to be excluded:
      if (action_to_be == ##Take or ##Remove
          &amp;&amp; location ofclass FaintlyLitRoom) return 2;
  }
  return 0; ! Carry on, applying normal parser rules
];
</pre>

<p class="normal">Since that excludes everything from an &#8220;all&#8221;, 
the result will be the error message &#8220;Nothing to do!&#8221;. As 
this is not very descriptive:</p>

<p class="lynxonly"></p>
<pre>
[ ParserError error_code;
  if (error_code == NOTHING_PE)
      ! The error message printed if an &quot;all&quot; turned out empty
      if (action_to_be == ##Take or ##Remove
          &amp;&amp; location ofclass FaintlyLitRoom)
         &quot;In this faint light, it's not so easy.&quot;;
  rfalse; ! Print standard parser error message
];
</pre>

<p class="normal">All this makes a room so dark that even carrying 
a lamp will not illuminate it fully. If this is undesirable, add the 
following to the start of <code>ChooseObjects</code>:</p>

<p class="lynxonly"></p>
<pre>
objectloop (whatever in location)
    if (HasLightSource(whatever)) return 0;
</pre>
</div>

<h3>Exercises in Chapter V</h3>

<div class="ans"><a id="ans107" name="ans107"></a>
<ul><li>107 (p. <a href="s35.html#ans107">255</a>) &nbsp;
After checking for any irregular forms, which take precedence, the
dative routine looks to see if the last letter is &#8220;e&#8221;, as 
in this case it is, and then checks to see if the first six, 
&#8220;cyning&#8221;, form a word in the dictionary:</li></ul>

<p class="lynxonly"></p>
<pre>
Object -&gt; &quot;searo&quot;
  with name 'searo', dativename 'searwe';
Object -&gt; &quot;Cyning&quot;
  with name 'cyning';
[ dative obj word a l;
  ! Irregular dative endings
  if (obj provides dativename)
      return WordInProperty(word, obj, dativename);
  ! Regular dative endings
  a = WordAddress(wn-1);
  l = WordLength(wn-1);
  if (l &gt;= 2 &amp;&amp; a-&gt;(l-1) == 'e') {
      word = DictionaryLookup(a, l-1);
      if (WordInProperty(word, obj, name)) rtrue;
  }
  rfalse;
];
[ dativenoun;
  if (NextWord() == 'to') return ParseToken(ELEMENTARY_TT, NOUN_TOKEN);
  wn--;
  parser_inflection = dative;
  return ParseToken(ELEMENTARY_TT, NOUN_TOKEN);
];
</pre>

<p class="normal">The upshot is that the game designer only has to 
give names in the <code>dativename</code> property if they are irregular.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans108" name="ans108"></a>
<ul><li>108 (p. <a href="s35.html#ex108">255</a>) &nbsp;
The easiest way is to further elaborate <code>dativenoun</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
[ dativenoun it;
  switch (NextWord()) {
      'toit': it = PronounValue('it');
          if (it == NULL) return GPR_FAIL;
          if (TestScope(it, actor)) return it;
          return GPR_FAIL;
      'to': ;
      default: wn--; parser_inflection = dative;
  }
  return ParseToken(ELEMENTARY_TT, NOUN_TOKEN);
];
</pre>

<p class="normal">Note that it isn't safe to always allow &#8220;it&#8221; 
to be referred to, as &#8220;it&#8221; might be an object in another 
room and now out of scope. (We might want to use <code>ParserError</code> 
to give a better error message in this case, since at the moment we'll 
just get the generic &#8220;I didn't understand that sentence&#8221; 
message.) Another possible way for a pronoun to fail is if it remains 
unset. In the case of English &#8220;it&#8221;, this is unlikely, but 
a pronoun applying only to &#8220;a group of two or more women&#8221; 
might well remain unset for hundreds of turns.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans109" name="ans109"></a>
<ul><li>109 (p. <a href="s35.html#ex109">255</a>) &nbsp;
Actually one simple solution avoids fussing with tokens altogether and
just adds all the possible variant forms to the names of the objects:</li></ul>

<p class="lynxonly"></p>
<pre>
Object ... with name 'brun' 'bruna' 'hund' 'hunden';
Object ... with name 'brunt' 'bruna' 'hus' 'huset';
</pre>

<p class="normal">A better way is to switch between two different inflections, 
one for indefinite and the other for definite noun phrases. The catch 
is that until you start parsing, you don't know whether it will be 
definite or not. But you can always take a quick look ahead:</p>

<p class="lynxonly"></p>
<pre>
[ swedishnoun;
  parser_inflection = swedish_indefinite_form;
  if (NextWord() == 'den' or 'det')
      parser_inflection = swedish_definite_form;
  else wn--;
  return ParseToken(ELEMENTARY_TT, NOUN_TOKEN);
];
</pre>

<p class="normal">Now either write</p>

<p class="lynxonly"></p>
<pre>
Object ... with swedish_indefinite_form 'brun' 'hund',
    swedish_definite_form 'bruna' 'hunden';
</pre>

<p class="normal">or else <code>swedish_definite_form</code> and 
<code>swedish_indefinite_form</code> routines to work out the required 
forms automatically. (Still another way is to rewrite all indefinite 
forms as definite within <code>LanguageToInformese</code>.)</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans110" name="ans110"></a>
<ul><li>110 (p. <a href="s36.html#ex110">268</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ LanguageToInformese x;
  ! Insert a space before each hyphen and after each apostrophe.
  for (x=2: x&lt;2+buffer-&gt;1: x++) {
      if (buffer-&gt;x == '-') LTI_Insert(x++, ' ');
      if (buffer-&gt;x == ''') LTI_Insert(++x, ' ');
  }
  #ifdef DEBUG;
  if (parser_trace &gt;= 1) {
      print &quot;[ After LTI: '&quot;;
      for (x=2: x&lt;2+buffer-&gt;1: x++) print (char) buffer-&gt;x;
      print &quot;']^&quot;;
  }
  #endif;
];
</pre>
</div>

<div class="ans"><a id="ans111" name="ans111"></a>
<ul><li>111 (p. <a href="s36.html#ex111">268</a>) &nbsp;
Insert the following code:</li></ul>

<p class="lynxonly"></p>
<pre>
for (x=1: x&lt;=parse-&gt;1: x++) {
    wn = x; word = NextWord();
    at = WordAddress(x);
    if (word == 'dessus') {
      LTI_Insert(at - buffer, ' ');
      buffer-&gt;at     = 's'; buffer-&gt;(at+1) = 'u'; buffer-&gt;(at+2) = 'r';
      buffer-&gt;(at+3) = ' '; buffer-&gt;(at+4) = 'l'; buffer-&gt;(at+5) = 'u';
      buffer-&gt;(at+6) = 'i';
      break;
    }
    if (word == 'dedans') {
      LTI_Insert(at - buffer, ' ');
      LTI_Insert(at - buffer, ' ');
      buffer-&gt;at     = 'd'; buffer-&gt;(at+1) = 'a'; buffer-&gt;(at+2) = 'n';
      buffer-&gt;(at+3) = 's'; buffer-&gt;(at+4) = ' '; buffer-&gt;(at+5) = 'l';
      buffer-&gt;(at+6) = 'u'; buffer-&gt;(at+7) = 'i';
      break;
    }
}
</pre>

<p class="normal">Actually, this assumes that only one of the two words 
will be used, and only once in the command. Which is almost certainly 
good enough, but if not we could replace both occurrences of <code>break</code> 
with the code:</p>

<p class="lynxonly"></p>
<pre>
      @tokenise buffer parse;
      x = 0; continue;
</pre>

<p class="normal">so catching even multiple usages.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans112" name="ans112"></a>
<ul><li>112 (p. <a href="s36.html#ex112">268</a>) &nbsp;
(This solution by Gareth Rees.)</li></ul>

<p class="lynxonly"></p>
<pre>
[ LTI_Shift from chars i
  start   ! Where in buffer to start copying (inclusive)
  end     ! Where in buffer to stop copying (exclusive)
  dir;    ! Direction to move (1 for left, -1 for right)
  if (chars &lt; 0) {
      start = from; end = buffer-&gt;1 + chars + 3; dir = 1;
      if (end &lt;= start) return;
      buffer-&gt;1 = buffer-&gt;1 + chars;
  } else {
      start = buffer-&gt;1 + chars + 2; end = from + chars - 1; dir = -1;
      if (start &lt;= end) return;
      if (start &gt; buffer-&gt;0 + 2) start = buffer-&gt;0 + 2;
      buffer-&gt;1 = start - 2;
  }
  for (i=start: i~=end: i=i+dir) buffer-&gt;i = buffer-&gt;(i - chars);
];
</pre>
</div>

<div class="ans"><a id="ans113" name="ans113"></a>
<ul><li>113 (p. <a href="s36.html#ex113">268</a>) &nbsp;
The &#8220;beware&#8221; part is handled by never breaking any word 
which is already within the dictionary, together with only allowing 
&#8220;da&#8221; and &#8220;dar&#8221; to be broken away from a dictionary 
word. Thus no break occurs in &#8220;davon&#8221; if there's a person 
in the game called &#8220;Davon&#8221;, while no break occurs in 
&#8220;dartmouth&#8221; because there's no word &#8220;tmouth&#8221; 
in the dictionary.</li></ul>

<p class="lynxonly"></p>
<pre>
[ LanguageToInformese x c word at len;
  for (x=0: x&lt;parse-&gt;1: x++) {
      word = parse--&gt;(x*2 + 1);
      len = arse-&gt;(x*4 + 4);
      at = parse-&gt;(x*4 + 5);
      if (word == 0 &amp;&amp; buffer-&gt;at == 'd' &amp;&amp; buffer-&gt;(at+1) == 'a') {
          c = 2; if (buffer-&gt;(at+2) == 'r') c = 3;
          ! Is the rest of the word, after &quot;da&quot; or &quot;dar&quot;, in dict?
          if (DictionaryLookup(buffer+at+c, len-c)) {
              buffer-&gt;at = ' '; buffer-&gt;(at+1) = ' ';
              if (c == 3) buffer-&gt;(at+2) = ' ';
              LTI_Insert(at+len, 's');
              LTI_Insert(at+len, 'e');
              LTI_Insert(at+len, ' ');
              break;
          }
      }
  }
];
</pre>

<p class="normal">Note that the text &#8220; es&#8221; is appended by 
inserting &#8216;s&#8217;, then &#8216;e&#8217;, then a space. The 
routine will only make one amendment on the input line, but then 
only one such preposition is likely to occur on any input line, so 
that's all right then.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans114" name="ans114"></a>
<ul><li>114 (p. <a href="s37.html#ex114">270</a>) &nbsp;
Most of the work goes into the printing rule for GNAs:</li></ul>

<p class="lynxonly"></p>
<pre>
[ GNA g;
  g = GetGNAOfObject(noun);
  switch (g) {
      0,1,2,3,4,5: print &quot;animate &quot;;
      default: print &quot;inanimate &quot;;
  }
  switch (g) {
      0,1,2,6,7,8: print &quot;singular &quot;;
      default: print &quot;plural &quot;;
  }
  switch (g) {
      0,3,6,9: print &quot;masculine&quot;;
      1,4,7,10: print &quot;feminine&quot;;
      default: print &quot;neuter&quot;;
  }
  print &quot; (GNA &quot;, g, &quot;)&quot;;
];
[ GNASub;
  print &quot;GNA &quot;, (GNA) noun, &quot;^&quot;,
        (The) noun, &quot; / &quot;, (the) noun, &quot; / &quot;, (a) noun, &quot;^&quot;;
];
Verb meta 'gna' * multi -&gt; GNA;
</pre>
</div>

<div class="ans"><a id="ans115" name="ans115"></a>
<ul><li>115 (p. <a href="s37.html#ex115">271</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Constant LanguageContractionForms = 3;
[ LanguageContraction text;
  if (text-&gt;0 == 'a' or 'e' or 'i' or 'o' or 'u'
                 or 'A' or 'E' or 'I' or 'O' or 'U') return 2;
  if (text-&gt;0 == 'z' or 'Z') return 1;
  if (text-&gt;0 ~= 's' or 'S') return 0;
  if (text-&gt;1 == 'a' or 'e' or 'i' or 'o' or 'u'
                 or 'A' or 'E' or 'I' or 'O' or 'U') return 1;
  return 0;
];
</pre>
</div>

<div class="ans"><a id="ans116" name="ans116"></a>
<ul><li>116 (p. <a href="s37.html#ex116">272</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Array LanguageArticles --&gt;
 !   Contraction form 0:     Contraction form 1:
 !   Cdef   Def    Indef     Cdef   Def    Indef
     &quot;Le &quot;  &quot;le &quot;  &quot;un &quot;     &quot;L'&quot;   &quot;l'&quot;   &quot;un &quot;     ! 0: masc sing
     &quot;La &quot;  &quot;la &quot;  &quot;une &quot;    &quot;L'&quot;   &quot;l'&quot;   &quot;une &quot;    ! 1: fem sing
     &quot;Les &quot; &quot;les &quot; &quot;des &quot;    &quot;Les &quot; &quot;les &quot; &quot;des &quot;;   ! 2: plural
                   !             a           i
                   !             s     p     s     p
                   !             m f n m f n m f n m f n
Array LanguageGNAsToArticles --&gt; 0 1 0 2 2 2 0 1 0 2 2 2;
</pre>
</div>

<div class="ans"><a id="ans117" name="ans117"></a>
<ul><li>117 (p. <a href="s37.html#ex117">272</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Array LanguageArticles --&gt;
 ! Contraction form 0:   Contraction form 1:   Contraction form 2:
 ! Cdef   Def    Indef   Cdef   Def    Indef   Cdef   Def    Indef
   &quot;Il &quot;  &quot;il &quot;  &quot;un &quot;   &quot;Lo &quot;  &quot;lo &quot;  &quot;uno &quot;  &quot;L'&quot;   &quot;l'&quot;   &quot;un &quot;
   &quot;La &quot;  &quot;la &quot;  &quot;una &quot;  &quot;Lo &quot;  &quot;lo &quot;  &quot;una &quot;  &quot;L'&quot;   &quot;l'&quot;   &quot;un'&quot;
   &quot;I &quot;   &quot;i &quot;   &quot;un &quot;   &quot;Gli &quot; &quot;gli &quot; &quot;uno &quot;  &quot;Gli &quot; &quot;gli &quot; &quot;un &quot;
   &quot;Le &quot;  &quot;le &quot;  &quot;una &quot;  &quot;Gli &quot; &quot;gli &quot; &quot;una &quot;  &quot;Le &quot;  &quot;le &quot;  &quot;un'&quot;; 
                   !             a           i
                   !             s     p     s     p
                   !             m f n m f n m f n m f n
Array LanguageGNAsToArticles --&gt; 0 1 0 2 3 0 0 1 0 2 3 0;
</pre>
</div>

<div class="ans"><a id="ans118" name="ans118"></a>
<ul><li>118 (p. <a href="s37.html#ex118">272</a>) &nbsp;
One contraction form, and one article set (numbered 0), in which all
three articles are blank:</li></ul>

<p class="lynxonly"></p>
<pre>
Constant LanguageContractionForms = 1;
[ LanguageContraction text; return 0; ];
Array LanguageArticles --&gt; &quot;&quot; &quot;&quot; &quot;&quot;;
                   !             a           i
                   !             s     p     s     p
                   !             m f n m f n m f n m f n
Array LanguageGNAsToArticles --&gt; 0 0 0 0 0 0 0 0 0 0 0 0;
</pre>
</div>

<div class="ans"><a id="ans119" name="ans119"></a>
<ul><li>119 (p. <a href="s37.html#ex119">273</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Array SmallNumbersInFrench --&gt;
  &quot;un&quot; &quot;deux&quot; &quot;trois&quot; &quot;quatre&quot; &quot;cinq&quot; &quot;six&quot; &quot;sept&quot; &quot;huit&quot;
  &quot;neuf&quot; &quot;dix&quot; &quot;onze&quot; &quot;douze&quot; &quot;treize&quot; &quot;quatorze&quot; &quot;quinze&quot;
  &quot;seize&quot; &quot;dix-sept&quot; &quot;dix-huit&quot; &quot;dix-neuf&quot;;
[ LanguageNumber n f;
  if (n == 0)    { print &quot;z@'ero&quot;; rfalse; }
  if (n &lt; 0)     { print &quot;moins &quot;; n = -n; }
  if (n &gt;= 1000) { if (n/1000 ~= 1) print (LanguageNumber) n/1000, &quot; &quot;;
                   print &quot;mille&quot;; n = n%1000; f = true; }
  if (n &gt;= 100)  { if (f) print &quot; &quot;;
                   if (n/100 ~= 1) print (LanguageNumber) n/100, &quot; &quot;;
                   print &quot;cent&quot;; n = n%100; f = true; }
  if (n == 0) rfalse;
  if (f) { print &quot; &quot;; if (n == 1) print &quot;et &quot;; }
  switch (n) {
     1 to 19: print (string) SmallNumbersInFrench--&gt;(n-1);
     20 to 99:
       switch (n/10) {
          2: print &quot;vingt&quot;;
             if (n%10 == 1) { print &quot; et un&quot;; return; }
          3: print &quot;trente&quot;;
             if (n%10 == 1) { print &quot; et un&quot;; return; }
          4: print &quot;quarante&quot;;
             if (n%10 == 1) { print &quot; et un&quot;; return; }
          5: print &quot;cinquante&quot;;
             if (n%10 == 1) { print &quot; et un&quot;; return; }
          6: print &quot;soixante&quot;;
             if (n%10 == 1) { print &quot; et un&quot;; return; }
          7: print &quot;soixante&quot;;
             if (n%10 == 1) { print &quot; et onze&quot;; return; }
             print &quot;-&quot;; LanguageNumber(10 + n%10); return;
          8: if (n%10 == 0) { print &quot;quatre vingts&quot;; return; }
             print &quot;quatre-vingt&quot;;
          9: print &quot;quatre-vingt-&quot;; LanguageNumber(10 + n%10);
             return;
       }
       if (n%10 ~= 0) { print &quot;-&quot;; LanguageNumber(n%10); }
  }
];
</pre>
</div>

<div class="ans"><a id="ans120" name="ans120"></a>
<ul><li>120 (p. <a href="s37.html#ex120">273</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ LanguageTimeOfDay hours mins i;
  i = hours%12;
  if (i == 0) i = 12;
  if (i &lt; 10) print &quot; &quot;;
  print i, &quot;:&quot;, mins/10, mins%10;
  if (hours&gt;= 12) print &quot; pm&quot;; else print &quot; am&quot;;
];
</pre>
</div>

<div class="ans"><a id="ans121" name="ans121"></a>
<ul><li>121 (p. <a href="s37.html#ex121">277</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
[ FrenchNominativePronoun obj;
  switch (GetGNAOfObject(obj)) {
      0, 6: print &quot;il&quot;;  1, 7: print &quot;elle&quot;;
      3, 9: print &quot;ils&quot;; 4, 10: print &quot;elles&quot;;
  }
];
</pre>
</div>

<h3>Exercises in Chapter VII</h3>

<div class="ans"><a id="ans122" name="ans122"></a>
<ul><li>122 (p. <a href="s42.html#ex122">310</a>) &nbsp;
The following implementation is limited to a format string 2&#215;64 = 128
characters long, and six subsequent arguments. <code>%d</code> becomes 
a decimal number, <code>%e</code> an English one; <code>%c</code> 
a character, <code>%%</code> a (single) percentage sign and 
<code>%s</code> a string.</li></ul>

<p class="lynxonly"></p>
<pre>
Array printed_text --&gt; 65;
Array printf_vals --&gt; 6;
[ Printf format p1 p2 p3 p4 p5 p6   pc j k;
  printf_vals--&gt;0 = p1; printf_vals--&gt;1 = p2; printf_vals--&gt;2 = p3;
  printf_vals--&gt;3 = p4; printf_vals--&gt;4 = p5; printf_vals--&gt;5 = p6;
  printed_text--&gt;0 = 64; @output_stream 3 printed_text;
  print (string) format; @output_stream -3;
  j = printed_text--&gt;0;
  for (k=2: k&lt;j+2: k++) {
     if (printed_text-&gt;k == '%' &amp;&amp; k&lt;j+2) {
         switch (printed_text-&gt;(++k)) {
             '%': print &quot;%&quot;;
             'c': print (char) printf_vals--&gt;pc++;
             'd': print printf_vals--&gt;pc++;
             'e': print (number) printf_vals--&gt;pc++;
             's': print (string) printf_vals--&gt;pc++;
             default: print &quot;&lt;** Unknown printf escape **&gt;&quot;;
         }
     }
     else print (char) printed_text-&gt;k;
  }
];
</pre>
</div>

<div class="ans"><a id="ans123" name="ans123"></a>
<ul><li>123 (p. <a href="s42.html#ex123">311</a>) &nbsp;
The is from the <i>Popol Vuh</i>, the source of Maya mythology.</li></ul>

<p class="lynxonly"></p>
<pre>
[ TitlePage i;
  @erase_window -1; print &quot;^^^^^^^^^^^^^&quot;;
  i = 0-&gt;33; if (i &gt; 30) i = (i-30)/2;
  style bold; font off; spaces(i);
  print &quot;            RUINS^&quot;;
  style roman; print &quot;^^&quot;; spaces(i);
  print &quot;[Please press SPACE to begin.]^&quot;;
  font on;
  box &quot;But Alligator was not digging the bottom of the hole&quot;
      &quot;Which was to be his grave,&quot;
      &quot;But rather he was digging his own hole&quot;
      &quot;As a shelter for himself.&quot;
      &quot;&quot;
      &quot;-- from the Popol Vuh&quot;;
  @read_char 1 -&gt; i;
  @erase_window -1;
];
</pre>
</div>

<div class="ans"><a id="ans124" name="ans124"></a>
<ul><li>124 (p. <a href="s42.html#ex124">311</a>) &nbsp;
First put the directive <code>Replace DrawStatusLine;</code> before 
including the library; define the global variable <code>invisible_status</code> 
somewhere. Then give the following redefinition:</li></ul>

<p class="lynxonly"></p>
<pre>
[ DrawStatusLine width posa posb;
  if (invisible_status) { @split_window 0; return; }
  @split_window 1; @set_window 1; @set_cursor 1 1; style reverse;
  width = 0-&gt;33; posa = width-26; posb = width-13;
  spaces (width);
  @set_cursor 1 2;  PrintShortName(location);
  if (width &gt; 76) {
      @set_cursor 1 posa; print &quot;Score: &quot;, sline1;
      @set_cursor 1 posb; print &quot;Moves: &quot;, sline2;
  }
  if (width &gt; 63 &amp;&amp; width &lt;= 76) {
      @set_cursor 1 posb; print sline1, &quot;/&quot;, sline2;
  }
  @set_cursor 1 1; style roman; @set_window 0;
];
</pre>

<p class="normal">For simplicity this and the following answers assume 
that the player's visibility ceiling is always either darkness or the 
location: imitate the real <code>DrawStatusLine</code> in <tt>&quot;parserm.h&quot;</tt>
if you need situations when the player is sealed into an opaque container.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans125" name="ans125"></a>
<ul><li>125 (p. <a href="s42.html#ex125">311</a>) &nbsp;
First put the directive <code>Replace DrawStatusLine;</code> before including 
the library. Then add the following routine anywhere after <code>treasures_found</code>, 
an &#8216;Advent&#8217; variable, is defined:</li></ul>

<p class="lynxonly"></p>
<pre>
[ DrawStatusLine;
  @split_window 1; @set_window 1; @set_cursor 1 1; style reverse;
  spaces (0-&gt;33);
  @set_cursor 1 2;  PrintShortName(location);
  if (treasures_found &gt; 0) {
      @set_cursor 1 50; print &quot;Treasure: &quot;, treasures_found;
  }
  @set_cursor 1 1; style roman; @set_window 0;
];
</pre>
</div>

<div class="ans"><a id="ans126" name="ans126"></a>
<ul><li>126 (p. <a href="s42.html#ex126">312</a>) &nbsp;
<code>Replace</code> with the following. (Note the use of <code>@@92</code> 
as a string escape, to include a literal backslash character.) This 
could be made more sophisticated by looking at the <code>metaclass</code> 
of <code>location.u_to</code> and so forth, but let's not complicate things:</li></ul>

<p class="lynxonly"></p>
<pre>
Constant U_POS 28; Constant W_POS 30; Constant C_POS 31;
Constant E_POS 32; Constant I_POS 34;
[ DrawStatusLine;
  @split_window 3; @set_window 1; style reverse; font off;
  @set_cursor 1 1; spaces (0-&gt;33);
  @set_cursor 2 1; spaces (0-&gt;33);
  @set_cursor 3 1; spaces (0-&gt;33);
  @set_cursor 1 2;  print (name) location;
  @set_cursor 1 51; print &quot;Score: &quot;, sline1;
  @set_cursor 1 64; print &quot;Moves: &quot;, sline2;
  if (location ~= thedark) {
    ! First line
    if (location.u_to)   { @set_cursor 1 U_POS; print &quot;U&quot;; }
    if (location.nw_to)  { @set_cursor 1 W_POS; print &quot;@@92&quot;; }
    if (location.n_to)   { @set_cursor 1 C_POS; print &quot;|&quot;; }
    if (location.ne_to)  { @set_cursor 1 E_POS; print &quot;/&quot;; }
    if (location.in_to)  { @set_cursor 1 I_POS; print &quot;I&quot;; }
    ! Second line
    if (location.w_to)   { @set_cursor 2 W_POS; print &quot;-&quot;; }
                           @set_cursor 2 C_POS; print &quot;o&quot;;
    if (location.e_to)   { @set_cursor 2 E_POS; print &quot;-&quot;; }
    ! Third line
    if (location.d_to)   { @set_cursor 3 U_POS; print &quot;D&quot;; }
    if (location.sw_to)  { @set_cursor 3 W_POS; print &quot;/&quot;; }
    if (location.s_to)   { @set_cursor 3 C_POS; print &quot;|&quot;; }
    if (location.se_to)  { @set_cursor 3 E_POS; print &quot;@@92&quot;; }
    if (location.out_to) { @set_cursor 3 I_POS; print &quot;O&quot;; }
  }
  @set_cursor 1 1; style roman; @set_window 0; font on;
];
</pre>
</div>

<div class="ans"><a id="ans127" name="ans127"></a>
<ul><li>127 (p. <a href="s42.html#ex127">312</a>) &nbsp;
The tricky part is working out the number of characters in the location
name, and this is where <code>@output_stream</code> is so useful. 
This time <code>Replace</code> with:</li></ul>

<p class="lynxonly"></p>
<pre>
Array printed_text --&gt; 64;
[ DrawStatusLine i j;
  i = 0-&gt;33;
  font off;
  @split_window 1; @buffer_mode 0; @set_window 1;
  style reverse; @set_cursor 1 1; spaces(i);
  @output_stream 3 printed_text;
  print (name) location;
  @output_stream -3;
  j = (i-(printed_text--&gt;0))/2;
  @set_cursor 1 j; print (name) location; spaces(j-1);
  style roman;
  @buffer_mode 1; @set_window 0; font on;
];
</pre>

<p class="normal">Note that the table can hold 128 characters (plenty 
for this purpose), and that these are stored in <code>printed_text-&gt;2</code> 
to <code>printed_text-&gt;129</code>; the length printed is held in
<code>printed_text--&gt;0</code>. (&#8216;Trinity&#8217; actually does 
this more crudely, storing away the width of each location name.)</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans128" name="ans128"></a>
<ul><li>128 (p. <a href="s42.html#ex128">314</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Global indent; Global d_indent = 1;
[ StartWavyMargins;
  @put_wind_prop 0 8 WavyMargins; @put_wind_prop 0 9 1;
];
[ StopWavyMargins;
  @put_wind_prop 0 8 0; @put_wind_prop 0 9 0; @set_margins 0 0 0;
];
[ WavyMargins;
  indent = indent + d_indent*10;
  if (indent == 0 or 80) d_indent = -d_indent;
  @set_margins indent indent 0;
  StartWavyMargins();
];
</pre>
</div>

<div class="ans"><a id="ans129" name="ans129"></a>
<ul><li>129 (p. <a href="s42.html#ex129">317</a>) &nbsp;
The following routine returns the ZSCII code of the key pressed, 
for good measure:</li></ul>

<p class="lynxonly"></p>
<pre>[ PressAnyKey k; @read_char 1 -&gt; k; return k; ];</pre>
</div>

<div class="ans"><a id="ans130" name="ans130"></a>
<ul><li>130 (p. <a href="s42.html#ex130">317</a>) &nbsp;
The keyboard is allowed only one tenth of a second to respond before
an interrupt takes place, which is set to stop waiting:</li></ul>

<p class="lynxonly"></p>
<pre>
[ KeyHeldDown k;
  @read_char 1 1 Interrupt -&gt; k; return k;
];
[ Interrupt; rtrue; ];
</pre>

<p class="normal">The second <code>1</code> in the <code>@read_char</code> 
is the time delay: 1 tenth of a second.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans131" name="ans131"></a>
<ul><li>131 (p. <a href="s42.html#ex131">317</a>) &nbsp;
Place the directive <code>Replace KeyboardPrimitive;</code> somewhere 
before any library files are included. At the end of the file, add 
these lines:</li></ul>

<p class="lynxonly"></p>
<pre>
[ KeyboardPrimitive b p k;
  b-&gt;1 = 0; p-&gt;1 = 0; @aread b p 100 Hurryup -&gt; k;
];
[ Hurryup; print &quot;^Hurry up, please, it's time.^&quot;; rfalse; ];
</pre>

<p class="normal">The number 100 represents one hundred tenths of a 
second, i.e., ten seconds of real time.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans132" name="ans132"></a>
<ul><li>132 (p. <a href="s42.html#ex132">317</a>) &nbsp;
This time, we need to make use of the &#8220;terminating character&#8221;, 
the value stored by the <code>@aread</code> opcode, which is 0 if and 
only if the reading was halted by an interrupt routine. If so, the command 
is written by hand and then tokenised using the <code>@tokenise</code> opcode.</li></ul>

<p class="lynxonly"></p>
<pre>
Global reminders; Global response;
[ KeyboardPrimitive b p k;
  reminders = 0; response = b;
  response-&gt;1 = 0; p-&gt;1 = 0;
  @aread response p 50 Hurry -&gt; k;
  if (k ~= 0) return;
  response-&gt;1 = 4; response-&gt;2 = 'l'; response-&gt;3 = 'o';
  response-&gt;4 = 'o'; response-&gt;5 = 'k';
  @tokenise b p;
];
[ Hurry;
  switch (++reminders) {
      1: print &quot;^(Please decide quickly.)^&quot;;
      2: print &quot;^(Further delay would be unfortunate.)^&quot;;
      3: print &quot;^(I really must insist on a response.)^&quot;;
      4: print &quot;^(In ten seconds I'll make your mind up for you.)^&quot;;
      6: print &quot;^(~look~ it is, then.)^&quot;; rtrue;
  }
  rfalse;
];
</pre>

<p class="normal">Note that <code>Hurry</code> is called every five seconds.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans133" name="ans133"></a>
<ul><li>133 (p. <a href="s42.html#ex133">317</a>) &nbsp;
The timing is the easy part. We shall send the message <code>run_sand</code> 
to the hourglass every time the game asks the player for a command, and 
then every second thereafter:</li></ul>

<p class="lynxonly"></p>
<pre>
[ KeyboardPrimitive b p k;
  hourglass.run_sand(); b-&gt;1 = 0; p-&gt;1 = 0;
  @aread b p 10 OneSecond -&gt; k;
];
[ OneSecond; hourglass.run_sand(); rfalse; ];
</pre>

<p class="normal">The catch is that time spent looking at menus, or waiting 
to press the space bar after the interpreter prints &#8220;[MORE]&#8221;, 
isn't registered, and besides that a turn may take more or less than 
1 second to parse. So you wouldn't want to set your watch by this hourglass, 
but on the author's machine it keeps reasonable enough time. Here's the
object:</p>

<p class="lynxonly"></p>
<pre>
Object -&gt; hourglass &quot;hourglass&quot;
  with name 'hourglass',
       sand_in_top,
       when_on [;
           print &quot;An hourglass is fixed to a pivot on the wall. &quot;;
           switch (self.sand_in_top/10) {
               0: &quot;The sand is almost all run through to a neat pyramid
                  in the lower bulb.&quot;;
               1: &quot;About a quarter of the sand is left in the upper
                  bulb.&quot;;
               2: &quot;The upper and lower bulbs contain roughly equal
                  amounts of sand.&quot;;
               3: &quot;About three-quarters of the sand is still to run.&quot;;
               4: &quot;Almost all of the sand is in the upper bulb.&quot;;
           }
       ],
       when_off
           &quot;An hourglass fixed to a pivot on the wall is turned
           sideways, so that no sand moves.&quot;,
       before [;
           Turn: if (self hasnt on) &lt;&lt;SwitchOn self&gt;&gt;;
               self.sand_in_top = 40 - self.sand_in_top;
               &quot;You turn the hourglass the other way up.&quot;;
       ],
       after [;
           SwitchOn:
               if (self.sand_in_top &lt; 20)
                   self.sand_in_top = 40 - self.sand_in_top;
               &quot;You turn the hourglass so that the bulb with most sand
               is uppermost, and the grains begin to pour through.&quot;;
           SwitchOff:
               &quot;You turn the hourglass sideways.&quot;;
       ],
       run_sand [;
           if (self has on &amp;&amp; (--(self.sand_in_top) &lt; 0)) {
               self.sand_in_top = 40 - self.sand_in_top;
               if (self in location)
                   &quot;^The hourglass elegantly turns itself to begin
                   again, all of the sand now in the uppermost bulb.&quot;;
           }
       ],
  has  static switchable;
</pre>
</div>

<div class="ans"><a id="ans134" name="ans134"></a>
<ul><li>134 (p. <a href="s42.html#ex134">318</a>)</li></ul>

<p class="lynxonly"></p>
<pre>
Array mouse_array --&gt; 4;
[ Main k;
  @mouse_window 0;
  for (::) {
      @read_char 1 -&gt; k;
      @read_mouse mouse_array;
      switch(k) {
          253, 254: if (k == 253) print &quot;Double-&quot;;
              print &quot;Click at (&quot;, mouse_array--&gt;0, &quot;,&quot;,
                  mouse_array--&gt;1, &quot;) buttons &quot;,
                  mouse_array--&gt;2, &quot;^&quot;;
      }
  }
];
</pre>
</div>

<div class="ans"><a id="ans135" name="ans135"></a>
<ul><li>135 (p. <a href="s42.html#ex135">318</a>) &nbsp;
This needs another replacement of <code>KeyboardPrimitive</code>:</li></ul>

<p class="lynxonly"></p>
<pre>
Zcharacter terminating 252;
Array mouse_array --&gt; 4;
[ KeyboardPrimitive b p k s i;
  b-&gt;1 = 0; p-&gt;1 = 0;
  @aread b p -&gt; k;
  if (k ~= 252) return;
  @read_mouse mouse_array;
  s = Do_M--&gt;(1 + mouse_array-&gt;7);
  for (i=1: i&lt;=s-&gt;0: i++) { b-&gt;(i+1) = s-&gt;i; print (char) s-&gt;i; }
  new_line; b-&gt;1=s-&gt;0; @tokenise b p;
];
</pre>

<p class="normal">And the menu itself must be created:</p>

<p class="lynxonly"></p>
<pre>
Array D1 string &quot;Do&quot;;
Array D2 string &quot;look&quot;;
Array D3 string &quot;wait&quot;;
Array D4 string &quot;inventory&quot;;
Array Do_M table D1 D2 D3 D4;
[ Initialise;
  ...
  @mouse_window 0;
  @make_menu 3 Do_M ?Able;
  &quot;*** Unable to generate menu. ***&quot;;
  .Able;
  ...
];
</pre>
</div>

<div class="ans"><a id="ans136" name="ans136"></a>
<ul><li>136 (p. <a href="s42.html#ex136">319</a>) &nbsp;
By encoding one or more &#8220;characters&#8221; into an array and using 
<code>@save</code> and <code>@restore</code>. The numbers in this array 
might contain the character's name, rank and abilities, together with 
some coding system to show what possessions the character has (a brass 
lamp, 50 feet of rope, etc.)</li></ul>
</div>

<div class="ans"><a id="ans137" name="ans137"></a>
<ul><li>137 (p. <a href="s42.html#ex137">319</a>) &nbsp;
This means using a &#8220;bones file&#8221; like those generated by the 
game &#8216;Hack&#8217;. To begin with, two arrays. The array <code>bones_file</code> 
will hold a number from 0 to 9 (the number of ghosts currently present), 
followed by the locations of these ghosts.</li></ul>

<p class="lynxonly"></p>
<pre>
Array bones_filename string &quot;catacomb.bns&quot;;
Array bones_file --&gt; 10;
Class Ghost(10)
  with short_name &quot;ghost&quot;, plural &quot;ghosts&quot;, name 'ghost' 'ghosts//p',
  has  animate;
</pre>

<p class="normal">The game's <code>Initialise</code> routine should do 
the following:</p>

<p class="lynxonly"></p>
<pre>
  @restore bones_file 20 bones_filename -&gt; k;
  if (k == 0) bones_file--&gt;0 = 0;
  for (k=1: k&lt;=bones_file--&gt;0: k++) {
      g = Ghost.create(); move g to bones_file--&gt;k;
  }
</pre>

<p class="normal">This only leaves updating the bones file in the event 
of death, using the entry point <code>AfterLife</code>:</p>

<p class="lynxonly"></p>
<pre>
[ AfterLife k;
  if (bones_file--&gt;0 == 9) {
      for (k=2: k&lt;=9: k++) bones_file--&gt;(k-1) = bones_file--&gt;k;
      bones_file--&gt;9 = real_location;
  }
  else bones_file--&gt;(++(bones_file--&gt;0)) = real_location;
  @save bones_file 20 bones_filename -&gt; k;
];
</pre>

<p class="normal">This code doesn't trouble to check that the save worked 
properly, because it doesn't much matter if the feature goes awry: the 
spirit world is not a reliable place. However, if the restore fails, 
the game empties the <code>bones_file</code> array just in case some 
file-handling accident on the host machine had loaded only half of the 
array, leaving the rest corrupt.</p>
</div>

<p class="lynxonly"></p>
<div class="ans"><a id="ans138" name="ans138"></a>
<ul><li>138 (p. <a href="s42.html#ex138">320</a>) &nbsp;
First, <code>Replace</code> a routine in the library called <code>ActionPrimitive</code>. 
This little routine calls all action subroutines, such as <code>TakeSub</code>, 
as and when needed. Its new version pauses to catch a stack frame:</li></ul>

<p class="lynxonly"></p>
<pre>
[ ActionPrimitive x;
  if ((x = ExceptionHandler()) ~= 0)
      &quot;^*** Exception: &quot;, (string) x, &quot; ***&quot;;
];
Global exception;
[ ExceptionHandler;
  @catch -&gt; exception;
  indirect(#actions_table--&gt;action);
  rfalse;
];
</pre>

<p class="normal">Then an action getting in trouble can simply execute 
a statement like:</p>

<p class="lynxonly"></p>
<pre>@throw &quot;Numeric overflow&quot; exception;</pre>
</div>

</div>
<p class="navbar">
 <a href="index.html">home</a> /
 <a href="contents.html">contents</a> /
 <a href="app.html">appendices</a> /
 <a href="sa5.html" title="&#167;A5: Entry point routines">prev</a> /
 <a href="tables.html" title="Tables">next</a> /
 <a href="dm4index.html">index</a>
</p>
</body>
</html>

