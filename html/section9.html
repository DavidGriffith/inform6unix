<HTML><HEAD><TITLE>Section 9: Actions and reactions</TITLE></HEAD>
<BODY BGCOLOR="#FFFFFF">
<TABLE></SMALL>
<TR><TD><TD><P>
<TR><TD Valign="top"><A HREF="contents.html">Contents</A><BR><A HREF="section8.html">Back</A><BR><A HREF="chapter4.html">Forward</A><TD bgcolor="#F5DEB3"><BLOCKQUOTE><H3>9. Actions and reactions</H3></BLOCKQUOTE><TR><TD><TD>
<P>

<BLOCKQUOTE>
<BR>Only the actions of the just
<BR>Smell sweet and blossom in their dust.
<BR><P>...James Shirley (<B>1594</B>--<B>1666</B>), <I>The Contention of Ajax and Ulysses</I></BLOCKQUOTE>
<BLOCKQUOTE>
...a language obsessed with action, and with the joy of seeing
action multiply from action, action marching relentlessly ahead
and with yet more actions filing in from either side to fall into
neat step at the rear, in a long straight rank of cause and
effect, to what will be inevitable, the only possible end.
<P>...Donna Tartt, <I>The Secret History</I></BLOCKQUOTE>
<P>


Inform is a language obsessed with actions.  An 'action' is an attempt
to perform one simple task: for instance,
<BLOCKQUOTE>
<TT>Inv</TT> <BR>
<TT>Take sword</TT> <BR>
<TT>Insert gold_coin cloth_bag</TT> <BR>
</BLOCKQUOTE>

are all examples.  Here the actual actions are <TT>Inv</TT>, <TT>Take</TT> and
<TT>Insert</TT>.  An action has 0, 1 or 2 objects supplied
with it (or, in a few special cases, some numerical information rather than
objects).  Most actions are triggered off by the game's parser: in fact,
the parser's job can be summed up as reducing the player's keyboard
commands to actions.  Sometimes one action causes another; a really
complicated keyboard command ("empty the sack into the umbrella stand'')
may fire off quite a sequence of actions.
<P>

An action is only an attempt to do something: it may not succeed.
Firstly, a <TT>before</TT> rule might interfere, as we have seen already.
Secondly, the action might not even be very sensible.  The parser will
happily generate the action <TT>Eat iron_girder</TT> if the player asked to do
so in good English.  In this case, even if no <TT>before</TT> rule interferes,
the normal game rules will ensure that the girder is not consumed.
<P>

Actions can also be generated by your own code, and this perfectly
simulates the effect of a player typing something.  For example,
generating a <TT>Look</TT> action makes the game produce a room description
as if the player had typed "look''.  More subtly, suppose the air
in the Pepper Room causes the player to sneeze each turn and drop
something at random.  This could be programmed directly, with objects
being moved onto the floor by explicit <TT>move</TT> statements.  But then
suppose the game also contains a toffee apple, which sticks to the
player's hands.  Suddenly the toffee apple problem has an unintended
solution.  So rather than moving the objects directly to the floor,
the game should generate <TT>Drop</TT> actions.  The result might read:
<BLOCKQUOTE>
You sneeze convulsively, and lose your grip on the toffee apple...<BR>
The toffee apple sticks to your hand!<BR>
</BLOCKQUOTE>

which is at least consistent.
<P>

As an example of causing actions, an odorous <TT>low_mist</TT> will soon settle over
'Ruins'.  It will have the <TT>description</TT> "The mist carries a
rich aroma of broth.''  The alert player who reads this will immediately
type "smell mist'', and we want to provide a better response than the game's
stock reply "You smell nothing unexpected.''  An economical way of doing this
is to somehow deflect the action <TT>Smell low_mist</TT> into the action
<TT>Examine low_mist</TT> instead, so that the "aroma of broth'' message is
printed in this case too.  Here is a suitable <TT>before</TT> rule to do that:
<PRE>
         Smell: &#60;Examine self&#62;; rtrue;
</PRE>

The statement <TT>&#60;Examine self&#62;</TT> causes the action <TT>Examine low_mist</TT> to be
triggered off immediately, after which whatever was going on at the time
resumes.  In this case, the action <TT>Smell low_mist</TT> resumes, but since we
immediately return <TT>true</TT> the action is stopped dead.
<P>

Causing an action and then returning <TT>true</TT> (i.e., causing a new action
and killing the old one) is so useful that it has an abbreviation,
putting the action in double angle-brackets.  For example,
<PRE>
         &#60;Look&#62;; &#60;&#60;ThrowAt smooth_stone spider&#62;&#62;;
</PRE>

will behave as if the player has asked to look around and to throw
the stone at the spider, and will then return <TT>true</TT>.
<P>

<P>
At any given time, just one action is under way (though others
may be waiting to resume when the current one has finished).  This
current action is stored in the three variables
<PRE>
         action      noun      second
</PRE>

<TT>noun</TT> and <TT>second</TT> hold the objects involved, or the special
value <TT>nothing</TT> if they aren't involved at all.  <TT>action</TT> holds
the kind of action.  Its possible values can be referred to in
the program using the <TT>##</TT> notation: for example
<PRE>
         if (action == ##Look) ...
</PRE>

tests to see if the current action is a <TT>Look</TT>.
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> Why have <TT>##</TT> at all, why not just write <TT>Look</TT>?  Partly
because this way the reader can see at a glance that an action
type is being referred to, but also because the name might be
wanted for something else.  For instance there's a variable called
<TT>score</TT> (holding the current game score), quite different from
the action type <TT>##Score</TT>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL>  For a few actions, the 'noun' (or the 'second noun') is
actually a number (for instance, "set timer to 20'' would probably
end up with <TT>noun</TT> being <TT>timer</TT> and <TT>second</TT> being 20).  Occasionally
one needs to be sure of the difference, e.g., to tell if <TT>second</TT>
is holding a number or an object.  It's then useful to know that
there are two further variables, <TT>inp1</TT> and <TT>inp2</TT>, parallel to
<TT>noun</TT> and <TT>second</TT> and usually equal to them -- but equal to 1 to
indicate "some numerical value, not an object''.
</SMALL>
<TR><TD><TD><P>

<P>

The library supports about 120 different actions and any game of serious
proportion will add some more of its own.  This list is initially daunting
but many are used only rarely and others are always knocked down into
simpler actions (for example, <TT>&#60;Empty rucksack table&#62;</TT>, meaning
"empty the contents of the rucksack onto the table'', is broken down into
a stream of actions like <TT>&#60;Remove fish rucksack&#62;</TT> and <TT>&#60;PutOn fish table&#62;</TT>).
It's useful to know that an object can only enter the player's possession
through a <TT>Take</TT> or <TT>Remove</TT> action: block those two and it can never be
acquired whatever the player types.
<P>

The list of actions is traditionally divided into three groups, called
Group 1, Group 2 and Group 3.  
Group 1 contains 'meta' actions for controlling the game, like <TT>Score</TT>
and <TT>Save</TT>, which are treated quite differently from other actions and
are not worth listing.  Of the rest, actions which normally do something
form Group 2, while actions which normally only print a polite refusal
form Group 3.  Group 2 contains:
<PRE>
Inv, Take, Drop, Remove, PutOn, Insert, Enter, Exit, Go, Look, Examine,
Unlock, Lock, SwitchOn, SwitchOff, Open, Close, Disrobe, Wear, Eat, Search.
</PRE>

It should be apparent why these do something.  However, an action
like <TT>Listen</TT> falls into Group 3: the library would normally respond
to it by printing "You hear nothing unexpected.''  Only if your program
interferes (using a <TT>before</TT> rule) can anything happen.  Group 3 contains,
in rough order of usefulness:
<PRE>
Pull, Push, PushDir [push object in direction], Turn,
Consult, LookUnder [look underneath something], Search,
Listen, Taste, Drink, Touch, Smell,
Wait, Sing, Jump [jump on the spot], JumpOver, Attack,
Swing [something], Blow, Rub, Set, SetTo, Wave [something],
Burn, Dig, Cut, Tie, Fill, Swim, Climb, Buy, Squeeze,
Pray, Think, Sleep, Wake, WaveHands [i.e., just "wave"],
WakeOther [person], Kiss, Answer, Ask, ThrowAt,
Yes, No, Sorry, Strong [swear word], Mild [swear word]
</PRE>
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> Actions involving other people, like <TT>Kiss</TT>, are often best
dealt with by a <TT>life</TT> rule, which will be discussed in <A HREF="section16.html">Section 16</A>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> A few actions (e.g., <TT>Transfer</TT>, <TT>Empty</TT>, <TT>GetOff</TT>) are omitted
from the list above because they're always translated into more familiar
ones.  For instance, <TT>InvWide</TT> (asking for a "wide--format'' inventory
listing) always ends up in an <TT>Inv</TT>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> The <TT>Search</TT> action (generated by "look inside <I><B>&#60;container&#62;</B></I>''
or "search <I><B>&#60;something&#62;</B></I>'') only ever prints text, but is in Group 2
rather than Group 3 because it does something substantial.  It decides
whether something is a container, and if there's enough light to see by,
it prints out the contents.  Thus, a <TT>before</TT> rule applied to <TT>Search</TT>
traps the searching of random scenery, while an <TT>after</TT> can be used
to alter the contents-listing rules of containers.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> Most of the group 2 actions -- specifically,
<PRE>
Take, Drop, Insert, PutOn, Remove, Enter, Exit, Go, Unlock, Lock,
SwitchOn, SwitchOff, Open, Close, Wear, Disrobe, Eat
</PRE>

can happen "silently''.  If the variable <TT>keep_silent</TT> is set to 1,
then these actions print nothing in the event of success.  (E.g.,
if the door was unlocked as requested.)  They print up objections
as usual if anything goes wrong (e.g., if the suggested key doesn't
fit).  This is useful to implement implicit actions: for instance,
to code a door which will be automatically unlocked by a player
asking to go through it, who is holding the right key.
</SMALL>
<TR><TD><TD><P>

<P>

The standard stock of actions is easily added to.  Two things are
necessary to create a new action: first one must provide a routine
to make it happen.  For instance:
<PRE>
[ BlorpleSub;
  "You speak the magic word ~Blorple~. Nothing happens.";
];
</PRE>

Every action has to have a "subroutine'' like this, the name of which
is always the name of the action with <TT>Sub</TT> appended.  Secondly,
one must add grammar so that <TT>Blorple</TT> can actually be called for.
Far more about grammar in Chapter V: for now we add the simplest of
all grammar lines, a directive
<PRE>
Verb "blorple" *                            -&#62; Blorple;
</PRE>

placed after the inclusion of the <TT>Grammar</TT> file.  (The spacing around
the <TT>*</TT> is just a matter of convention.)  The word "blorple" can now
be used as a verb.  It can't take any nouns, so the parser will complain
if the player types "blorple daisy''.
<P>

<TT>Blorple</TT> is now a typical Group 3 action.  <TT>before</TT> rules can be
written for it, and it can be triggered off by a statement like
<PRE>
       &#60;Blorple&#62;;
</PRE>
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> To make it a Group 1 action, define the verb as <TT>meta</TT> (see <A HREF="section26.html">Section 26</A>).
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> To make it a Group 2 action, rewrite the subroutine in the
following form:
<PRE>
[ WhateverSub;
  ... do whatever the action is supposed to do,
      printing a suitable message and returning
      if it turns out not to be a sensible thing to do...
  if (AfterRoutines()==1) rtrue;
  ... print a suitable message saying that it has been done ...
];
</PRE>

(<TT>AfterRoutines</TT> is a library routine which sends suitable <TT>after</TT>
messages to see if the objects want to prevent the usual message
being printed.)
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> A few of the library's actions fall into none of Groups 1,
2 or 3, though these aren't proper actions at all, but are used
only to signal goings-on.  For instance, when the player types
"throw rock at dalek'', the parser generates the action
<TT>ThrowAt rock dalek</TT>.  As usual the rock is sent a <TT>before</TT> message
asking if it objects to being thrown at a Dalek.  Since the Dalek
may also have an opinion on the matter, another <TT>before</TT> message
is sent to the Dalek, but this time as if the action were something
called <TT>ThrownAt</TT>.  For example, here is a dartboard's response to a
dart:
<PRE>
before
[;  ThrownAt: if (noun==dart)
              {   move dart to self; "Triple 20!"; }
              move noun to location;
              print_ret (The) noun, " bounces back off the board.";
],
</PRE>

Such an imaginary action -- usually, as in this case, a perfectly
sensible action seen from the point of view of the second object
involved, rather than the first -- is called a "fake action''.
The important ones are <TT>ThrownAt</TT>, <TT>Receive</TT> and <TT>LetGo</TT>
(the latter two being used for containers: see <A HREF="section11.html">Section 11</A>).
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> If you really need to, you can declare a new fake action
with the directive <TT>Fake_action</TT> <I><B>&#60;Action-name&#62;</B></I><TT>;</TT>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddexercise.gif" ALT="??/\/\"><TD bgcolor="#FBB9AC"><A NAME="ex3"><B>EXERCISE 3:</B><BR>(link to <A HREF="answers1/answer3.html">the answer</A>)<TR><TD><TD>  <TT>ThrownAt</TT> would be unnecessary if Inform had an
idea of <TT>before</TT> and <TT>after</TT> routines which an object could provide if
it were the <TT>second</TT> noun of an action.  How might this be
implemented?
<P>

</SMALL><TR><TD><TD>
<P>

<P>
Actions are processed in a simple way, but one which involves many
little stages.  There are three main stages:


<P>(a) -- 'Before'.  An opportunity for your code to interfere with
or block altogether what might soon happen.
<P>(b) -- 'During'.  The library takes control and decides if the
action makes sense according to its normal world model: for example,
only an <TT>edible</TT> object may be eaten; only an object in the
player's possession can be thrown at somebody, and so on.  If the
action is impossible, a complaint is printed and that's all.
Otherwise the action is now carried out.
<P>(c) -- 'After'.  An opportunity for your code to react to what
has happened, after it has happened but before any text announcing
it has been printed.  If it chooses, your code can print and cause
an entirely different outcome.  If your code doesn't interfere,
the library reports back to the player (with such choice phrases as
"Dropped.'').
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> Group 1 actions (like <TT>Score</TT>) have no 'Before' or
'After' stages: you can't (easily) stop them from taking place.
They aren't happening in the game's world, but in the player's.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> The 'Before' stage consults your code in five ways, and
occasionally it's useful to know in what order:
<TR><TD><TD bgcolor="#EEEEEE"><SMALL>
<P>i. --  The <TT>GamePreRoutine</TT> is called, if you have written one.
If it returns 'true',
nothing else happens and the action is stopped.
<P>ii. --  The <TT>orders</TT> property of the player is called on the
same terms.  For more details, see <A HREF="section16.html">Section 16</A>.
<P>iii. --  And the <TT>react_before</TT> of every object in scope
(which roughly means 'in the vicinity').
<P>iv. --  And the <TT>before</TT> of the current room.
<P>v. --  If the action has a first noun, its <TT>before</TT> is called
on the same terms.</SMALL><TR><TD><TD>
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> The library processes the 'During' stage by calling
the action's subroutine.  (Subroutines like <TT>TakeSub</TT> make up
a large part of the library.)
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> The 'After' stage only applies to Group 2 actions, as
all Group 3 actions have been packed up at the 'During' stage
if not 'Before'.  During 'After' the sequence is as follows:
<TT>react_after</TT> rules for every object in scope (including the
player object); the room's <TT>after</TT>; the first noun's <TT>after</TT>
and finally <TT>GamePostRoutine</TT>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> Two things are fake about "fake actions'' (see above):
they don't have subroutines, and they never occur in the grammar
of any verb (so they're never directly generated by the parser).
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL>
As mentioned above, the parser can generate very peculiar actions,
and this sometimes needs to be remembered when writing <TT>before</TT>
rules.  Suppose a <TT>before</TT> rule intercepts the action of putting
the mushroom in the crate, and makes something exciting happen
as a result.  Now even if the mushroom is, say, sealed up inside
a glass jar, the parser might still generate this action: the
impossibility won't be realised until 'During' time.  So the
exciting happening should be written as an <TT>after</TT> rule, when the
attempt to put the mushroom in the crate has already succeeded.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dexercise.gif" ALT="??/\"><TD bgcolor="#FBB9AC"><A NAME="ex4"><B>EXERCISE 4:</B><BR>(link to <A HREF="answers1/answer4.html">the answer</A>)<TR><TD><TD>  This kind of snag could be avoided altogether if Inform
had a 'validation stage' in action processing, to check whether an action is
sensible before allowing it to get as far as <TT>before</TT> rules.  How could
this be added to Inform?

<P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL> To some extent you can even meddle with the 'During' stage
(and with the final messages produced), and thus even interfere with
Group 1 actions if you are unscrupulous enough, by cunning use of the
<TT>LibraryMessages</TT> system.  See <A HREF="section21.html">Section 21</A>.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/refs.gif" ALT="*"><TD bgcolor="#EEEEEE"><B>REFERENCES:</B><BR><SMALL>
In a game compiled with the <TT>-D</TT> switch set, typing in the "actions''
verb will result in trace information being printed each time any
action is generated.  Try putting many things into a rucksack and
asking to "empty'' it for an extravagant list.
<BR>
Diverted actions (using <TT>&#60;&#60;</TT> and <TT>&#62;&#62;</TT>) are commonplace.  They're used
in about 20 places in 'Advent': a good example is the way "take water''
is translated into a <TT>Fill bottle</TT> action.
<BR>
Sometimes you want "fake fake actions'' which are fully--fledged
actions (with action routines and so on) but are still never generated
by the parser (see <A HREF="section16.html">Section 16</A>).
</TABLE>
<HR><A HREF="contents.html">Contents</A> / <A HREF="section8.html">Back</A> / <A HREF="chapter4.html">Forward</A> <BR>
<A HREF="chapter1.html">Chapter I</A> / <A HREF="chapter2.html">Chapter II</A> / <A HREF="chapter3.html">Chapter III</A> / <A HREF="chapter4.html">Chapter IV</A> / <A HREF="chapter5.html">Chapter V</A> / <A HREF="chapter6.html">Chapter VI</A> / <A HREF="chapterA.html">Appendix</A><HR><SMALL><I>Mechanically translated to HTML from third edition as revised 16 May 1997. Copyright &#169; Graham Nelson 1993, 1994, 1995, 1996, 1997: all rights reserved.</I></SMALL></BODY></HTML>
