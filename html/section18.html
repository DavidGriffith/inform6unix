<HTML><HEAD><TITLE>Section 18: Daemons and the passing of time</TITLE></HEAD>
<BODY BGCOLOR="#FFFFFF">
<TABLE><P>
<TR><TD Valign="top"><A HREF="contents.html">Contents</A><BR><A HREF="section17.html">Back</A><BR><A HREF="section19.html">Forward</A><TD bgcolor="#F5DEB3"><BLOCKQUOTE><H3>18. Daemons and the passing of time</H3></BLOCKQUOTE><TR><TD><TD>
<P>

<BLOCKQUOTE>
Some, such as Sleep and Love, were never human.  From this
class an individual daemon is allotted to each human being
as his 'witness and guardian' through life.
<P>...C. S. Lewis (<B>1898</B>--<B>1963</B>), <I>The Discarded Image</I></BLOCKQUOTE>
<P>

<BLOCKQUOTE>
A great Daemon... Through him subsist all
divination, and the science of sacred things as it relates
to sacrifices, and expiations, and disenchantments, and
prophecy, and magic... he who is wise in the science
of this intercourse is supremely happy...\
<P>...Plato (c.<B>427</B>--<B>347</B> BC),
<I> The Symposium</I>, translated by Percy Bysshe Shelley
(<B>1792</B>--<B>1822</B>)</BLOCKQUOTE>

<P>


In medieval neo-Platonist philosophy, daemons are the intermediaries
of God, hovering invisibly over the world and interfering with it.
They may be guardian spirits of places or people.  So, here, a daemon is
a meddling spirit, associated with a particular game object, which
gets a chance to interfere once per turn while it is 'active'.
The classic example is of the dwarves of 'Advent', who
appear in the cave from time to time: a daemon routine attached to
the dwarf object moves it about, throws knives at the player and
so on.
Each object can have a <TT>daemon</TT> routine of its own.  This is set
going, and stopped again, by calling the (library) routines
<PRE>
StartDaemon(object);
StopDaemon(object);
</PRE>

Once active, the <TT>daemon</TT> property of the object is called as a routine
each turn.  Daemons are often started by a game's <TT>Initialise</TT> routine
and sometimes remain active throughout.  For instance, a lamp-battery
daemon might do something every turn, while others may hide for many
turns before pouncing: such as the daemon in 'Advent' which waits
until the player has found all the treasures.
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> In particular, a daemon doesn't stop running just because the player
has moved on to somewhere else.  (Indeed, the library never stops a daemon
unless told to.)  Actually this is very useful, as it means daemons can be
used for 'tidying-up operations', or for the consequences of the player's
actions to catch up with him.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/exercise.gif" ALT="??"><TD bgcolor="#FBB9AC"><A NAME="ex34"><B>EXERCISE 34:</B><BR>(link to <A HREF="answers1/answer34.html">the answer</A>)<TR><TD><TD>  Many games contain 'wandering monsters', characters who walk
around the map.  Use a daemon
to implement one who wanders as freely as the player, like the
gentleman thief in 'Zork'.

<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dexercise.gif" ALT="??/\"><TD bgcolor="#FBB9AC"><A NAME="ex35"><B>EXERCISE 35:</B><BR>(link to <A HREF="answers1/answer35.html">the answer</A>)<TR><TD><TD>
Use a background daemon to implement a system of weights, so
that the player can only carry a certain weight before her strength gives
out and she is obliged to drop something.  It should allow for feathers to
be lighter than lawn-mowers.
<P>

<P>

A 'timer' (these are traditionally called 'fuses') can also
be attached to an object.  A timer is started with
<PRE>
StartTimer(object, time);
</PRE>


in which case it will 'go off', alarm clock-style, in the given number of
turns.  This means that its <TT>time_out</TT>

property will be called, once and once only, when the time comes.
The timer can be deactivated (so that it will never go off) by calling
<PRE>
StopTimer(object);
</PRE>

A timer is required to provide a <TT>time_left</TT> property, to hold the
amount of time left.  (If it doesn't, an error message is printed
at run-time.)  You can alter <TT>time_left</TT> yourself: a value of 0 means 'will
go off at the end of this turn', so setting <TT>time_left</TT> to 0 triggers
immediate activation.
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL> Normally, you can only have 32 timers or daemons active at the same
time as each other (plus any number of inactive ones).  But this
limit is easily raised: just define the constant <TT>MAX_TIMERS</TT>

to some larger value, putting the definition in your code before the
<TT>Parser</TT> file is included.

</SMALL>
<TR><TD><TD><P>

<P>
There is yet a third form of timed event.  If a room provides an <TT>each_turn</TT>
routine, then this will be called at the end of each turn while the player
is there; if an object provides <TT>each_turn</TT>, this is called while the object is
nearby.  For instance, a radio might blare out music
whenever it is nearby; a sword might glow whenever monsters are nearby;
or a stream running through several forest locations might occasionally
float objects by.
<P>

'Each turn' is especially useful to run creatures which stay
in one room and are only active when the player is nearby.
An ogre with limited patience can therefore have an <TT>each_turn</TT> routine
which worries the player ("The ogre stamps his feet angrily!'', etc.)
while also having a timer set to go off when his patience runs out.
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL>  'Nearby' actually means 'in scope', a term which will be properly
explained later.  The idea is based on line of sight, which works well
in most cases.
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/ddbend.gif" ALT="/\/\"><TD bgcolor="#EEEEEE"><SMALL>  But it does mean that the radio will be inaudible when shut up
inside most containers -- which is arguably fair enough -- yet audible when
shut up inside transparent, say glass, ones.  You can always change the
scope rules using an <TT>InScope</TT> routine to get around this.  In case you
want to tell whether scope is being worked out for ordinary parsing reasons
or instead for <TT>each_turn</TT> processing, look at the <TT>scope_reason</TT> variable
(see <A HREF="section28.html">Section 28</A>).  Powerful effects are available
this way -- you could put the radio in scope within all nearby rooms so as
to allow sound to travel.  Or you could make a thief audible throughout
the maze he is wandering around in, as in 'Zork I'.

</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/exercise.gif" ALT="??"><TD bgcolor="#FBB9AC"><A NAME="ex36"><B>EXERCISE 36:</B><BR>(link to <A HREF="answers1/answer36.html">the answer</A>)<TR><TD><TD> (Why the 'Ruins' are claustrophobic.)  Make
"the sound of scuttling claws'' approach the player in darkness and,
after 4 consecutive turns in darkness, kill him.

<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dexercise.gif" ALT="??/\"><TD bgcolor="#FBB9AC"><A NAME="ex37"><B>EXERCISE 37:</B><BR>(link to <A HREF="answers1/answer37.html">the answer</A>)<TR><TD><TD> A little harder: implement the scuttling claws in a single
object definition, with no associated code anywhere else in the program
(not even a line in <TT>Initialise</TT>) and without running its daemon all the
time.
<P>

<P>

The library also has the (limited) ability to keep track of time of day
as the game goes on.  The current time is held in the variable <TT>the_time</TT>
and runs on a 24-hour clock: this variable holds minutes since midnight,
so it has values between 0 and 1439.  The time can be set by
<BLOCKQUOTE>
<TT>SetTime(</TT> 60$\times$<I><B>&#60;hours&#62;</B></I><I>+</I><I><B>&#60;minutes&#62;</B></I><TT>,</TT> <I><B>&#60;rate&#62;</B></I> <TT>);</TT>
</BLOCKQUOTE>

The <TT>rate</TT> controls how rapidly time is moving: a <TT>rate</TT> of 0 means it is
standing still (that is, that the library doesn't change it: your routines
still can).  A positive <TT>rate</TT> means that that many minutes pass between
each turn, while a negative <TT>rate</TT> means that many turns pass between each
minute.  (It's usual for a timed game to start off the clock by calling
<TT>SetTime</TT> in its <TT>Initialise</TT> routine.)
The time only (usually) appears on the game's status line if you set
<PRE>
Statusline time;
</PRE>

as a directive somewhere in your code.
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/exercise.gif" ALT="??"><TD bgcolor="#FBB9AC"><A NAME="ex38"><B>EXERCISE 38:</B><BR>(link to <A HREF="answers1/answer38.html">the answer</A>)<TR><TD><TD>  How could you make your game take notice of the time passing
midnight, so that the day of the week could be nudged
on?
                                                         
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/dexercise.gif" ALT="??/\"><TD bgcolor="#FBB9AC"><A NAME="ex39"><B>EXERCISE 39:</B><BR>(link to <A HREF="answers1/answer39.html">the answer</A>)<TR><TD><TD>  (Cf. Sam Hulick's vampire game, 'Knight of Ages'.)
Make the lighting throughout the game change at
sunrise and sunset.

<P>

<TR><TD><TD bgcolor="#EEEEEE"><SMALL>
<P><TR><TD Valign="top"><IMG SRC="icons/dbend.gif" ALT="/\"><TD bgcolor="#EEEEEE"><SMALL>  Exactly what happens at the end of each turn is:

<P>1. --  The turns counter is incremented.
<P>2. --  The 24-clock is moved on.
<P>3. --  Daemons and timers are run (in no guaranteed order).
<P>4. --  <TT>each_turn</TT> takes place for the current room, and then for
everything nearby (that is, in scope).
<P>5. --  The game's global <TT>TimePasses</TT> routine is called.
<P>6. --  Light is re-considered (it may have changed as a result
of events since this time last turn).
\PAR
The sequence is abandoned if at any stage the player
dies or wins.</SMALL><TR><TD><TD>
</SMALL>
<TR><TD><TD><P>

<P><TR><TD Valign="top"><IMG SRC="icons/dexercise.gif" ALT="??/\"><TD bgcolor="#FBB9AC"><A NAME="ex40"><B>EXERCISE 40:</B><BR>(link to <A HREF="answers1/answer40.html">the answer</A>)<TR><TD><TD>  Suppose the player is magically suspended in mid-air,
but that anything let go of will fall out of sight.  The natural way
to code this is to use a daemon which gets rid of anything it finds
on the floor (this is better than just trapping <TT>Drop</TT> actions because
objects might end up on the floor in many different ways).  Why is
using <TT>each_turn</TT> better?

<P>

<P><TR><TD Valign="top"><IMG SRC="icons/exercise.gif" ALT="??"><TD bgcolor="#FBB9AC"><A NAME="ex41"><B>EXERCISE 41:</B><BR>(link to <A HREF="answers1/answer41.html">the answer</A>)<TR><TD><TD> How would a game work if it involved a month-long
archaeological dig, where anything from days to minutes pass between
successive game turns?
<P>

<P><TR><TD Valign="top"><IMG SRC="icons/refs.gif" ALT="*"><TD bgcolor="#EEEEEE"><B>REFERENCES:</B><BR><SMALL> Daemons abound in most games.  'Advent' uses them to run
down the lamp batteries, make the bear follow you, animate the
dwarves and the pirate and watch for the treasure all being found.
See also the flying tortoise from 'Balances' and the chiggers
from 'Adventureland'.  For more ingenious uses of <TT>daemon</TT>,
see the helium balloon, the matchbook and (particularly cunning)
the pair of white gloves in 'Toyshop'.
<BR>
Classic timers include the burning match and the hand grenade
from 'Toyshop', the endgame timer from 'Advent' and the
'Balances' cyclops (also employing <TT>each_turn</TT>).
<BR>
'Adventureland' makes much use of <TT>each_turn</TT>: see the
golden fish, the mud, the dragon and the bees.
<BR>
The library extension 'timewait.h' by Andrew Clover
thoroughly implements time of day, allowing the player to "wait until
quarter past three''.
</TABLE>
<HR><A HREF="contents.html">Contents</A> / <A HREF="section17.html">Back</A> / <A HREF="section19.html">Forward</A> <BR>
<A HREF="chapter1.html">Chapter I</A> / <A HREF="chapter2.html">Chapter II</A> / <A HREF="chapter3.html">Chapter III</A> / <A HREF="chapter4.html">Chapter IV</A> / <A HREF="chapter5.html">Chapter V</A> / <A HREF="chapter6.html">Chapter VI</A> / <A HREF="chapterA.html">Appendix</A><HR><SMALL><I>Mechanically translated to HTML from third edition as revised 16 May 1997. Copyright &#169; Graham Nelson 1993, 1994, 1995, 1996, 1997: all rights reserved.</I></SMALL></BODY></HTML>
