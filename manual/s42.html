<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>DM4 &#167;42: Devices and opcodes</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" type="text/css" href="dm4.css">
</head>
<body>
<p class="navbar">
 <a href="index.html">home</a> /
 <a href="contents.html">contents</a> /
 <a href="ch7.html" title="Chapter VII: The Z-Machine">chapter VII</a> /
 <a href="s41.html" title="&#167;41: Architecture and assembly">prev</a> /
 <a href="s43.html" title="&#167;43: Pictures, sounds, blurbs and Blorb">next</a> /
 <a href="dm4index.html">index</a>
</p>
<div class="page">
<a id="p318" name="p318"></a>
<h2>&#167;42 &nbsp; Devices and opcodes</h2>

<p class="normal"><span class="atleft"><img src="dm4-318_1.jpg" alt=""></span>
This section covers the only opcodes which designers are likely to have 
occasional need of: those which drive powerful and otherwise inaccessible 
features of the Z-machine's &#8220;hardware&#8221;, such as sound,
graphics, menus and the mouse. There's no need to be fluent in assembly 
language to use these opcodes, which work just as well if used as
incantations from a unfamiliar tongue.</p>

<p class="normal" style="margin-top:1em;margin-top:1em"><span class="warning">&#9650;
<b>WARNING</b></span><br>
Some of these incantations may not work well if a story file is played 
on old interpreters which do not adhere to the Z-Machine Standard. 
Standard interpreters are very widely available, but if seriously worried 
you can test in an <code>Initialise</code> routine whether your game 
is running on a good interpreter, as in the following code.</p>

<p class="lynxonly"></p>
<pre class="code">
if (standard_interpreter == 0) {
    print &quot;This game must be played on an interpreter obeying the
           Z-Machine Standard.^&quot;;
    @quit;
}
</pre>

<p class="normal">The library variable <code>standard_interpreter</code> 
holds the version number of the standard obeyed, with the upper byte 
holding the major and the lower byte the minor version number, or 
else zero if the interpreter isn't standard-compliant. Thus <code>$002</code> 
means 0.2 and <code>$100</code> means 1.0. Any standard interpreter will 
carry out the opcodes in this chapter correctly, or else provide fair 
warning that they cannot. (For instance, an interpreter running on a 
palm-top personal organiser without a loudspeaker cannot provide sound 
effects.) Here is how to tell whether a standard interpreter can or 
can't provide the feature you need.</p>

<p class="lynxonly"></p>
<div class="clump"><table border="1" align="center">
<tr><td><i>Feature</i></td><td><i>Versions</i></td><td><i>Available</i> <code>if</code></td></tr>
<tr><td>auxiliary files</td><td>5,6,8</td><td><code>(true)</code></td></tr>
<tr><td>coloured text</td><td>5,6,8</td><td><code>((0-&gt;1) &amp; 1 ~= 0)</code></td></tr>
<tr><td>input streams</td><td>5,6,8</td><td><code>(true)</code></td></tr>
<tr><td>menus</td><td>6</td><td><code>(($10--&gt;0) &amp; 256 ~= 0)</code></td></tr>
<tr><td>mouse</td><td>5,6</td><td><code>(($10--&gt;0) &amp; 32 ~= 0)</code></td></tr>
<tr><td>output streams</td><td>5,6,8</td><td><code>(true)</code></td></tr>
<tr><td>pictures</td><td>6</td><td><code>(($10--&gt;0) &amp; 8 ~= 0)</code></td></tr>
<tr><td>sounds</td><td>5,6,8</td><td><code>(($10--&gt;0) &amp; 128 ~= 0)</code></td></tr>
<tr><td>throw/catch stack frames</td><td>5,6,8</td><td><code>(true)</code></td></tr>
<tr><td>timed keyboard interrupts</td><td>5,6,8</td><td><code>((0-&gt;1) &amp; 128 ~= 0)</code></td></tr>
</table></div>

<a id="p319" name="p319"></a>
<p class="normal">For instance, if coloured text is essential (for instance 
if red and black letters have to look different because it's a vital clue 
to some puzzle), you may want to add a test like the following to your 
<code>Initialise</code> routine:</p>

<p class="lynxonly"></p>
<pre class="code">
if ((0-&gt;1) &amp; 1 == 0)
    print &quot;*** This game is best appreciated on an interpreter
           capable of displaying colours, unlike the present
           one. Proceed at your own risk! ***^&quot;;
</pre>

<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
Text flows in and out of the Z-machine continuously: the player's commands 
flow in, responses flow out. Commands can come in from two different 
&#8220;input streams&#8221;, only one of which is selected at any given 
time: stream 0 is the keyboard and stream 1 is a file on the host computer. 
The stream is selected with:</p>

<p class="lynxonly"></p>
<pre>@input_stream number</pre>

<p class="aside">The Inform debugging verb &#8220;replay&#8221; basically 
does no more than switch input to stream 1.</p>

<p class="aside"><span class="warning">&#9650;</span>
There are four output streams for text, numbered 1 to 4. These are: 
(1) the screen, (2) the transcript file, (3) an array in memory and 
(4) a file of commands on the host computer. These can be active in 
any combination, except that at all times either stream 1 or stream 3 
is active and not both. Inform uses stream 3 when the message
<code>print_to_array</code> is sent to a string, and streams 2 and 4 
in response to commands typed by the player: &#8220;script on&#8221; 
switches stream 2 on, &#8220;script on&#8221; switches it off;
&#8220;recording on&#8221; and &#8220;off&#8221; switch stream 4 on and 
off. The relevant opcode is:</p>

<p class="lynxonly"></p>
<pre>@output_stream number arr</pre>

<p class="aside">If <code>number</code> is 0 this does nothing. 
<code>+</code><i>n</i> switches stream <i>n</i> on, 
<code>-</code><i>n</i> switches it off. The <code>arr</code> operand is 
omitted except for stream 3, when it's a table array holding the text
printed: that is, <code>arr--&gt;0</code> contains the number of characters 
printed and the text printed is stored as ZSCII characters in 
<code>arr-&gt;2</code>, <code>arr-&gt;3</code>, &#8230;</p>

<p class="aside"><span class="warning">&#9650;</span>
As the designer, you cannot choose the filename of the file of commands 
used by input stream 1 or output stream 4. Whoever is playing the story 
file will choose this: perhaps after being prompted by the interpreter, 
perhaps through a configuration setting on that interpreter.</p>

<a id="ex122" name="ex122"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;&#9650;
<b><a href="sa6.html#ans122">EXERCISE 122</a></b></span><br>
Implement an Inform version of the standard &#8216;C&#8217; routine 
<code>printf</code>, taking the form</p>

<p class="lynxonly"></p>
<pre class="code">printf(format, arg1, ...)</pre>

<a id="p320" name="p320"></a>
<p class="aside">to print out the format string but with escape sequences 
like <code>%d</code> replaced by the arguments (printed in various ways). 
For example,</p>

<p class="lynxonly"></p>
<pre class="code">printf(&quot;The score is %e out of %e.&quot;, score, MAX_SCORE);</pre>

<p class="aside">should print something like &#8220;The score is five out of ten.&#8221;</p>

<p class="aside"><span class="warning">&#9650;</span>
In Version 6 story files, only, <code>@output_stream</code> can take 
an optional third operand when output stream 3 is being enabled. That is:</p>

<p class="lynxonly"></p>
<pre>@output_stream 3 arr width</pre>

<p class="aside">If <code>width</code> is positive, the text streamed 
into the array will be word-wrapped as if it were on a screen width 
characters wide; if <code>width</code> is negative, then as if on 
a screen <code>-width</code> pixels wide. The text going into <code>arr</code> 
is in the form of a sequence of lines, each consisting of a word containing 
the number of characters and then the ZSCII characters themselves in 
bytes. The sequence of lines finishes with a zero word. Such an array 
is exactly what is printed out by the opcode <code>@print_form arr</code>.</p>

<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
The Z-machine has two kinds of &#8220;screen model&#8221;, or specification 
for what can and can't be done to the contents of the screen. Version 6 
has an advanced graphical model, whereas other versions have much simpler 
textual arrangements. Early versions of the Z-machine are generally less 
capable here, so this section will document only the Version 5 and Version 
6 models. (Versions 7 and 8 have the same model as Version 5.)</p>

<p class="aside"><i>The version 5 screen model.</i> The screen is divided 
into an upper window, normally used for a status line and sometimes also 
for quotations or menus, and a lower window, used for ordinary text. 
At any given time the upper window has a height <i>H</i>, which is a 
whole number of lines: and <i>H</i> can be zero, making the upper window 
invisible. (The story file can vary <i>H</i> from time to time and many 
do.) When text in the upper and lower windows occupy the same screen 
area, it's the upper window text that's visible. This often happens 
when quotation boxes are displayed.</p>

<p class="lynxonly"></p>
<pre>@split_window H</pre>

<p class="aside">Splits off an upper-level window of the given number 
of lines <i>H</i> in height from the main screen. Be warned that the 
upper window doesn't scroll, so you need to make <i>H</i> large enough 
for all the text you need to fit at once.</p>

<p class="lynxonly"></p>
<pre>@set_window window</pre>

<p class="aside">Selects which window text is to be printed into: 
(0) the lower one or (1) the upper one. Printing on the upper window 
overlies printing on the lower, is always done in a fixed-pitch font 
and does not appear in a printed transcript of the game.</p>

<p class="lynxonly"></p>
<pre>@set_cursor line column</pre>

<a id="p321" name="p321"></a>
<p class="aside">Places the cursor inside the upper window, where (1, 1) 
is the top left character.</p>

<p class="lynxonly"></p>
<pre>@buffer_mode flag</pre>

<p class="aside">This turns on <code>(flag==true)</code> or off 
<code>(flag==false)</code> word-breaking for the current window: that is, 
the practice of printing new-lines only at the ends of words, so that
text is neatly formatted.</p>

<p class="lynxonly"></p>
<pre>@erase_window window</pre>

<p class="aside">Blanks out window 0 (lower), window 1 (upper) or the 
whole screen (if <code>window=-1</code>).</p>

<p class="aside">Using fixed-pitch measurements, the screen has dimensions
<i>X</i> characters across by <i>Y</i> characters down, where 
<i>X</i> and <i>Y</i> are stored in bytes <code>$21</code> and <code>$20</code> 
of the header respectively. It's sometimes useful to know this when formatting 
tables:</p>

<p class="lynxonly"></p>
<pre class="code">print &quot;My screen has &quot;, 0-&gt;$20, &quot; rows and &quot;, 0-&gt;$21, &quot; columns.^&quot;;</pre>

<p class="aside">Be warned: it might be 80 &#215; 210 or then again it 
might be 7 &#215; 40. Text printing has a given foreground and background 
colour at all times. The standard stock of colours is:</p>

<p class="lynxonly"></p>
<div class="clump"><table border="1" align="center" style="text-align:center">
<tr><td>0</td><td><i>current colour</i></td><td>5</td><td>yellow</td></tr>
<tr><td>1</td><td><i>default colour</i></td><td>6</td><td>blue</td></tr>
<tr><td>2</td><td>black</td><td>7</td><td>magenta</td></tr>
<tr><td>3</td><td>red</td><td>8</td><td>cyan</td></tr>
<tr><td>4</td><td>green</td><td>9</td><td>white</td></tr>
</table></div>

<p class="lynxonly"></p>
<pre>@set_colour foreground background</pre>

<p class="aside">If coloured text is available, this opcode sets text 
to be <code>foreground</code> against <code>background</code>.
(But bear in mind that not all interpreters can display coloured text, 
and not all players enjoy reading it.) Even in a monochrome game, text 
can be set to print in &#8220;reverse colours&#8221;: background on 
foreground rather than vice versa. Status lines are almost always printed 
in reverse-colour, but this is only a convention and is not required 
by the Z-machine. Reverse is one of five possible text styles: roman, 
bold, underline (which many interpreters will render with italic), 
reverse and fixed-pitch. (Inform's <code>style</code> statement chooses 
between these.)</p>

<a id="ex123" name="ex123"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;
<b><a href="sa6.html#ans123">EXERCISE 123</a></b></span><br>
Design a title page for &#8216;Ruins&#8217;, displaying a more or 
less apposite quotation and waiting for a key to be pressed. (For 
this last part, see below.)</p>

<a id="ex124" name="ex124"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;
<b><a href="sa6.html#ans124">EXERCISE 124</a></b></span><br>
Change the status line so that it has the usual score/moves appearance 
except when a variable <code>invisible_status</code> is set to 
<code>true</code>, when it's invisible.</p>

<a id="p322" name="p322"></a>
<a id="ex125" name="ex125"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;
<b><a href="sa6.html#ans125">EXERCISE 125</a></b></span><br>
Alter the &#8216;Advent&#8217; example game to display the number of 
treasures found instead of the score and turns on the status line.</p>

<a id="ex126" name="ex126"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;
<b><a href="sa6.html#ans126">EXERCISE 126</a></b></span><br>
(From code by Joachim Baumann.) Put a compass rose on the status line, 
displaying the directions in which the room can be left.</p>

<a id="ex127" name="ex127"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;&#9650;
<b><a href="sa6.html#ans127">EXERCISE 127</a></b></span><br>
(Cf. &#8216;Trinity&#8217;.) Make the status line consist only of 
the name of the current location, centred in the top line of the screen.</p>

<p class="aside"><i>The version 6 screen model.</i> We are now in the 
realm of graphics, and the screen is considered to be a grid of pixels: 
coordinates are usually given in the form (<i>y</i>,<i>x</i>), with
(1,1) at the top left. <i>y</i> and <i>x</i> are measured in units 
known, helpfully enough, as &#8220;units&#8221;. The interpreter decides 
how large &#8220;1 unit&#8221; is, and it's not safe to assume that 
1 unit equals 1 pixel. All you can tell is what the screen dimensions 
are, in units:</p>

<p class="lynxonly"></p>
<pre class="code">
print &quot;The screen measures &quot;, $22--&gt;0, &quot; units across and &quot;,
      $22--&gt;1, &quot; units down.^&quot;;
</pre>

<p class="aside">There are eight windows, numbered 0 to 7, which text 
and pictures can currently be printing to: what actually appears on 
the screen is whatever shows through the boundaries of the window 
at the time the printing or plotting happens. Window number &#8722;3 
means &#8220;the current one&#8221;. Windows have no visible borders 
and usually lie on top of each other. Subsequent movements of the window 
do not move what was printed and there is no sense in which characters 
or graphics &#8220;belong&#8221; to any particular window once printed. 
Each window has a position (in units), a size (in units), a cursor 
position within it (in units, relative to its own origin), a number 
of flags called &#8220;attributes&#8221; and a number of variables 
called &#8220;properties&#8221;. If you move a window so that the cursor 
is left outside, the interpreter automatically moves the cursor back 
to the window's new top left. If you only move the cursor, it's your 
responsibility to make sure it doesn't leave the window.</p>

<p class="aside">The attributes are (0) &#8220;wrapping&#8221;, (1) 
&#8220;scrolling&#8221;, (2) &#8220;copy text to output stream 2 if 
active&#8221; and (3) &#8220;buffer printing&#8221;. Wrapping means 
that when text reaches the right-hand edge it continues from the left 
of the next line down. Scrolling means scrolling the window upwards 
when text printing reaches the bottom right corner, to make room for 
more. Output stream 2 is the transcript file, so the question here is
whether you want text in the given window to appear in a transcript: for 
instance, for a status line the answer is probably &#8220;no&#8221;, 
but for normal conversation it would be &#8220;yes&#8221;. Finally, buffering 
is a more sophisticated form of wrapping, which breaks lines of text in 
between words, but which (roughly speaking) means that no line is printed
until complete. Note that ordinary printing in the lower window has all 
four of these attributes.</p>

<p class="lynxonly"></p>
<pre>@window_style window attrs operation</pre>

<a id="p323" name="p323"></a>
<p class="aside">Changes window attributes. <code>attrs</code> is a 
bitmap in which bit 0 means &#8220;wrapping&#8221;, bit 1 means &#8220;scrolling&#8221;, 
etc. <code>operation</code> is 0 to set to these settings, 1 to set only 
those attributes which you specify in the bitmap, 2 to clear only those 
and 3 to reverse them. For instance,</p>

<p class="lynxonly"></p>
<pre>@window_style 2 $$1011 0</pre>

<p class="aside">sets window 2 to have wrapping, scrolling and buffering 
but not to be copied to output stream 2, and</p>

<p class="lynxonly"></p>
<pre>@window_style 1 $$1000 2</pre>

<p class="aside">clears the buffer printing attribute of window 1.</p>

<p class="aside">Windows have 16 properties, numbered as follows:</p>

<p class="lynxonly"></p>
<div class="clump"><table border="1" align="center" style="text-align:center">
<tr><td>0</td><td><i>y coordinate</i></td><td>8</td><td>newline interrupt routine</td></tr>
<tr><td>1</td><td><i>x coordinate</i></td><td>9</td><td>interrupt countdown</td></tr>
<tr><td>2</td><td><i>y size</i></td><td>10</td><td><i>text style</i></td></tr>
<tr><td>3</td><td><i>x size</i></td><td>11</td><td><i>colour data</i></td></tr>
<tr><td>4</td><td><i>y cursor</i></td><td>12</td><td><i>font number</i></td></tr>
<tr><td>5</td><td><i>x cursor</i></td><td>13</td><td><i>font size</i></td></tr>
<tr><td>6</td><td><i>left margin size</i></td><td>14</td><td><i>attributes</i></td></tr>
<tr><td>7</td><td><i>right margin size</i></td><td>15</td><td>line count</td></tr>
</table></div>

<p class="aside">The <i>x</i> and <i>y</i> values are all in units, 
but the margin sizes are in pixels. The font size data is 
<code>256*h+w</code>, where <code>h</code> is the height and <code>w</code> 
the width in pixels. The colour data is <code>256*b+f</code>, where 
<code>f</code> and <code>b</code> are foreground and background colour 
numbers. The text style is a bitmap set by the Inform <code>style</code> 
statement: bit 0 means Roman, 1 is reverse video, 2 is bold, 3 is italic, 
4 is fixed-pitch. The current value of any property can be read with:</p>

<p class="lynxonly"></p>
<pre>@get_wind_prop window prop -&gt; r</pre>

<p class="aside">Those few window properties which are not italicised 
in the table (and only those few) can be set using:</p>

<p class="lynxonly"></p>
<pre>@put_wind_prop window prop value</pre>

<p class="aside">Most window properties, the ones with italicised text 
in the table above, are set using specially-provided opcodes:</p>

<p class="lynxonly"></p>
<pre>@move_window window y x</pre>

<p class="aside">Moves to the given position on screen. Nothing visible 
happens, but all future plotting to the given window will happen in 
the new place.</p>

<p class="lynxonly"></p>
<pre>@window_size window y x</pre>

<p class="aside">Changes window size in pixels. Again, nothing visible happens.</p>

<p class="lynxonly"></p>
<pre>@set_colour foreground background window</pre>

<p class="aside">Sets the foreground and background colours for the given window.</p>

<p class="lynxonly"></p>
<a id="p324" name="p324"></a>
<pre>@set_cursor line column window</pre>

<p class="aside">Moves the window's cursor to this position, in units, 
relative to (1,1) in the top left of the window. If this would lie 
outside the margin positions, the cursor moves to the left margin 
of its current line. In addition, <code>@set_cursor -1</code> turns the 
cursor off, and <code>@set_cursor -2</code> turns it back on again.</p>

<p class="lynxonly"></p>
<pre>@get_cursor arr</pre>

<p class="aside">Writes the cursor row of the current window into 
<code>arr--&gt;0</code> and the column into <code>arr--&gt;1</code>,
in units.</p>

<p class="lynxonly"></p>
<pre>@set_font font -&gt; r</pre>

<p class="aside">(This opcode is available in Versions 5 and 8 as 
well as 6.) Selects the numbered font for the current window, and stores 
a positive number into <code>r</code> (actually, the previous font number) 
if available, or zero if not available. Font support is only minimal, 
for the sake of portability. The possible font numbers are: 1 (the normal 
font), 3 (a character graphics font: see &#167;16 of <i>The Z-Machine 
Standards Document</i>), 4 (a fixed-pitch Courier-like font). Owing 
to a historical accident there is no font 2.</p>

<p class="lynxonly"></p>
<pre>@set_margins left right window</pre>

<p class="aside">Sets margin widths, in pixels, for the given window. 
If the cursor is overtaken in the process and now lies outside these 
margins, it is moved back to the left margin of the current line.</p>

<p class="aside"><span class="warning">&#9650;</span>
&#8220;Interrupt countdowns&#8221; are a fancy system to allow text 
to flow gracefully around obstructions such as pictures. If property 
9 is set to a non-zero value, then it'll be decremented on each new-line, 
and when it hits zero the routine in property 8 will be called. This 
routine should not attempt to print any text, and is usually used to 
change margin settings.</p>

<a id="ex128" name="ex128"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans128">EXERCISE 128</a></b></span><br>
(Version 6 games only.) Set up wavy margins, which advance inwards for 
a while and then back outwards, over and over, so that the game's text 
ends up looking like a concertina.</p>

<p class="aside">Here are two useful tricks with windows:</p>

<p class="lynxonly"></p>
<pre>@erase_window window</pre>

<p class="aside">Erases the window's whole area to its background colour.</p>

<p class="lynxonly"></p>
<pre>@scroll_window window pixels</pre>

<p class="aside">Scrolls the given window by the given number of pixels. 
A negative value scrolls backwards, i.e., moving the body of the window 
down rather than up. Blank (background colour) pixels are plotted onto 
the new lines. This can be done to any window and is not related to the 
&#8220;scrolling&#8221; attribute of a window.</p>

<a id="p325" name="p325"></a>
<p class="aside"><span class="warning">&#9650;</span>
Finally, Version 6 story files (but no others) are normally able to display 
images, or &#8220;pictures&#8221;. To the Z-machine these are referred 
to only by number, and a story file does not &#8220;know&#8221; how pictures 
are provided to it, or in what format they are stored. For the mechanics of 
how to attach resources like pictures to a story file, see 
<a href="s43.html">&#167;43</a>. Fouropcodes are concerned with pictures:</p>

<p class="lynxonly"></p>
<pre>@draw_picture pn y x</pre>

<p class="aside">Draws picture number <code>pn</code> so that its 
top left corner appears at coordinates (<code>y</code>, <code>x</code>) 
in units on the screen. If <code>y</code> or <code>x</code> are omitted, 
the coordinate of the cursor in the current window is used.</p>

<p class="lynxonly"></p>
<pre>@erase_picture pn y x</pre>

<p class="aside">Exactly as <code>@draw_picture</code>, but erases 
the corresponding screen area to the current background colour.</p>

<p class="lynxonly"></p>
<pre>@picture_data pn arr ?Label</pre>

<p class="aside">Asks for information about picture number <code>pn</code>. 
If the given picture exists, a branch occurs to the given <code>Label</code>, 
and the height and width in pixels of the image are written to the given 
array <code>arr</code>, with <code>arr--&gt;0</code> being the height 
and <code>arr--&gt;1</code> the width. If the given picture doesn't 
exist, no branch occurs and nothing is written, <em>except</em> that 
if <code>pn</code> is zero, then <code>arr--&gt;0</code> is the number 
of pictures available to the story file and <code>arr--&gt;1</code>
the &#8220;release number&#8221; of the collection of pictures. (Or of 
the Blorb file attached to the story file, if that's how pictures have 
been provided to it.)</p>

<p class="lynxonly"></p>
<pre>@picture_table tarr</pre>

<p class="aside">Given a <code>table</code> array <code>tarr</code> of 
picture numbers, this warns the Z-machine that the story file will 
want to plot these pictures often, soon and in quick succession. Providing 
such a warning is optional and enables some interpreters to plot more 
quickly, because they can cache images in memory somewhere.</p>

<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
Sound effects are available to story files of any Version from 5 upwards. 
Once again, to the Z-machine these are referred to only by number, and 
a story file does not &#8220;know&#8221; how sounds are provided to 
it, or in what format they are stored. For the mechanics of how to attach 
resources like sound effects to a story file, see <a href="s43.html">&#167;43</a>. 
There is only one sound opcode, but it does a good deal. The simplest 
form is:</p>

<p class="lynxonly"></p>
<pre>@sound_effect number</pre>

<p class="aside">which emits a high-pitched bleep if <code>number</code> 
is 1 and a low-pitched bleep if 2. No other values are allowed.</p>

<p class="lynxonly"></p>
<a id="p326" name="p326"></a>
<pre>@sound_effect number effect volrep routine</pre>

<p class="aside">The given <code>effect</code> happens to the given sound 
<code>number</code>, which must be 3 or higher and correspond to a 
sound effect provided to the story file by the designer. Volume is measured 
from 1 (quiet) to 8 (loud), with the special value 255 meaning &#8220;loudest
possible&#8221;, and you can also specify between 0 and 254 repeats, 
or 255 to mean &#8220;repeat forever&#8221;. These two parameters are 
combined in <code>volrep</code>:</p>

<p class="lynxonly"></p>
<pre class="code">volrep = 256*repeats + volume;</pre>

<p class="aside">The <code>effect</code> can be: 1 (prepare), 2 (start), 
3 (stop), 4 (finish with). You may want to &#8220;warn&#8221; the 
Z-machine that a sound effect will soon be needed by using the 
&#8220;prepare&#8221; effect, but this is optional: similarly you may 
want to warn it that you've finished with the sound effect for the 
time being, but this too is optional. &#8220;Start&#8221; and &#8220;stop&#8221; 
are self-explanatory except to say that sound effects can be playing in 
the background while the player gets on with play: i.e., the Z-machine 
doesn't simply halt until the sound is complete. The &#8220;stop&#8221; 
effect makes the sound cease at once, even if there is more still
to be played. Otherwise, unless set to repeat indefinitely, it will 
end by itself in due course. If a <code>routine</code> has been provided 
(this operand is optional, and takes effect only on <code>effect</code> 
2), this routine will then be called as an interrupt. Such routines generally 
do something like play the sound again but at a different volume level, 
giving a fading-away effect.</p>

<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
In addition to reading entire lines of text from the keyboard, which 
games normally do once per turn, you can read a single press of a key. 
Moreover, on most interpreters you can set either kind of keyboard-reading 
to wait for at most a certain time before giving up.</p>

<p class="lynxonly"></p>
<pre>@aread text parse time function -&gt; result</pre>

<p class="aside">This opcode reads a line of text from the keyboard, writing 
it into the <code>text</code> string array and &#8216;tokenising&#8217; 
it into a word stream, with details stored in the <code>parse</code> 
string array (unless this is zero, in which case no tokenisation happens). 
(See <a href="s2.html#s2_5">&#167;2.5</a> for the format of <code>text</code> 
and <code>parse</code>.) While it is doing this it calls <code>function()</code> 
every <code>time</code> tenths of a second: the process ends if ever this 
function returns true. The value written into result is the &#8220;terminating 
character&#8221; which finished the input, or else 0 if a time-out ended 
the input.</p>

<p class="lynxonly"></p>
<pre>@read_char 1 time function -&gt; result</pre>

<p class="aside">Results in the ZSCII value of a single keypress. Once 
again, <code>function(time)</code> is called every <code>time</code> 
tenths of a second and may stop this process early. (The first operand 
is always 1, meaning &#8220;from the keyboard&#8221;.)</p>

<p class="lynxonly"></p>
<a id="p327" name="p327"></a>
<pre>@tokenise text parse dictionary</pre>

<p class="aside">This takes the text in the <code>text</code> buffer 
(in the format produced by <code>@aread</code>) and tokenises it, 
i.e., breaks it up into words and finds their addresses in the given 
dictionary. The result is written into the <code>parse</code> buffer 
in the usual way.</p>

<p class="lynxonly"></p>
<pre>@encode_text zscii-text length from coded-text</pre>

<p class="aside">Translates a ZSCII word to the internal, Z-encoded, 
text format suitable for use in a <code>@tokenise</code> dictionary. 
The text begins at from in the <code>zscii-text</code> and is 
<code>length</code> characters long, which should contain the right 
length value (though in fact the interpreter translates the word 
as far as a zero terminator). The result is 6 bytes long and usually 
represents between 1 and 9 letters.</p>

<p class="aside">It's also possible to specify which ZSCII character 
codes are &#8220;terminating characters&#8221;, meaning that they 
terminate a line of input. Normally, the return key is the only
terminating character, but others can be added, and this is how games 
like &#8216;Beyond Zork&#8217; make function keys act as shorthand 
commands. For instance, the following directive makes ZSCII 132 (cursor 
right) and 136 (function key f4) terminating:</p>

<p class="lynxonly"></p>
<pre class="code">Zcharacter terminating 132 136;</pre>

<p class="aside">The legal values to include are those for the cursor, 
function and keypad keys, plus mouse and menu clicks (see 
<a href="tables.html#tbl2a">Table 2</a> for values). The special value 
255 makes all of these characters terminating. (For other uses of 
<code>Zcharacter</code>, see <a href="s36.html">&#167;36</a>.)</p>

<a id="ex129" name="ex129"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans129">EXERCISE 129</a></b></span><br>
Write a &#8220;press any key to continue&#8221; routine.</p>

<a id="ex130" name="ex130"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans130">EXERCISE 130</a></b></span><br>
And another routine which determines if any key is being held down, 
returning either its ZSCII code or zero to indicate that no key is 
being held down.</p>

<a id="ex131" name="ex131"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans131">EXERCISE 131</a></b></span><br>
Write a game in which a player taking more than ten seconds to consider 
a command is hurried along.</p>

<a id="ex132" name="ex132"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans132">EXERCISE 132</a></b></span><br>
And if thirty seconds are taken, make the player's mind up for her.</p>

<a id="ex133" name="ex133"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans133">EXERCISE 133</a></b></span><br>
Design an hourglass fixed to a pivot on one room's wall, which (when 
turned upright) runs sand through in real time, turning itself over 
automatically every forty seconds.</p>

<p class="dotbreak">· · · · ·</p>

<a id="p328" name="p328"></a>
<p class="aside"><span class="warning">&#9650;</span>
Besides the keyboard, Version 6 normally supports the use of a mouse. 
In theory this can have any number of buttons, but since some widely-used 
computers have single-button mice (e.g., the Apple Macintosh) it's safest 
not to rely on more than one.</p>

<p class="aside">The mouse must be attached to one of the eight windows 
for it to register properly. (Initially, it isn't attached to any window 
and so is entirely inert.) To attach it to the window numbered <code>wnum</code>, 
use the opcode:</p>

<p class="lynxonly"></p>
<pre>@mouse_window wnum</pre>

<p class="aside">Once attached, a click within the window will register 
as if it were a key-press to <code>@read_char</code> with ZSCII value 
254, unless it is a second click in quick succession to a previous click 
in the same position, in which case it has ZSCII value 253. Thus, a
double-clicking registers twice, once as click (254) and then as double-click 
(253).</p>

<p class="aside">At any time, the mouse position, measured in units, 
and the state of its buttons, i.e., pressed or not pressed, can be read 
off with the opcode:</p>

<p class="lynxonly"></p>
<pre>@read_mouse mouse_array</pre>

<p class="aside">places (<i>x</i>, <i>y</i>) coordinates of the click 
in <code>mouse_array--&gt;0</code> and <code>mouse_array--&gt;1</code> 
and the state of the buttons as a bitmap in <code>mouse_array--&gt;2</code>, 
with bit 0 representing the rightmost button, bit 1 the next and so 
on. In practice, it's safest simply to test whether this value is zero 
(no click) or not (click). The array <code>mouse_array</code> should 
have room for 4 entries, however: the fourth relates to menus (see below).</p>

<a id="ex134" name="ex134"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans134">EXERCISE 134</a></b></span><br>
Write a test program to wait for mouse clicks and then print out the 
state of the mouse.</p>

<p class="aside"><span class="warning">&#9650;</span>
The mouse also allows access to menus, on some interpreters, though 
in Version 6 only. The model here is of a Mac OS-style desktop, with 
one or more menus added to the menu bar at the top of the screen: games 
are free to add or remove menus at any time. They are added with:</p>

<p class="lynxonly"></p>
<pre>@make_menu number mtable ?IfAbleTo;</pre>

<p class="aside">Such menus are numbered from 3 upwards. <code>mtable</code> is 
a <code>table</code> array of menu entries, each of which must be itself 
a <code>string</code> array giving the text of that option. <code>IfAbleTo</code> 
is a label, to which the interpreter will jump if the menu is successfully 
created. If <code>mtable</code> is zero, the opcode instead removes 
an already-existing menu. During play, the selection of a menu item 
by the player is signalled to the Z-machine as a key-press with ZSCII
value 252, and the game receiving this can then look up which item on 
which menu was selected by looking at entry <code>--&gt;3</code> 
in an array given to <code>read_mouse</code>. The value in this entry 
will be the menu number times 256, plus the item number, where items 
are numbered from 0. If the game has 252 listed as a &#8220;terminating 
character&#8221; (see above), then menu selection can take the place 
of typing a command.</p>

<a id="ex135" name="ex135"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans135">EXERCISE 135</a></b></span><br>
Provide a game with a menu of common commands like &#8220;inventory&#8221; 
and &#8220;look&#8221; to save on typing.</p>

<a id="p329" name="p329"></a>
<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
The Z-machine can also load and save &#8220;auxiliary files&#8221; to 
or from the host machine. These should have names adhering to the 
&#8220;8 + 3&#8221; convention, that is, one to eight alphanumeric characters 
optionally followed by a full stop and one to three further alphanumeric 
characters. Where no such extension is given, it is assumed to be 
<tt>.AUX</tt>. Designers are asked to avoid using the extensions 
<tt>.INF</tt>, <tt>.H</tt>, <tt>.SAV</tt> or <tt>.Z5</tt> or similar,
to prevent confusion. Note that auxiliary files from different games 
may be sharing a common directory on the host machine, so that a 
filename should be as distinctive as possible. The two opcodes are:</p>

<p class="lynxonly"></p>
<pre>@save buffer length filename -&gt; R</pre>

<p class="aside">Saves the byte array <code>buffer</code> (of size 
length) to a file, whose (default) name is given in the <code>filename</code> (a 
<code>string</code> array). Afterwards, <code>R</code> holds <code>true</code> 
on success, <code>false</code> on failure.</p>

<p class="lynxonly"></p>
<pre>@restore buffer length filename -&gt; R</pre>

<p class="aside">Loads in the byte array <code>buffer</code> (of size 
<code>length</code>) from a file, whose (default) name is given in the 
<code>filename</code> (a <code>string</code> array). Afterwards, 
<code>R</code> holds the number of bytes successfully read.</p>

<a id="ex136" name="ex136"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans136">EXERCISE 136</a></b></span><br>
How might this assist a &#8220;role-playing game campaign&#8221; with 
several scenarios, each implemented as a separate Inform game but sharing 
a player-character who takes objects and experience from one scenario 
to the next?</p>

<a id="ex137" name="ex137"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>
<b><a href="sa6.html#ans137">EXERCISE 137</a></b></span><br>
Design catacombs in which the ghosts of former, dead players from 
previous games linger.</p>

<p class="dotbreak">· · · · ·</p>

<p class="aside"><span class="warning">&#9650;</span>
Finally, the Z-machine supports a very simple form of exception-handling 
like that of the C language's long jump feature. This is very occasionally 
useful to get the program out of large recursive tangles in a hurry.</p>

<p class="lynxonly"></p>
<pre>@catch -&gt; result</pre>

<p class="aside">The opposite of <code>@throw</code>, <code>@catch</code> 
preserves the &#8220;stack frame&#8221; of the current routine in the 
variable <code>result</code>: roughly speaking, the stack frame is 
the current position of which routine is being run and which ones 
have called it so far.</p>

<p class="lynxonly"></p>
<pre>@throw value stack-frame</pre>

<p class="aside">This causes the program to execute a return with 
<code>value</code>, but as if it were returning from the routine which 
was running when the <code>stack-frame</code> was &#8220;caught&#8221;, that 
is, set up by a corresponding <code>@catch</code> opcode. Note that 
you can only <code>@throw</code> back to a routine which is still 
running, i.e., to which control will eventually return anyway.</p>

<a id="p330" name="p330"></a>
<a id="ex138" name="ex138"></a>
<p class="aside"><span class="warning"><b>&#8226;</b>&#9650;&#9650;
<b><a href="sa6.html#ans138">EXERCISE 138</a></b></span><br>
Use <code>@throw</code> and <code>@catch</code> to make an exception 
handler for actions, so that any action subroutine getting into recursive 
trouble can throw an exception and escape.</p>

<p class="aside"><span class="warning"><b>&#8226;</b>
<b>REFERENCES</b></span><br>
The assembly-language connoisseur will appreciate &#8216;Freefall&#8217; 
by Andrew Plotkin and &#8216;Robots&#8217; by Torbj&ouml;rn Andersson, 
although the present lack of on-line hints make these difficult games 
to win. &nbsp;
<span class="warning"><b>&#8226;</b></span>Gevan Dutton has made an amazing 
port of the classic character-graphic maze adventure &#8216;Rogue&#8217; 
to Inform, taking place entirely in the upper window. &nbsp;
<span class="warning"><b>&#8226;</b></span>Similarly, &#8216;Zugzwang&#8217; 
by Magnus Olsson plots up a chess position. &nbsp;
<span class="warning"><b>&#8226;</b></span>The function library 
<tt>&quot;text_functions.h&quot;</tt>, by Patrick Kellum, offers text
styling and colouring. These routines are entirely written in assembler. 
Similar facilities are available from Chris Klimas's <tt>&quot;style.h&quot;</tt> 
and L. Ross Raszewski's <tt>&quot;utility.h&quot;</tt>.
<span class="warning"><b>&#8226;</b></span>Jason Penney's <tt>&quot;V6Lib.h&quot;</tt> 
is a coherent extension to the Inform library for Version 6 games 
(only), offering support for multiple text windows, images and sounds 
by means of class definitions and high-level Inform code. &nbsp;
<span class="warning"><b>&#8226;</b></span>More modestly, but applicably to
Version 5 and 8 games, L. Ross Raszewski's <tt>&quot;sound.h&quot;</tt> 
function library handles sound effects.</p>

</div>
<p class="navbar">
 <a href="index.html">home</a> /
 <a href="contents.html">contents</a> /
 <a href="ch7.html" title="Chapter VII: The Z-Machine">chapter VII</a> /
 <a href="s41.html" title="&#167;41: Architecture and assembly">prev</a> /
 <a href="s43.html" title="&#167;43: Pictures, sounds, blurbs and Blorb">next</a> /
 <a href="dm4index.html">index</a>
</p>
</body>
</html>

